<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>وسيلة — نموذج أولي لحسابات التطبيق</title>
<meta name="theme-color" content="#00C2C2"/>
<link rel="manifest" href="manifest.webmanifest">
<style>
:root{--bg:#f6fbfc;--card:#fff;--muted:#667085;--text:#0f172a;--brand:#00C2C2;--brand-2:#8CF1EB;--radius:16px;--shadow:0 8px 30px rgba(2,132,199,.08);--navH:64px}
*{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
body{margin:0;background:linear-gradient(180deg,#fbffff,#f6fbfc);color:var(--text)}
header{height:var(--navH);display:flex;align-items:center;justify-content:space-between;padding:0 16px;position:sticky;top:0;z-index:40}
.brand{display:flex;align-items:center;gap:12px}
.brand svg{width:44px;height:44px}
h1{font-size:18px;margin:0}
main{padding:16px 12px 96px}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:14px}
.grid{display:grid;gap:12px}
.tabs{position:fixed;left:0;right:0;bottom:0;height:72px;display:flex;background:linear-gradient(180deg,rgba(255,255,255,.9),#fff);box-shadow:0 -4px 18px rgba(2,132,199,.06);z-index:50;border-top-left-radius:12px;border-top-right-radius:12px;padding:8px 12px;gap:8px}
.tab{flex:1;border-radius:10px;display:flex;align-items:center;justify-content:center;gap:8px;font-size:13px;color:var(--muted);cursor:pointer}
.tab.active{background:linear-gradient(90deg,var(--brand),var(--brand-2));color:#fff;font-weight:600}
#map{height:320px;border-radius:12px;overflow:hidden;box-shadow:0 6px 20px rgba(2,132,199,.08)}
.row{display:flex;gap:10px;align-items:center}
label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
input[type=text],select,input[type=number]{width:100%;padding:10px;border-radius:10px;border:1px solid #e6eef0;background:#fbffff}
button{padding:10px 12px;border-radius:10px;border:0;background:var(--brand);color:#fff;font-weight:600;cursor:pointer}
.btn-light{background:#e6f8f7;color:var(--brand);border:1px solid rgba(0,194,194,.14)}
.muted{color:var(--muted);font-size:13px}
.service-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.service-card{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;border:1px solid #eef7f7;background:linear-gradient(180deg,#fff,#fbffff)}
.switch{display:inline-flex;align-items:center;gap:8px}
.small{font-size:12px}
#toast{position:fixed;left:50%;transform:translateX(-50%);bottom:86px;background:#111;color:#fff;padding:8px 14px;border-radius:8px;opacity:0;transition:opacity .2s}
#toast.show{opacity:1}
@media(min-width:900px){main{max-width:980px;margin:18px auto}.tabs{display:none}}
pre{white-space:pre-wrap;font-size:13px;background:#071827;color:#cfeef0;padding:10px;border-radius:8px;overflow:auto}
.chip{padding:6px 10px;border-radius:999px;background:#f4fdfc;border:1px solid #dcf3f2;cursor:pointer}
.chipbar{display:flex;flex-wrap:wrap;gap:8px}
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
</head>
<body>
<header>
  <div class="brand">
    <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden>
      <defs><linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="#00C2C2"/><stop offset="1" stop-color="#8CF1EB"/></linearGradient></defs>
      <rect rx="10" width="64" height="64" fill="url(#g1)" />
      <g transform="translate(6,14)" fill="#fff">
        <rect x="0" y="10" width="36" height="14" rx="2"/>
        <rect x="26" y="0" width="10" height="16" rx="2"/>
        <circle cx="10" cy="28" r="4" />
        <circle cx="26" cy="28" r="4" />
      </g>
    </svg>
    <div>
      <h1>وسيلة — نموذج أولي لحسابات التطبيق</h1>
      <div class="muted small">نسخة تجريبية — معدّة للسوق السعودي</div>
    </div>
  </div>
  <div style="display:flex;gap:8px;align-items:center">
    <button onclick="openView('admin')">لوحة الإدارة</button>
    <button onclick="openView('landing')" class="btn-light">الرئيسية</button>
  </div>
</header>

<main id="app">
  <section id="landing" class="card view">
    <h2>أهلاً بك في وسيلة</h2>
    <p class="muted">اختر الحساب أو ابدأ طلبًا جديدًا من حساب العميل.</p>
    <div class="grid" style="grid-template-columns:repeat(2,1fr);margin-top:12px">
      <div class="card"><strong>حساب العميل</strong><div class="muted small">طلب نقل/تحميل بسهولة</div><div style="margin-top:10px"><button onclick="openView('shipper')">ادخل كعميل</button></div></div>
      <div class="card"><strong>حساب السائق</strong><div class="muted small">شاهد الطلبات القريبة واقبلها</div><div style="margin-top:10px"><button onclick="openView('driver')">ادخل كسائق</button></div></div>
      <div class="card"><strong>حساب المالك</strong><div class="muted small">إدارة الونيتات والسائقين</div><div style="margin-top:10px"><button onclick="openView('owner')">ادخل كمالك</button></div></div>
      <div class="card"><strong>لوحة الإدارة</strong><div class="muted small">الخدمات، التسعير، الاختبارات</div><div style="margin-top:10px"><button onclick="openView('admin')">لوحة الإدارة</button></div></div>
    </div>
  </section>

  <section id="shipper" class="card view" style="display:none">
    <h2>طلب جديد — عميل</h2>
    <div class="chipbar" style="margin-bottom:10px">
      <span class="chip" onclick="jumpTo('riyadh')">الرياض</span>
      <span class="chip" onclick="jumpTo('jeddah')">جدة</span>
      <span class="chip" onclick="jumpTo('hail')">حائل</span>
      <span class="chip" onclick="jumpTo('dammam')">الدمام</span>
    </div>
    <div class="row" style="gap:12px">
      <div style="flex:1">
        <label>نقطة الاستلام</label>
        <input id="pickup" type="text" placeholder="اختر من الخريطة أو استخدم موقعي">
        <div class="row" style="margin-top:6px;gap:8px">
          <button onclick="useMyLocation()">استخدم موقعي</button>
          <button onclick="copyCoords('pickup')" class="btn-light">نسخ الإحداثيات</button>
        </div>
        <div id="pickupHint" class="muted small" style="margin-top:6px"></div>
      </div>
      <div style="flex:1">
        <label>نقطة التسليم</label>
        <input id="dropoff" type="text" placeholder="اختر من الخريطة أو أدخل يدويًا">
        <div class="row" style="margin-top:6px;gap:8px">
          <button onclick="useMyLocationDrop()">موقعي للتسليم</button>
          <button onclick="copyCoords('dropoff')" class="btn-light">نسخ الإحداثيات</button>
        </div>
        <div id="dropoffHint" class="muted small" style="margin-top:6px"></div>
      </div>
    </div>
    <div style="margin-top:12px" class="grid">
      <div class="card"><label>نوع الخدمة</label><select id="serviceType"></select></div>
      <div class="card"><label>نوع الحمولة</label><select id="cargoType"><option value="boxes">صناديق</option><option value="furniture">أثاث</option><option value="appliances">أجهزة</option><option value="building">مواد بناء</option></select></div>
      <div class="card"><label>الوزن التقريبي (كجم)</label><input id="weight" type="number" min="1" value="20"></div>
    </div>
    <div style="margin-top:12px" class="row">
      <button onclick="estimate()">حساب السعر التقريبي</button>
      <div id="estimateOut" class="muted small" style="margin-right:12px"></div>
      <div style="margin-left:auto"><button onclick="submitOrder()" style="background:#10b981">إرسال الطلب</button></div>
    </div>
    <div style="margin-top:14px"><div id="map" class="card"></div></div>
    <div style="margin-top:12px"><h3 class="small muted">سجل الطلبات (محلي)</h3><div id="ordersList"></div></div>
  </section>

  <section id="driver" class="card view" style="display:none">
    <h2>حساب السائق</h2><p class="muted small">قائمة الطلبات القريبة — اضغط لقبول</p><div id="driverOrders"></div>
  </section>

  <section id="owner" class="card view" style="display:none">
    <h2>حساب المالك</h2>
    <p class="muted small">الملاك/المركبات</p>
    <div class="row" style="gap:8px;margin-bottom:8px">
      <input id="ownerName" type="text" placeholder="اسم المالك">
      <input id="ownerVehicles" type="number" min="0" value="1" style="max-width:120px">
      <button onclick="addOwner()">إضافة</button>
    </div>
    <div id="ownersList"></div>
  </section>

  <section id="admin" class="card view" style="display:none">
    <h2>لوحة الإدارة</h2>
    <div class="row" style="gap:12px">
      <div style="flex:1"><label>بحث خدمات</label><input id="serviceSearch" type="text" placeholder="بحث..."></div>
      <div style="width:220px"><label>تصنيف</label><select id="serviceFilter"><option value="">الكل</option><option value="home">منزلي</option><option value="equipment">معدات</option><option value="log">لوجستي</option></select></div>
    </div>
    <div style="margin-top:12px" class="service-grid card" id="servicesGrid"></div>
    <div style="margin-top:12px" class="card">
      <h3>تسعير (قابل للتعديل)</h3>
      <div class="row" style="gap:12px">
        <div style="flex:1"><label>ريال/كم</label><input id="kmRate" type="number" value="2.2" step="0.1"></div>
        <div style="flex:1"><label>الوزن المجاني (كجم)</label><input id="freeKg" type="number" value="50"></div>
        <div style="flex:1"><label>سعر/كجم إضافي</label><input id="perKg" type="number" value="0.6" step="0.1"></div>
      </div>
      <div style="margin-top:10px"><button onclick="savePricing()">حفظ التسعير</button><button onclick="runTests()" style="margin-left:8px;background:#f59e0b">تشغيل الاختبارات</button></div>
      <div style="margin-top:10px"><pre id="testOutput">نتائج الاختبارات تظهر هنا...</pre></div>
    </div>
  </section>
</main>

<div id="toast"></div>
<div class="tabs">
  <div class="tab active" data-target="landing" onclick="activateTab(event)">الرئيسية</div>
  <div class="tab" data-target="shipper" onclick="activateTab(event)">عميل</div>
  <div class="tab" data-target="driver" onclick="activateTab(event)">سائق</div>
  <div class="tab" data-target="owner" onclick="activateTab(event)">مالك</div>
  <div class="tab" data-target="admin" onclick="activateTab(event)">إدارة</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
if('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }); }
const CITY={riyadh:[24.7136,46.6753],jeddah:[21.4858,39.1925],hail:[27.5219,41.6907],dammam:[26.4207,50.0888]};
function jumpTo(key){ if(map){ map.setView(CITY[key]||CITY.riyadh,12);} }
window.S=JSON.parse(localStorage.getItem('WASILA_S'))||{services:[
{id:'home_move',title:'نقل أثاث منزلي',cat:'home',enabled:true},
{id:'appliances',title:'نقل أجهزة كهربائية',cat:'home',enabled:true},
{id:'flatbed',title:'سطحة معدات',cat:'equipment',enabled:true},
{id:'building',title:'مواد بناء وحفر',cat:'equipment',enabled:true},
{id:'city_express',title:'داخل المدينة — سريع',cat:'log',enabled:true},
{id:'intercity',title:'بين المدن',cat:'log',enabled:true}
],pricing:{kmRate:2.2,freeKg:50,perKg:0.6,multipliers:{boxes:1,furniture:1.8,appliances:1.4,building:2}},orders:[],drivers:[],owners:[],mapView:null,pollingInterval:8};
function persist(){ localStorage.setItem('WASILA_S', JSON.stringify(S)); }
function openView(id){ document.querySelectorAll('.view').forEach(v=>v.style.display='none'); const el=document.getElementById(id); if(!el)return; el.style.display='block'; if(id==='shipper'){ setTimeout(()=>{ if(window.map) map.invalidateSize(); fitToMarkersOrRoute(); },100);} if(id==='admin'){ renderServices(); } renderOrders(); renderDriverOrders(); renderOwners(); document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.target===id)); }
document.addEventListener('DOMContentLoaded',()=>{ populateServiceSelect(); document.getElementById('kmRate').value=S.pricing.kmRate; document.getElementById('freeKg').value=S.pricing.freeKg; document.getElementById('perKg').value=S.pricing.perKg; initMap(); openView('landing'); });
function activateTab(e){ openView(e.currentTarget.dataset.target); }
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2200); }
function populateServiceSelect(){ const sel=document.getElementById('serviceType'); sel.innerHTML=''; S.services.filter(s=>s.enabled).forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.title; sel.appendChild(o); }); }
function renderServices(){ const grid=document.getElementById('servicesGrid'); grid.innerHTML=''; const q=(document.getElementById('serviceSearch').value||'').toLowerCase(); const f=document.getElementById('serviceFilter').value; S.services.filter(s=>{ if(q && !s.title.toLowerCase().includes(q)) return false; if(f && s.cat!==f) return false; return true; }).forEach(s=>{ const d=document.createElement('div'); d.className='service-card'; d.innerHTML=`<div style="display:flex;gap:10px;align-items:center"><div style="width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg,var(--brand),var(--brand-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:700">${s.title.charAt(0)}</div><div><div style="font-weight:600">${s.title}</div><div class="muted small">${s.cat||'عام'}</div></div></div><div class="switch"><label class="small">${s.enabled?'مفعل ✅':'معطل'}</label><input type="checkbox" ${s.enabled?'checked':''} onchange="toggleService('${s.id}',this.checked)"/></div>`; grid.appendChild(d); }); }
function toggleService(id,val){ const s=S.services.find(x=>x.id===id); if(s){ s.enabled=!!val; persist(); renderServices(); populateServiceSelect(); toast('تم تحديث حالة الخدمة'); } }
document.addEventListener('input',(e)=>{ if(e.target && e.target.id==='serviceSearch') renderServices(); }); document.addEventListener('change',(e)=>{ if(e.target && e.target.id==='serviceFilter') renderServices(); });
function savePricing(){ S.pricing.kmRate=parseFloat(document.getElementById('kmRate').value)||S.pricing.kmRate; S.pricing.freeKg=parseFloat(document.getElementById('freeKg').value)||S.pricing.freeKg; S.pricing.perKg=parseFloat(document.getElementById('perKg').value)||S.pricing.perKg; persist(); toast('تم حفظ التسعير'); }
function generateId(prefix){ return prefix + '_' + Date.now().toString(36).slice(-6); }
function submitOrder(){ const pickup=window.mapState?.pickup, dropoff=window.mapState?.dropoff; if(!pickup||!dropoff){ alert('الرجاء تحديد الاستلام والتسليم من الخريطة'); return; } const order={id:generateId('o'),service:document.getElementById('serviceType').value,cargoType:document.getElementById('cargoType').value,weight:parseFloat(document.getElementById('weight').value)||0,pickup,dropoff,status:'pending',created:Date.now()}; S.orders.unshift(order); persist(); renderOrders(); toast('تم إنشاء الطلب'); }
function renderOrders(){ const out=document.getElementById('ordersList'); if(!out)return; out.innerHTML=''; S.orders.forEach(o=>{ const el=document.createElement('div'); el.className='card'; el.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${getServiceTitle(o.service)}</strong><div class="muted small">#${o.id} — ${statusLabel(o.status)}</div></div><div style="text-align:right"><div class="muted small">من: ${short(o.pickup)}</div><div class="muted small">إلى: ${short(o.dropoff)}</div></div></div><div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">${o.status==='pending'?`<button onclick="assignDriver('${o.id}')">أسند لسائق تجريبي</button>`:''}${o.status==='in_progress'?`<button onclick="completeOrder('${o.id}')" style="background:#10b981">اكتمال</button><button onclick="cancelOrder('${o.id}')" style="background:#ef4444">إلغاء</button>`:''}</div>`; out.appendChild(el); }); }
function statusLabel(s){ return s==='pending'?'بانتظار القبول':(s==='in_progress'?'جار التنفيذ':(s==='done'?'مكتمل':'ملغي')); }
function getServiceTitle(id){ const it=S.services.find(x=>x.id===id); return it?it.title:id; }
function renderDriverOrders(){ const out=document.getElementById('driverOrders'); if(!out)return; out.innerHTML=''; S.orders.filter(o=>o.status==='pending').forEach(o=>{ const el=document.createElement('div'); el.className='card'; el.innerHTML=`<div style="display:flex;justify-content:space-between"><div><strong>${getServiceTitle(o.service)}</strong><div class="muted small">#${o.id}</div></div><div style="text-align:right"><div class="muted small">من: ${short(o.pickup)}</div><div class="muted small">إلى: ${short(o.dropoff)}</div></div></div><div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end"><button onclick="acceptOrder('${o.id}')">قبول</button></div>`; out.appendChild(el); }); }
function assignDriver(id){ const o=S.orders.find(x=>x.id===id); if(!o)return; o.status='in_progress'; persist(); renderOrders(); renderDriverOrders(); toast('تم اسناد الطلب (تجريبي)'); }
function acceptOrder(id){ const o=S.orders.find(x=>x.id===id); if(!o)return; o.status='in_progress'; persist(); renderOrders(); renderDriverOrders(); toast('تم قبول الطلب'); }
function completeOrder(id){ const o=S.orders.find(x=>x.id===id); if(o){ o.status='done'; persist(); renderOrders(); toast('اكتمل الطلب'); } }
function cancelOrder(id){ const o=S.orders.find(x=>x.id===id); if(o){ o.status='cancelled'; persist(); renderOrders(); toast('تم إلغاء الطلب'); } }
function addOwner(){ const name=(document.getElementById('ownerName').value||'').trim(); const vehicles=parseInt(document.getElementById('ownerVehicles').value||'0',10)||0; if(!name){ alert('أدخل اسم المالك'); return; } S.owners.push({name,vehicles}); persist(); document.getElementById('ownerName').value=''; renderOwners(); }
function renderOwners(){ const out=document.getElementById('ownersList'); if(!out)return; out.innerHTML=''; if(S.owners.length===0){ out.innerHTML='<div class="muted small">لا يوجد ملاك بعد</div>'; return; } S.owners.forEach(o=>{ const d=document.createElement('div'); d.className='card'; d.innerHTML=`<strong>${o.name}</strong><div class="muted small">${o.vehicles||0} مركبات</div>`; out.appendChild(d); }); }
let map,pickupMarker,dropoffMarker,routeLine; window.mapState={pickup:null,dropoff:null};
function initMap(){ map=L.map('map',{zoomControl:false}).setView(CITY.riyadh,11); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map); map.on('click',(e)=>{ if(!window.mapState.pickup){ setPickup(e.latlng.lat,e.latlng.lng); reverseGeocode(e.latlng.lat,e.latlng.lng,'pickup','pickupHint'); } else if(!window.mapState.dropoff){ setDropoff(e.latlng.lat,e.latlng.lng); reverseGeocode(e.latlng.lat,e.latlng.lng,'dropoff','dropoffHint'); } else { setPickup(e.latlng.lat,e.latlng.lng); reverseGeocode(e.latlng.lat,e.latlng.lng,'pickup','pickupHint'); setDropoff(null,null);} drawRouteIfReady(); }); const stored=JSON.parse(localStorage.getItem('WASILA_mapView')||'null'); if(stored?.center){ map.setView(stored.center, stored.zoom||11);} map.on('moveend',()=>{ localStorage.setItem('WASILA_mapView', JSON.stringify({center:map.getCenter(), zoom:map.getZoom()}));}); L.control.zoom({position:'topright'}).addTo(map); }
function setPickup(lat,lng){ window.mapState.pickup={lat,lng}; if(pickupMarker){ pickupMarker.setLatLng([lat,lng]); } else { pickupMarker=L.marker([lat,lng],{title:'استلام'}).addTo(map);} document.getElementById('pickup').value=`${lat.toFixed(6)}, ${lng.toFixed(6)}`; fitToMarkersOrRoute(); }
function setDropoff(lat,lng){ if(!lat){ window.mapState.dropoff=null; if(dropoffMarker){ map.removeLayer(dropoffMarker); dropoffMarker=null;} return;} window.mapState.dropoff={lat,lng}; if(dropoffMarker){ dropoffMarker.setLatLng([lat,lng]); } else { dropoffMarker=L.marker([lat,lng],{title:'تسليم'}).addTo(map);} document.getElementById('dropoff').value=`${lat.toFixed(6)}, ${lng.toFixed(6)}`; fitToMarkersOrRoute(); }
function copyCoords(which){ const p=which==='pickup'?window.mapState.pickup:window.mapState.dropoff; if(!p){ alert('لم يتم تحديد النقطة بعد'); return;} const txt=`${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`; navigator.clipboard?.writeText(txt).then(()=>toast('تم نسخ الإحداثيات')).catch(()=>alert(txt)); }
async function reverseGeocode(lat,lng,fieldId,hintId){ try{ const url=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&accept-language=ar&zoom=18`; const res=await fetch(url); const j=await res.json(); const txt=j&&(j.display_name||j.name); if(txt){ const fld=document.getElementById(fieldId); if(fld&&(!fld.value||fld.value.length<5)) fld.value=txt; const hint=document.getElementById(hintId); if(hint) hint.textContent=txt; } }catch(e){} }
function fitToMarkersOrRoute(){ const a=window.mapState.pickup,b=window.mapState.dropoff; if(a&&b&&routeLine){ map.fitBounds(routeLine.getBounds(),{padding:[30,30]}); return;} if(a&&b){ map.fitBounds([[a.lat,a.lng],[b.lat,b.lng]],{padding:[30,30]}); return;} if(a){ map.setView([a.lat,a.lng],Math.max(13,map.getZoom())); return;} const stored=JSON.parse(localStorage.getItem('WASILA_mapView')||'null'); if(stored?.center){ map.setView(stored.center, stored.zoom||11);} }
async function drawRouteIfReady(){ if(routeLine){ try{ map.removeLayer(routeLine);}catch(e){} routeLine=null; } const a=window.mapState.pickup,b=window.mapState.dropoff; if(!a||!b) return; try{ const url=`https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`; const r=await fetch(url); const j=await r.json(); if(j&&j.routes&&j.routes[0]){ const coords=j.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]); routeLine=L.polyline(coords,{weight:5,opacity:0.85,color:varColor()}).addTo(map); document.getElementById('estimateOut').textContent=`المسافة: ${(j.routes[0].distance/1000).toFixed(2)} كم — زمن تقريبي: ${Math.round(j.routes[0].duration/60)} د`; persistRouteInfo(j.routes[0].distance/1000, j.routes[0].duration/60); fitToMarkersOrRoute(); return; } }catch(e){} const coords=[[a.lat,a.lng],[b.lat,b.lng]]; routeLine=L.polyline(coords,{weight:4,opacity:0.6,color:varColor()}).addTo(map); const km=kmBetween().toFixed(2); document.getElementById('estimateOut').textContent=`المسافة التقريبية: ~ ${km} كم (خط مستقيم)`; persistRouteInfo(parseFloat(km), null); fitToMarkersOrRoute(); }
function varColor(){ return getComputedStyle(document.documentElement).getPropertyValue('--brand')||'#00C2C2'; }
function persistRouteInfo(km,mins){ window._lastRoute={km,mins}; }
function kmBetween(){ const a=window.mapState.pickup,b=window.mapState.dropoff; if(!a||!b) return 0; const toRad=x=>x*Math.PI/180,R=6371; const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lng-a.lng); const lat1=toRad(a.lat), lat2=toRad(b.lat); const hav=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2; const c=2*Math.atan2(Math.sqrt(hav), Math.sqrt(1-hav)); return R*c; }
function estimate(){ const route=window._lastRoute; const kms=route?.km||kmBetween(); const cargo=document.getElementById('cargoType').value||'boxes'; const weight=parseFloat(document.getElementById('weight').value)||0; const base=kms*S.pricing.kmRate; const mult=S.pricing.multipliers[cargo]||1; const extraKg=Math.max(0, weight-S.pricing.freeKg); const extraCost=extraKg*S.pricing.perKg; const total=(base*mult)+extraCost; document.getElementById('estimateOut').textContent=`تقديري: ${total.toFixed(2)} ر.س — مسافة: ${kms.toFixed(2)} كم`; return total; }
function useMyLocation(){ if(!navigator.geolocation){ alert('المتصفح لا يدعم تحديد الموقع'); return;} navigator.geolocation.getCurrentPosition((pos)=>{ const {latitude:lat, longitude:lng}=pos.coords; if(map) map.setView([lat,lng],14); setPickup(lat,lng); reverseGeocode(lat,lng,'pickup','pickupHint'); drawRouteIfReady(); }, (err)=>{ alert('تعذّر الحصول على الموقع: '+err.message); }, {enableHighAccuracy:true, timeout:8000, maximumAge:0}); }
function useMyLocationDrop(){ if(!navigator.geolocation){ alert('المتصفح لا يدعم تحديد الموقع'); return;} navigator.geolocation.getCurrentPosition((pos)=>{ const {latitude:lat, longitude:lng}=pos.coords; if(map) map.setView([lat,lng],14); setDropoff(lat,lng); reverseGeocode(lat,lng,'dropoff','dropoffHint'); drawRouteIfReady(); }, (err)=>{ alert('تعذّر الحصول على الموقع: '+err.message); }, {enableHighAccuracy:true, timeout:8000, maximumAge:0}); }
function runTests(){ const out=document.getElementById('testOutput'); out.textContent='تشغيل الاختبارات...'; let results=[]; try{ console.assert(typeof estimate==='function','estimate موجودة'); results.push('✅ دالة estimate معرفة'); const prev=S.pricing.kmRate; S.pricing.kmRate=5; const val=estimate(); S.pricing.kmRate=prev; results.push('✅ estimate تُعيد قيمة رقمية'); results.push(map?'✅ الخريطة مُحملة':'❌ الخريطة غير موجودة'); results.push(S.services.length>0?'✅ توجد خدمات مُحمّلة':'❌ لا خدمات'); out.textContent=results.join('\n'); }catch(e){ out.textContent='فشل الاختبارات: '+e.message; } }
(function(){ try{ window.useMyLocation=useMyLocation; window.useMyLocationDrop=useMyLocationDrop; window.copyCoords=copyCoords; window.estimate=estimate; window.submitOrder=submitOrder; window.runTests=runTests; window.openView=openView; window.activateTab=activateTab; window.assignDriver=assignDriver; window.acceptOrder=acceptOrder; window.completeOrder=completeOrder; window.cancelOrder=cancelOrder; window.savePricing=savePricing; window.addOwner=addOwner; persist(); }catch(_){}})();
</script>
</body>
</html>
