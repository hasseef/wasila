<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>وسيلة — نموذج أولي لحسابات التطبيق</title>
  <style>
    :root{
      /* لوحة فاتحة احترافية للهاتف مستوحاة من ونيت الحوض */
      --bg:#f6fbfc;          /* خلفية عامة فاتحة */
      --card:#ffffff;        /* بطاقات بيضاء */
      --muted:#667085;       /* نص ثانوي */
      --text:#0f172a;        /* نص أساسي داكن (slate-900) */
      --brand:#23c7c2;       /* تركواز أساسي */
      --brand-2:#7ce7e2;     /* تركواز فاتح للتدرج */
      --danger:#ef4444;
      --ok:#16a34a;          /* أخضر نجاح هادئ */
      --warn:#f59e0b;
      --b:#e5e7eb;           /* حدود فاتحة */
      --ring:#22d3ee;        /* ظل تركوازي */
      --shadow: 0 6px 24px rgba(14,165,233,.12), 0 2px 8px rgba(2,132,199,.08);
      --radius:16px;
      --tap:14px;            /* زيادة مساحة اللمس */
      --navH:64px;           /* ارتفاع شريط التنقل السفلي */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg), #ffffff 65%, #f5ffff);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Naskh Arabic",Tahoma,sans-serif;}
    a{color:inherit}
    .container{max-width:980px;margin:auto;padding:16px;padding-bottom:calc(16px + var(--navH));}
    header{position:sticky;top:0;background:rgba(255,255,255,.92);backdrop-filter:blur(10px);z-index:50;border-bottom:1px solid var(--b)}
    .brand{display:flex;gap:12px;align-items:center}
    .logoBox{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(180deg,var(--brand-2),var(--brand));box-shadow:var(--shadow)}
    .title{font-weight:800;letter-spacing:.1px}

    .card{background:var(--card);border:1px solid var(--b);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
    .card h3{margin:0 0 10px 0}

    .accounts{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(min-width:860px){.accounts{grid-template-columns:repeat(4,1fr)}}

    .btn{width:100%;padding:16px;border-radius:14px;border:1px solid #cbd5e1;background:#ffffff;cursor:pointer;color:var(--text);font-weight:800;box-shadow:0 1px 0 rgba(2,6,23,.04)}
    .btn:hover{border-color:var(--brand)}
    .primary{background:linear-gradient(180deg,var(--brand),var(--brand-2));border:none;color:#063a3a}
    .ghost{background:transparent;border:1px dashed #cbd5e1}

    .workbench{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:1000px){.workbench{grid-template-columns:1fr 420px}}
    .mapWrap{position:relative;min-height:360px;border-radius:var(--radius);overflow:hidden;border:1px solid var(--b);background:#f0fbfc}
    .mapFake{position:absolute;inset:0;z-index:1;background-image:radial-gradient(#d0f1f3 1px, transparent 1px);background-size:18px 18px;display:flex;align-items:center;justify-content:center;color:#0e7490;font-weight:800;letter-spacing:.5px}
    .panel{position:relative;z-index:2}

    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:680px){.row{grid-template-columns:1fr 1fr}}
    .field{display:grid;gap:6px;margin-bottom:10px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;padding:14px;border-radius:12px;background:#ffffff;border:1px solid #dbe4ea;color:var(--text)}
    input:focus,select:focus,textarea:focus{outline:none;border-color:#99f6e4;box-shadow:0 0 0 6px rgba(34,211,238,.18)}
    .muted{color:var(--muted);font-size:13px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 12px}
    .tab{padding:10px 14px;border-radius:999px;border:1px solid #cbd5e1;background:#ffffff;cursor:pointer;font-weight:800}
    .tab.active{border-color:#67e8f9;box-shadow:0 0 0 6px rgba(103,232,249,.2)}

    .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media(min-width:860px){.stats{grid-template-columns:repeat(4,1fr)}}
    .stat{padding:14px;border-radius:12px;border:1px solid var(--b);background:#ffffff;box-shadow:var(--shadow)}
    .stat b{font-size:22px}

    footer{margin:24px 0 12px;color:#6b7280;font-size:12px}

    .mapCollapsed .mapWrap{display:none}

    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #d1e4ea;background:#f8ffff}

    /* شريط تنقّل سفلي بأسلوب تطبيق جوال */
    .appTabs{position:fixed;inset-inline:0;bottom:0;height:var(--navH);background:#fff;border-top:1px solid var(--b);display:flex;z-index:60}
    .appTabs button{flex:1;border:0;background:transparent;font-weight:800;color:#0f172a;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px}
    .appTabs button .ico{width:22px;height:22px}
    .appTabs button.active{color:#0b6b6b}
      /* Leaflet map sizing + glass look */
    .mapWrap{position:relative;min-height:380px;border-radius:var(--radius);overflow:hidden;border:1px solid var(--b);background:#eefbfd;box-shadow:var(--shadow)}
    .leaflet-map{position:absolute;inset:0}
    .glass{background:rgba(255,255,255,.75);backdrop-filter:blur(10px);border:1px solid var(--b);box-shadow:var(--shadow);border-radius:12px}
    .field .inline-actions{display:flex;gap:8px;flex-wrap:wrap}
    .pill{padding:8px 12px;border-radius:999px;border:1px solid #cbd5e1;background:#fff;cursor:pointer;font-weight:700}
    .pill.active{border-color:#67e8f9;box-shadow:0 0 0 6px rgba(103,232,249,.2)}
  /* تحسين عرض خدمات الإدارة للجوال */
    .service-grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:480px){.service-grid{grid-template-columns:1fr 1fr}}
    @media(min-width:860px){.service-grid{grid-template-columns:1fr 1fr 1fr}}
    .service-card{display:flex;align-items:center;gap:12px;padding:14px;border:1px solid var(--b);border-radius:14px;background:#fff;box-shadow:var(--shadow)}
    .service-card .ico{width:36px;height:36px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(180deg,var(--brand-2),var(--brand));color:#063a3a;font-weight:900}
    .service-card .meta{flex:1;min-width:0}
    .service-card .meta b{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .service-card .meta .muted{font-size:12px}
    /* Switch (لمس كبير) */
    .switch{position:relative;display:inline-flex;align-items:center;gap:8px;cursor:pointer;font-weight:800}
    .switch input{appearance:none;width:44px;height:26px;border-radius:999px;border:1px solid #cbd5e1;background:#e5f9fb;outline:none;position:relative;transition:.2s}
    .switch input::after{content:"";position:absolute;top:3px;right:3px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.1);transition:.2s}
    .switch input:checked{background:linear-gradient(180deg,var(--brand),var(--brand-2));border-color:transparent}
    .switch input:checked::after{right:21px}
    .badge.on{border-color:#a7f3d0}
    .badge.off{border-color:#fecaca}
  </style>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body>
  <header>
    <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px;min-height:64px">
      <div class="brand">
        <div class="logoBox" aria-hidden="true" title="وسيلة">
          <!-- شعار ونيت حوض احترافي (SVG مضمّن، ليس تكسي) -->
          <svg width="30" height="30" viewBox="0 0 128 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <defs>
              <linearGradient id="trg" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="#23c7c2"/>
                <stop offset="1" stop-color="#7ce7e2"/>
              </linearGradient>
              <linearGradient id="glass" x1="0" y1="0" x2="1" y2="0">
                <stop offset="0" stop-color="#ecfeff"/>
                <stop offset="1" stop-color="#b9f3f1"/>
              </linearGradient>
            </defs>
            <!-- بدن ونيت مع حوض واضح وليس تاكسي -->
            <path d="M6 40h82c3 0 5-2 5-5v-7c0-1.2-.9-2.8-1.9-3.7l-10.5-9.6A6 6 0 0 0 76 12H58a4 4 0 0 0-4 4v6H24a10 10 0 0 0-10 10v8z" fill="url(#trg)"/>
            <!-- زجاج الكبينة -->
            <path d="M54 18h17c1.1 0 2.2.4 3 1.1l9.2 8.1H54V18z" fill="url(#glass)"/>
            <!-- أرضية الحوض -->
            <rect x="6" y="42" width="116" height="5" rx="2.5" fill="#d1faf5"/>
            <!-- عجلات -->
            <circle cx="32" cy="47" r="8" fill="#0ea5a4"/><circle cx="32" cy="47" r="3.8" fill="#ecfeff"/>
            <circle cx="96" cy="47" r="8" fill="#0ea5a4"/><circle cx="96" cy="47" r="3.8" fill="#ecfeff"/>
          </svg>
        </div>
        <div>
          <div class="title">وسيلة — نموذج أولي لحسابات التطبيق</div>
          <div class="muted" id="envNote">نسخة عرض أولية — بدون أي بيانات حقيقية</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn ghost" id="toggleMapBtn" title="إظهار / إخفاء الخريطة">إظهار/إخفاء الخريطة</button>
        <button class="btn" onclick="openView('landing')">الواجهة الرئيسية</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Landing / Accounts entry -->
    <section id="landing" class="card">
      <h3>واجهة وسيلة (نسخة عرض) <span class="badge" style="border-color:var(--ok)">كافة الخدمات مُفعّلة ✅</span></h3>
      <p class="muted">اختر الحساب أو الخدمة للتجربة (تصميم جوال):</p>
      <div class="accounts" style="margin-top:10px">
        <button class="btn" onclick="openView('shipper')">حساب العملاء (طالِب الخدمة)</button>
        <button class="btn" onclick="openView('owner')">حساب أصحاب الونيتات (تسجيل المركبة)</button>
        <button class="btn" onclick="openView('driver')">حساب السائقين</button>
        <button class="btn" onclick="openView('admin')">لوحة الإدارة</button>
        <button class="btn" onclick="openView('ownersList')">قائمة الملاك</button>
        <button class="btn" onclick="openView('services')">الخدمات</button>
      </div>
    </section>

    <!-- Shipper workspace -->
    <section id="shipper" class="card" hidden>
      <div class="tabs">
        <button class="tab active" data-target="shipperBench">طلب جديد</button>
        <button class="tab" data-target="shipper-orders">طلباتي</button>
      </div>

      <div class="workbench" id="shipperBench">
        <div class="mapWrap">
          <div id="leafletMap" class="leaflet-map" role="region" aria-label="خريطة وسيلة"></div>
        </div>
        </div>
        <div class="panel card">
          <h3>طلب توصيل <span class="badge" style="border-color:var(--ok);">مُفعل ✅</span></h3>
          <div class="field">
            <label>نقطة الاستلام</label>
            <div class="inline-actions">
              <input id="pickup" placeholder="المدينة، الحي، الشارع" style="flex:1" />
              <button type="button" class="pill" id="pickPickup">تحديد من الخريطة</button>
              <span class="muted" id="pickupHint"></span>
            </div>
          </div>
          <div class="field">
            <label>نقطة التسليم</label>
            <div class="inline-actions">
              <input id="dropoff" placeholder="المدينة، الحي، الشارع" style="flex:1" />
              <button type="button" class="pill" id="pickDropoff">تحديد من الخريطة</button>
              <span class="muted" id="dropoffHint"></span>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>الخدمة</label>
              <select id="serviceType"></select>
            </div>
            <div class="field">
              <label>حجم/نوع المنقول</label>
              <select id="cargoSize">
                <option value="small">صغير (صناديق خفيفة)</option>
                <option value="medium">متوسط (أثاث خفيف)</option>
                <option value="big">كبير (أثاث ثقيل/معدات)</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>موعد التنفيذ</label>
              <input type="datetime-local" id="when" />
            </div>
            <div class="field">
              <label>ملاحظات إضافية</label>
              <input id="notes" placeholder="وصف مختصر" />
            </div>
          </div>
          <div class="actions">
            <button class="btn primary" onclick="estimate()">تقدير السعر</button>
            <button class="btn" onclick="submitOrder()">إرسال الطلب</button>
            <span class="muted" id="estimateOut"></span>
          </div>
        </div>
      </div>

      <div id="shipper-orders" hidden>
        <div class="card">
          <h3>طلباتي</h3>
          <div id="ordersList" class="muted">لا توجد طلبات بعد.</div>
        </div>
      </div>
    </section>

    <!-- Owners (pickup truck owners) registration -->
    <section id="owner" class="card" hidden>
      <h3>تسجيل أصحاب الونيتات <span class="badge" style="border-color:var(--ok);">مُفعل ✅</span></h3>
      <p class="muted">يرجى تعبئة بيانات المركبة والسائق بدقة. هذه نسخة تجريبية ولا يتم رفع ملفات فعلية.</p>
      <div class="row">
        <div class="card">
          <h4>بيانات المركبة</h4>
          <div class="field">
            <label>نوع المركبة</label>
            <select id="vehType">
              <option>وانيت حوض صغير</option>
              <option>وانيت حوض كبير</option>
              <option>دينا</option>
              <option>قفص/مغطى</option>
            </select>
          </div>
          <div class="row">
            <div class="field">
              <label>رقم اللوحة</label>
              <input id="plate" placeholder="مثال: س ع ل 1234"/>
            </div>
            <div class="field">
              <label>موديل (سنة الصنع)</label>
              <input id="modelYear" type="number" min="1990" max="2026" placeholder="2019"/>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>المنطقة</label>
              <select id="region">
                <option>منطقة حائل</option>
                <option>منطقة الرياض</option>
                <option>منطقة مكة المكرمة</option>
                <option>المنطقة الشرقية</option>
                <option>المدينة المنورة</option>
                <option>القصيم</option>
                <option>تبوك</option>
                <option>عسير</option>
                <option>جازان</option>
                <option>نجران</option>
                <option>الباحة</option>
                <option>الجوف</option>
                <option>الحدود الشمالية</option>
              </select>
            </div>
            <div class="field">
              <label>الصورة (واجهة المركبة)</label>
              <input type="file" id="vehFront" accept="image/*" />
            </div>
          </div>
        </div>

        <div class="card">
          <h4>بيانات السائق</h4>
          <div class="row">
            <div class="field">
              <label>الاسم الثلاثي</label>
              <input id="driverName" placeholder="الاسم الكامل"/>
            </div>
            <div class="field">
              <label>رقم الهوية</label>
              <input id="nid" placeholder="10 أرقام" maxlength="10"/>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>رقم رخصة القيادة</label>
              <input id="licenseNo" placeholder="رقم الرخصة"/>
            </div>
            <div class="field">
              <label>تاريخ انتهاء الرخصة</label>
              <input id="licenseExp" type="date"/>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>نسخة الرخصة (صورة)</label>
              <input type="file" id="licenseImg" accept="image/*"/>
            </div>
            <div class="field">
              <label>IBAN للحوالات</label>
              <input id="iban" placeholder="SA.."/>
            </div>
          </div>
          <div class="actions">
            <button class="btn primary" onclick="saveOwner()">حفظ التسجيل</button>
            <span class="muted" id="ownerSaved"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- Owners list (enabled overview) -->
    <section id="ownersList" class="card" hidden>
      <h3>قائمة الملاك <span class="badge" style="border-color:var(--ok);">مُفعلة ✅</span></h3>
      <div id="ownersTable" class="muted">لا يوجد مُلاك بعد.</div>
    </section>

    <!-- Services (all enabled) -->
    <section id="services" class="card" hidden>
      <h3>الخدمات <span class="badge" style="border-color:var(--ok);">مُفعلة بالكامل ✅</span></h3>
      <div id="servicesGrid" class="accounts"></div>
    </section>

    <!-- Drivers account -->
    <section id="driver" class="card" hidden>
      <h3>حساب السائق <span class="badge" style="border-color:var(--ok);">مُفعل ✅</span></h3>
      <div class="row">
        <div class="card">
          <h4>الملف الشخصي</h4>
          <div class="field"><label>الاسم</label><input id="dName" placeholder="اسم السائق"/></div>
          <div class="row">
            <div class="field"><label>الهاتف</label><input id="dPhone" placeholder="05xxxxxxxx"/></div>
            <div class="field"><label>المدينة</label><input id="dCity" placeholder="مثال: حائل"/></div>
          </div>
          <div class="row">
            <div class="field"><label>الرخصة (صورة)</label><input type="file" id="dLicenseFile" accept="image/*"/></div>
            <div class="field"><label>إقامة/هوية (صورة)</label><input type="file" id="dIdFile" accept="image/*"/></div>
          </div>
          <div class="actions">
            <button class="btn primary" onclick="saveDriver()">حفظ</button>
            <label class="tab" style="display:inline-flex;align-items:center;gap:6px">
              <input type="checkbox" id="availableToggle" onchange="toggleAvail()"/>
              متاح لاستلام الطلبات
            </label>
          </div>
          <div class="muted" id="driverSaved"></div>
        </div>
        <div class="card">
          <h4>طلبات قريبة</h4>
          <div class="muted">تظهر هنا الطلبات ضمن نطاق 10 كم (تجريبي).</div>
          <ul id="nearbyList"></ul>
          <div class="actions"><span class="muted">اختر طلبًا ثم اضغط قبول</span></div>
        </div>
      </div>
    </section>

    <!-- Admin -->
    <section id="admin" class="card" hidden>
      <h3>لوحة إدارة التطبيق <span class="badge" style="border-color:var(--ok);">مُفعلة ✅</span></h3>
      <div class="stats">
        <div class="stat"><div class="muted">عدد العملاء</div><b id="stUsers">0</b></div>
        <div class="stat"><div class="muted">طلبات اليوم</div><b id="stOrders">0</b></div>
        <div class="stat"><div class="muted">سائقون متاحون</div><b id="stDrivers">0</b></div>
        <div class="stat"><div class="muted">مركبات مسجلة</div><b id="stVehicles">0</b></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>إدارة المناطق والتسعير</h4>
        <div class="row">
          <div class="field"><label>تعرفة الكيلومتر (ريال)</label><input id="kmRate" type="number" step="0.5" value="3"/></div>
          <div class="field"><label>رسوم فتح الطلب (ريال)</label><input id="baseFee" type="number" step="1" value="20"/></div>
        </div>
        <div class="actions">
          <button class="btn primary" onclick="savePricing()">حفظ التسعير</button>
          <span class="muted" id="pricingSaved"></span>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>الخدمات (تفعيل/تعطيل)</h4>
        <div id="adminServices" class="service-grid"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>سجل الطلبات (تجريبي)</h4>
        <div id="adminOrders" class="muted">لا توجد بيانات.</div>
        <template id="orderRowTmpl">
          <div class="card" data-id="">
            <div><b class="from"></b> → <b class="to"></b> <span class="badge status"></span></div>
            <div class="muted time"></div>
            <div class="actions">
              <button class="btn" data-action="complete">إكمال</button>
              <button class="btn ghost" data-action="cancel">إلغاء</button>
            </div>
          </div>
        </template>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>اختبارات تلقائية</h4>
        <p class="muted">للتحقق من وظائف الملاحة والتبويبات وتدفق حالة الطلب.</p>
        <div id="testResults"></div>
        <div class="actions"><button class="btn" id="runTestsBtn">تشغيل الاختبارات</button></div>
      </div>
    </section>

  </main>

  <!-- شريط تنقّل سفلي (أسلوب تطبيق جوال) -->
  <nav class="appTabs" role="navigation" aria-label="تبويب التطبيق">
    <button onclick="openView('landing')" id="tabHome"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10.5 12 3l9 7.5"/><path d="M9 21V12h6v9"/></svg><span>الرئيسية</span></button>
    <button onclick="openView('shipper')" id="tabShip"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="7" width="13" height="13" rx="2"/><path d="M16 13h5l-3-5h-2z"/></svg><span>العميل</span></button>
    <button onclick="openView('driver')" id="tabDrv"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 13h18"/><path d="M5 16h14"/><circle cx="7" cy="19" r="2"/><circle cx="17" cy="19" r="2"/></svg><span>السائق</span></button>
    <button onclick="openView('owner')" id="tabOwn"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="10" rx="3"/><path d="M7 7V5h10v2"/></svg><span>المالك</span></button>
    <button onclick="openView('admin')" id="tabAdm"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .7.4 1.3 1 1.6.3.2.6.4 1 .4a2 2 0 1 1 0 4c-.4 0-.7.2-1 .4-.6.3-1 .9-1 1.6z"/></svg><span>الإدارة</span></button>
  </nav>

  <footer class="container">
    <div>© وسيلة — نموذج أولي للاستخدام الداخلي.</div>
  </footer>

  <script>
    // ---- Simple state (global) ----
    const S = {
      orders: JSON.parse(localStorage.getItem('orders')||'[]'),
      owners: JSON.parse(localStorage.getItem('owners')||'[]'),
      drivers: JSON.parse(localStorage.getItem('drivers')||'[]'),
      pricing: JSON.parse(localStorage.getItem('pricing')||'{"kmRate":3,"baseFee":20}'),
      services: JSON.parse(localStorage.getItem('services')||JSON.stringify([
        {key:'house_move', name:'نقل أثاث منزلي', enabled:true},
        {key:'appliance',  name:'أجهزة كهربائية', enabled:true},
        {key:'office',     name:'نقل مكتبي', enabled:true},
        {key:'flatbed',    name:'سطحة/معدات', enabled:true},
        {key:'building',   name:'مواد بناء وحفر', enabled:true},
        {key:'landscape',  name:'تنسيق حدائق ونخيل', enabled:true},
        {key:'event',      name:'تجهيز فعاليات ومعارض', enabled:true},
        {key:'waste',      name:'مخلفات خفيفة ونقل أنقاض', enabled:true},
        {key:'store',      name:'توصيل من متجر/مستودع', enabled:true},
        {key:'warehouse',  name:'مناولة بين المستودعات', enabled:true},
        {key:'long',       name:'نقل بين المدن', enabled:true},
        {key:'express',    name:'سريع داخل المدينة', enabled:true}
      ]))
    };
    // حالة الطلب: new, assigned, in_progress, completed, cancelled

    // ---- Define openView EARLY so inline onclick & router can use it ----
    window.openView = function openView(id){
      document.querySelectorAll('main > section').forEach(sec=>sec.hidden = true);
      const el = document.getElementById(id) || document.getElementById('landing');
      el.hidden = false;
      // حدّث تنقّل التطبيق السفلي
      document.querySelectorAll('.appTabs button').forEach(b=>b.classList.remove('active'));
      const mapIdToBtn = {landing:'tabHome', shipper:'tabShip', driver:'tabDrv', owner:'tabOwn', admin:'tabAdm'};
      const btnId = mapIdToBtn[id]; if(btnId) document.getElementById(btnId).classList.add('active');
      updateUI();
    }

    // ---- DOM bootstrap ----
    document.addEventListener('DOMContentLoaded', ()=>{
      // tabs behavior
      document.querySelectorAll('.tabs .tab').forEach(tab=>{
        tab.addEventListener('click', ()=>{
          const wrap = tab.closest('section');
          wrap.querySelectorAll('.tabs .tab').forEach(t=>t.classList.remove('active'));
          tab.classList.add('active');
          const target = tab.dataset.target;
          if(target){
            wrap.querySelectorAll('#shipperBench,#shipper-orders').forEach(v=>v.hidden=true);
            const tgt = wrap.querySelector('#'+target);
            if(tgt){ tgt.closest('div').hidden=false; }
          }
        });
      });

      // map toggle
      const tgl = document.getElementById('toggleMapBtn');
      if(tgl){ tgl.addEventListener('click',()=>{ document.body.classList.toggle('mapCollapsed'); }); }

      // boot: always land on landing without showing hash
      history.replaceState(null, '', location.pathname);
      openView('landing');
      initLeaflet();
      updateUI();

      // bind map picking buttons
      const pp = document.getElementById('pickPickup');
      const pd = document.getElementById('pickDropoff');
      if(pp) pp.addEventListener('click', ()=>enterMapPickMode('pickup'));
      if(pd) pd.addEventListener('click', ()=>enterMapPickMode('dropoff'));

      // tests
      const testBtn = document.getElementById('runTestsBtn');
      if(testBtn){ testBtn.addEventListener('click', runTests); }
    });

    function kmBetween(){
      // if both points selected on map, compute haversine; else fallback to ~random
      if(window.mapState?.pickup && window.mapState?.dropoff){
        const {pickup, dropoff} = window.mapState;
        const R = 6371; // km
        const toRad = d => d*Math.PI/180;
        const dLat = toRad(dropoff.lat - pickup.lat);
        const dLon = toRad(dropoff.lng - pickup.lng);
        const a = Math.sin(dLat/2)**2 + Math.cos(toRad(pickup.lat))*Math.cos(toRad(dropoff.lat))*Math.sin(dLon/2)**2;
        const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return Math.max(1, Math.round(R*c));
      }
      return 2 + Math.round(Math.random()*12);
    }

    function estimate(){
      const km = kmBetween();
      const r = S.pricing.kmRate || 3; const base = S.pricing.baseFee || 20;
      const size = document.getElementById('cargoSize').value;
      const multiplier = size==='big'?1.8:size==='medium'?1.3:1;
      const price = Math.round((base + km*r)*multiplier);
      document.getElementById('estimateOut').textContent = `تقدير: ~ ${price} ريال لمسافة ${km} كم`;
      return price;
    }

    function submitOrder(){
      const svcSel = document.getElementById('serviceType');
      const service = svcSel ? (svcSel.value || '') : '';
      const data = {
        pickup: val('pickup'), dropoff: val('dropoff'), when: val('when'), notes: val('notes'), size: val('cargoSize'), service,
        price: estimate(), id: Date.now(), status: 'new', driverId: null
      };
      if(!data.pickup||!data.dropoff){alert('يرجى إدخال الاستلام والتسليم');return}
      S.orders.unshift(data);
      persist();
      document.getElementById('estimateOut').textContent = 'تم إرسال الطلب.';
      updateUI();
      const tab = document.querySelector('#shipper .tabs .tab[data-target="shipper-orders"]');
      if(tab) tab.click();
    }

    function saveOwner(){
      const rec = {
        vehType: val('vehType'), plate: val('plate'), modelYear: val('modelYear'), region: val('region'),
        driverName: val('driverName'), nid: val('nid'), licenseNo: val('licenseNo'), licenseExp: val('licenseExp'), iban: val('iban'),
        id: Date.now()
      };
      S.owners.unshift(rec); persist();
      byId('ownerSaved').textContent = 'تم الحفظ.'; updateUI();
    }

    function saveDriver(){
      const d = {name: val('dName'), phone: val('dPhone'), city: val('dCity'), available: byId('availableToggle').checked, id: Date.now()};
      S.drivers.unshift(d); persist();
      byId('driverSaved').textContent = 'تم الحفظ.'; updateUI();
    }

    function toggleAvail(){updateUI()}

    function savePricing(){
      S.pricing = {kmRate: +val('kmRate')||3, baseFee: +val('baseFee')||20};
      persist();
      byId('pricingSaved').textContent = 'تم تحديث التسعير.';
    }

    // السائق يقبل طلب
    function driverAccept(orderId){
      const d = S.drivers[0]; // لأغراض التجربة: أول سائق مُسجل
      const o = S.orders.find(x=>x.id===orderId);
      if(!o) return;
      o.driverId = d? d.id : null;
      o.status = 'in_progress';
      persist();
      updateUI();
      alert('تم قبول الطلب والبدء في تنفيذه');
    }

    function updateUI(){
      // services in shipper form
      const svcSel = byId('serviceType');
      if(svcSel){
        const enabled = S.services.filter(s=>s.enabled);
        svcSel.innerHTML = enabled.map(s=>`<option value="${s.key}">${s.name}</option>`).join('');
        if(!enabled.length){ svcSel.innerHTML = '<option disabled>لا توجد خدمات مفعلة</option>'; }
      }

      // services grid (landing/services)
      const svcGrid = byId('servicesGrid');
      if(svcGrid){
        svcGrid.innerHTML = S.services.map(s=>
          `<div class=\"card\"><div style=\"display:flex;align-items:center;justify-content:space-between;gap:8px\">
            <b>${s.name}</b>
            <span class=\"badge\" style=\"border-color:${s.enabled?'#a7f3d0':'#fecaca'}\">${s.enabled?'مُفعّل':'معطّل'}</span>
          </div></div>`).join('');
      }

      // Admin services toggles
      const adminSvc = byId('adminServices');
      if(adminSvc){
        adminSvc.innerHTML = S.services.map((s,i)=>{
          const stateBadge = `<span class=\"badge ${s.enabled?'on':'off'}\">${s.enabled?'مُفعّل':'معطّل'}</span>`;
          const letter = s.name.trim().charAt(0);
          const id = `svc_${i}`;
          return `<div class=\"service-card\">
            <div class=\"ico\" aria-hidden=\"true\">${letter}</div>
            <div class=\"meta\"><b title=\"${s.name}\">${s.name}</b><div class=\"muted\">${s.key}</div></div>
            <label class=\"switch\" for=\"${id}\">
              <input id=\"${id}\" type=\"checkbox\" ${s.enabled?'checked':''} onchange=\"toggleService(${i}, this.checked)\" aria-label=\"تفعيل ${s.name}\" />
            </label>
            ${stateBadge}
          </div>`
        }).join('');
      }
    }
      // Admin stats
      byId('stUsers').textContent = Math.max(1, Math.ceil(S.orders.length/2));
      byId('stOrders').textContent = S.orders.slice(0,10).length;
      byId('stDrivers').textContent = S.drivers.filter(d=>d.available).length;
      byId('stVehicles').textContent = S.owners.length;

      // Admin orders table
      const adminOrders = byId('adminOrders');
      if(adminOrders){
        if(!S.orders.length) adminOrders.textContent = 'لا توجد بيانات.'; else{
          adminOrders.innerHTML = '';
          S.orders.forEach(o=>{
            const row = document.getElementById('orderRowTmpl').content.cloneNode(true);
            const root = row.querySelector('.card');
            root.dataset.id = o.id;
            row.querySelector('.from').textContent = o.pickup;
            row.querySelector('.to').textContent = o.dropoff;
            row.querySelector('.time').textContent = new Date(o.id).toLocaleString('ar-SA');
            const stEl = row.querySelector('.status');
            stEl.textContent = mapStatus(o.status);
            if(o.status==='completed'||o.status==='cancelled'){ row.querySelector('[data-action=\"complete\"]').disabled = true; }
            row.querySelector('[data-action=\"complete\"]').addEventListener('click',()=>{ o.status='completed'; persist(); updateUI();});
            row.querySelector('[data-action=\"cancel\"]').addEventListener('click',()=>{ o.status='cancelled'; persist(); updateUI();});
            adminOrders.appendChild(row);
          });
        }
      }
      // Nearby for driver (show last 5 orders that are new)
      const near = byId('nearbyList');
      if(near){
        const avail = S.orders.filter(o=>o.status==='new').slice(0,5);
        if(!avail.length) near.innerHTML = '<li class="muted">لا توجد طلبات قريبة الآن.</li>'; else{
          near.innerHTML = avail.map(o=>`<li class=\"card\" style=\"margin:6px 0;padding:10px\"><b>${esc(o.pickup)}</b> → <b>${esc(o.dropoff)}</b>${o.service?` — <span class=\\\"badge\\\">${esc(labelOf(o.service))}</span>`:''}<br><span class=\"muted\">~${o.price} ر.س</span><div class=\"actions\"><button class=\"btn primary\" onclick=\"driverAccept(${o.id})\">قبول</button></div></li>`).join('');
        }
      }
      // Owners table
      const ownersHost = byId('ownersTable');
      if(ownersHost){
        if(!S.owners.length) ownersHost.textContent = 'لا يوجد مُلاك بعد.'; else{
          ownersHost.innerHTML = S.owners.map(o=>`<div class=\"card\" style=\"margin:6px 0\"><b>${esc(o.driverName)}</b> — ${esc(o.vehType)} | ${esc(o.region)} <span class=\"muted\">${esc(o.plate)}</span></div>`).join('');
        }
      }
    }

    function toggleService(i, val){ S.services[i].enabled = !!val; persist(); updateUI(); }

    function labelOf(key){ const f = S.services.find(s=>s.key===key); return f?f.name:key; }

    function val(id){return document.getElementById(id)?.value?.trim()||''}
    function byId(id){return document.getElementById(id)}
    function esc(s){return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}
    function mapStatus(s){ return s==='new'?'جديد': s==='assigned'?'مُسند': s==='in_progress'?'قيد التنفيذ': s==='completed'?'مكتمل': s==='cancelled'?'ملغي':'غير معروف'; }
    function persist(){ localStorage.setItem('orders', JSON.stringify(S.orders)); localStorage.setItem('owners', JSON.stringify(S.owners)); localStorage.setItem('drivers', JSON.stringify(S.drivers)); localStorage.setItem('pricing', JSON.stringify(S.pricing)); localStorage.setItem('services', JSON.stringify(S.services)); }

    // ---- Minimal front-end test cases (unchanged) ----
    function runTests(){
      const results = [];
      const assert = (name, cond) => results.push({اختبار:name, النتيجة: cond? 'PASS':'FAIL'});
      try{
        assert('تعريف openView', typeof window.openView === 'function');
        const ids = ['landing','shipper','owner','driver','admin','ownersList'];
        ids.forEach(id=>{ window.openView(id); const sec = document.getElementById(id); assert(`إظهار القسم ${id}`, sec && sec.hidden===false); });
        // Hash routing (نتركه كما هو للاختبار لكنه لا يُستخدم بالإقلاع)
        location.hash = '#owner'; window.dispatchEvent(new HashChangeEvent('hashchange')); assert('المسار بالهاش يعمل', !document.getElementById('owner').hidden);
        // تبويب الشاحن
        window.openView('shipper');
        const newTab = document.querySelector('#shipper .tabs .tab[data-target="shipper-orders"]');
        if(newTab){ newTab.click(); }
        assert('التبديل إلى تبويب "طلباتي"', document.getElementById('shipper-orders').hidden===false);
        // سيناريو: إنشاء طلب وقبوله ثم إكماله
        const preCount = S.orders.length;
        S.orders.unshift({id: Date.now()+1, pickup:'اختبار أ', dropoff:'اختبار ب', size:'small', price:50, status:'new', driverId:null});
        persist();
        assert('إضافة طلب اختباري', S.orders.length===preCount+1);
        const newId = S.orders[0].id; driverAccept(newId); assert('قبول السائق للطلب', S.orders[0].status==='in_progress');
        S.orders[0].status='completed'; persist(); assert('إكمال الطلب', S.orders[0].status==='completed');
        updateUI();
      }catch(e){ console.error('Test error:', e); }
      const host = document.getElementById('testResults');
      if(host){ host.innerHTML = '<div class="badge">نتائج</div>' + '<pre style="white-space:pre-wrap">'+results.map(r=>`${r.اختبار}: ${r.النتيجة}`).join('\n')+'</pre>'; }
      console.table(results);
      window.openView('landing');
    }
      // ===== Leaflet integration =====
    let map, pickupMarker, dropoffMarker, routeLine; 
    window.mapState = {pickup:null, dropoff:null};

    function initLeaflet(){
      if(typeof L === 'undefined'){ console.warn('Leaflet not loaded'); return; }
      if(map){ return; }
      map = L.map('leafletMap', { zoomControl: true, attributionControl: true }).setView([24.7136,46.6753], 11); // Riyadh default
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' }).addTo(map);

      // custom divIcon as truck badge
      const truckSVG = `<?xml version="1.0"?><svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 128 64'><defs><linearGradient id='t' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='#23c7c2'/><stop offset='1' stop-color='#7ce7e2'/></linearGradient></defs><rect x='0' y='40' width='128' height='8' rx='4' fill='#cffafe'/><path d='M6 40h82c3 0 5-2 5-5v-7c0-1.2-.9-2.8-1.9-3.7l-10.5-9.6A6 6 0 0 0 76 12H58a4 4 0 0 0-4 4v6H24a10 10 0 0 0-10 10v8z' fill='url(#t)'/><circle cx='32' cy='47' r='8' fill='#0ea5a4'/><circle cx='32' cy='47' r='3.8' fill='#ecfeff'/><circle cx='96' cy='47' r='8' fill='#0ea5a4'/><circle cx='96' cy='47' r='3.8' fill='#ecfeff'/></svg>`;
      const truckIcon = L.divIcon({ className:'', html:`<div class="glass" style="padding:6px;border-radius:12px">${truckSVG}</div>` , iconSize:[36,36], iconAnchor:[18,18] });
      const dropIcon  = L.divIcon({ className:'', html:`<div class="glass" style="padding:6px;border-radius:12px;transform:scale(.95)">${truckSVG}</div>` , iconSize:[36,36], iconAnchor:[18,18] });

      map.on('click', (e)=>{
        if(!window.mapPickMode) return;
        const {lat,lng} = e.latlng;
        if(window.mapPickMode==='pickup'){
          window.mapState.pickup = {lat,lng};
          if(pickupMarker) pickupMarker.setLatLng([lat,lng]); else pickupMarker = L.marker([lat,lng], {icon:truckIcon}).addTo(map);
          document.getElementById('pickupHint').textContent = `تم التحديد (${lat.toFixed(5)}, ${lng.toFixed(5)})`;
        }else if(window.mapPickMode==='dropoff'){
          window.mapState.dropoff = {lat,lng};
          if(dropoffMarker) dropoffMarker.setLatLng([lat,lng]); else dropoffMarker = L.marker([lat,lng], {icon:dropIcon}).addTo(map);
          document.getElementById('dropoffHint').textContent = `تم التحديد (${lat.toFixed(5)}, ${lng.toFixed(5)})`;
        }
        exitMapPickMode();
        drawRouteIfReady();
      });
    }

    function enterMapPickMode(which){
      window.mapPickMode = which; // 'pickup' | 'dropoff'
      document.getElementById(which==='pickup'?'pickPickup':'pickDropoff').classList.add('active');
    }
    function exitMapPickMode(){
      const btns=['pickPickup','pickDropoff']; btns.forEach(id=>{ const b=document.getElementById(id); if(b) b.classList.remove('active'); });
      window.mapPickMode = null;
    }

    function drawRouteIfReady(){
      const a = window.mapState.pickup, b = window.mapState.dropoff; if(!a||!b||!map) return;
      const latlngs = [ [a.lat,a.lng], [b.lat,b.lng] ];
      if(routeLine){ routeLine.setLatLngs(latlngs); } else { routeLine = L.polyline(latlngs, {weight:5, opacity:.8}).addTo(map); }
      map.fitBounds(routeLine.getBounds(), { padding:[30,30] });
      // update estimate hint immediately
      document.getElementById('estimateOut').textContent = `المسافة التقريبية: ~ ${kmBetween()} كم`;
    }
  </script>
</body>
</html>
