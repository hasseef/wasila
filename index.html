<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>وسيلة — نموذج أولي لحسابات التطبيق</title>
  <meta name="theme-color" content="#23c7c2" />
  <style>
    :root{
      --bg:#f6fbfc; --card:#ffffff; --muted:#667085; --text:#0f172a;
      --brand:#23c7c2; --brand-2:#7ce7e2; --danger:#ef4444; --ok:#16a34a; --warn:#f59e0b;
      --b:#e5e7eb; --ring:#22d3ee; --shadow: 0 6px 24px rgba(14,165,233,.12), 0 2px 8px rgba(2,132,199,.08);
      --radius:16px; --navH:64px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#fff 65%,#f5ffff);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Naskh Arabic",Tahoma,sans-serif}
    a{color:inherit}
    .container{max-width:980px;margin:auto;padding:16px;padding-bottom:calc(16px + var(--navH));}
    header{position:sticky;top:0;background:rgba(255,255,255,.92);backdrop-filter:blur(10px);z-index:50;border-bottom:1px solid var(--b)}
    .brand{display:flex;gap:12px;align-items:center}
    .logoBox{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(180deg,var(--brand-2),var(--brand));box-shadow:var(--shadow)}
    .title{font-weight:800;letter-spacing:.1px}

    .card{background:var(--card);border:1px solid var(--b);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
    .card h3{margin:0 0 10px 0}

    .accounts{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(min-width:860px){.accounts{grid-template-columns:repeat(4,1fr)}}

    .btn{width:100%;padding:16px;border-radius:14px;border:1px solid #cbd5e1;background:#ffffff;cursor:pointer;color:var(--text);font-weight:800}
    .btn:hover{border-color:var(--brand)}
    .primary{background:linear-gradient(180deg,var(--brand),var(--brand-2));border:none;color:#063a3a}
    .ghost{background:transparent;border:1px dashed #cbd5e1}

    .workbench{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:1000px){.workbench{grid-template-columns:1fr 420px}}

    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:680px){.row{grid-template-columns:1fr 1fr}}
    .field{display:grid;gap:6px;margin-bottom:10px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;padding:14px;border-radius:12px;background:#ffffff;border:1px solid #dbe4ea;color:var(--text)}
    input:focus,select:focus,textarea:focus{outline:none;border-color:#99f6e4;box-shadow:0 0 0 6px rgba(34,211,238,.18)}
    .muted{color:var(--muted);font-size:13px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 12px}
    .tab{padding:10px 14px;border-radius:999px;border:1px solid #cbd5e1;background:#ffffff;cursor:pointer;font-weight:800}
    .tab.active{border-color:#67e8f9;box-shadow:0 0 0 6px rgba(103,232,249,.2)}

    .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media(min-width:860px){.stats{grid-template-columns:repeat(4,1fr)}}
    .stat{padding:14px;border-radius:12px;border:1px solid var(--b);background:#ffffff;box-shadow:var(--shadow)}
    .stat b{font-size:22px}

    footer{margin:24px 0 12px;color:#6b7280;font-size:12px}

    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #d1e4ea;background:#f8ffff}

    /* شريط تنقّل سفلي بأسلوب تطبيق جوال */
    .appTabs{position:fixed;inset-inline:0;bottom:0;height:var(--navH);background:#fff;border-top:1px solid var(--b);display:flex;z-index:60}
    .appTabs button{flex:1;border:0;background:transparent;font-weight:800;color:#0f172a;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px}
    .appTabs button .ico{width:22px;height:22px}
    .appTabs button.active{color:#0b6b6b}

    /* Leaflet map sizing + glass look */
    .mapWrap{position:relative;min-height:380px;border-radius:var(--radius);overflow:hidden;border:1px solid var(--b);background:#eefbfd;box-shadow:var(--shadow)}
    .leaflet-map{position:absolute;inset:0}
    .glass{background:rgba(255,255,255,.75);backdrop-filter:blur(10px);border:1px solid var(--b);box-shadow:var(--shadow);border-radius:12px}
    .field .inline-actions{display:flex;gap:8px;flex-wrap:wrap}
    .pill{padding:8px 12px;border-radius:999px;border:1px solid #cbd5e1;background:#fff;cursor:pointer;font-weight:700}
    .pill.active{border-color:#67e8f9;box-shadow:0 0 0 6px rgba(103,232,249,.2)}
    .pill.primary{background:linear-gradient(180deg,var(--brand),var(--brand-2));border:0;color:#063a3a}

    /* تحسين عرض خدمات الإدارة للجوال */
    .service-grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:480px){.service-grid{grid-template-columns:1fr 1fr}}
    @media(min-width:860px){.service-grid{grid-template-columns:1fr 1fr 1fr}}
    .service-card{display:flex;align-items:center;gap:12px;padding:14px;border:1px solid var(--b);border-radius:14px;background:#fff;box-shadow:var(--shadow)}
    .service-card .ico{width:36px;height:36px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(180deg,var(--brand-2),var(--brand));color:#063a3a;font-weight:900}
    .service-card .meta{flex:1;min-width:0}
    .service-card .meta b{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .service-card .meta .muted{font-size:12px}
    .switch{position:relative;display:inline-flex;align-items:center;gap:8px;cursor:pointer;font-weight:800}
    .switch input{appearance:none;width:44px;height:26px;border-radius:999px;border:1px solid #cbd5e1;background:#e5f9fb;outline:none;position:relative;transition:.2s}
    .switch input::after{content:"";position:absolute;top:3px;right:3px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.1);transition:.2s}
    .switch input:checked{background:linear-gradient(180deg,var(--brand),var(--brand-2));border-color:transparent}
    .switch input:checked::after{right:21px}
    .badge.on{border-color:#a7f3d0}
    .badge.off{border-color:#fecaca}
    .svc-group{display:grid;gap:8px}
    .svc-group h5{margin:8px 0 0;font-size:14px;color:#0b6b6b}

    /* map controls */
    .mapCtrls{position:absolute;inset-inline-end:10px;inset-block-start:10px;display:flex;flex-direction:column;gap:8px;z-index:5}
    .mapBtn{padding:10px 12px;border-radius:12px;border:1px solid #cbd5e1;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);font-weight:800;cursor:pointer;box-shadow:var(--shadow)}
    .mapBtn:hover{border-color:#67e8f9}
    /* Toast */
    .toast{position:fixed;inset-inline:12px;inset-block-end:calc(var(--navH) + 12px);background:#003; color:#e6fffb; padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);display:none}
    .toast.show{display:block}
  </style>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body>
  <header>
    <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px;min-height:64px">
      <div class="brand">
        <div class="logoBox" aria-hidden="true" title="وسيلة">
          <!-- شعار ونيت حوض احترافي (SVG مضمّن، ليس تكسي) -->
          <svg width="30" height="30" viewBox="0 0 128 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <defs>
              <linearGradient id="trg" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="#23c7c2"/>
                <stop offset="1" stop-color="#7ce7e2"/>
              </linearGradient>
              <linearGradient id="glass" x1="0" y1="0" x2="1" y2="0">
                <stop offset="0" stop-color="#ecfeff"/>
                <stop offset="1" stop-color="#b9f3f1"/>
              </linearGradient>
            </defs>
            <path d="M6 40h82c3 0 5-2 5-5v-7c0-1.2-.9-2.8-1.9-3.7l-10.5-9.6A6 6 0 0 0 76 12H58a4 4 0 0 0-4 4v6H24a10 10 0 0 0-10 10v8z" fill="url(#trg)"/>
            <path d="M54 18h17c1.1 0 2.2.4 3 1.1l9.2 8.1H54V18z" fill="url(#glass)"/>
            <rect x="6" y="42" width="116" height="5" rx="2.5" fill="#d1faf5"/>
            <circle cx="32" cy="47" r="8" fill="#0ea5a4"/><circle cx="32" cy="47" r="3.8" fill="#ecfeff"/>
            <circle cx="96" cy="47" r="8" fill="#0ea5a4"/><circle cx="96" cy="47" r="3.8" fill="#ecfeff"/>
          </svg>
        </div>
        <div>
          <div class="title">وسيلة — نموذج أولي لحسابات التطبيق</div>
          <div class="muted" id="envNote">نسخة عرض أولية — بدون أي بيانات حقيقية</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="installBtn" style="display:none" title="تثبيت كتطبيق">تثبيت وسيلة</button>
        <button class="btn ghost" id="toggleMapBtn" title="إظهار / إخفاء الخريطة">إظهار/إخفاء الخريطة</button>
        <button class="btn" onclick="openView('landing')">الواجهة الرئيسية</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Landing / Accounts entry -->
    <section id="landing" class="card">
      <h3>واجهة وسيلة (نسخة عرض) <span class="badge" style="border-color:var(--ok)">كافة الخدمات مُفعّلة ✅</span></h3>
      <p class="muted">اختر الحساب أو الخدمة للتجربة (تصميم جوال):</p>
      <div class="accounts" style="margin-top:10px">
        <button class="btn" onclick="openView('shipper')">حساب العملاء (طالِب الخدمة)</button>
        <button class="btn" onclick="openView('owner')">حساب أصحاب الونيتات (تسجيل المركبة)</button>
        <button class="btn" onclick="openView('driver')">حساب السائقين</button>
        <button class="btn" onclick="openView('admin')">لوحة الإدارة</button>
        <button class="btn" onclick="openView('ownersList')">قائمة الملاك</button>
        <button class="btn" onclick="openView('services')">الخدمات</button>
      </div>
    </section>

    <!-- Shipper workspace -->
    <section id="shipper" class="card" hidden>
      <div class="tabs">
        <button class="tab active" data-target="shipperBench">طلب جديد</button>
        <button class="tab" data-target="shipper-orders">طلباتي</button>
      </div>

      <div class="workbench" id="shipperBench">
        <div class="mapWrap">
          <div id="leafletMap" class="leaflet-map" role="region" aria-label="خريطة وسيلة"></div>
          <div class="mapCtrls" aria-hidden="false">
            <button type="button" class="mapBtn" id="fitRouteBtn">ملاءمة المسار</button>
            <button type="button" class="mapBtn" id="recenterBtn">إرجاع الخريطة</button>
          </div>
        </div>
        <div class="panel card">
          <h3>طلب توصيل <span class="badge" style="border-color:var(--ok);">مُفعل ✅</span></h3>
          <div class="field">
            <label>نقطة الاستلام</label>
            <div class="inline-actions">
              <input id="pickup" placeholder="المدينة، الحي، الشارع" style="flex:1" />
              <button type="button" class="pill" id="pickPickup">تحديد من الخريطة</button>
              <button type="button" class="pill primary" id="useGPS" title="استخدم موقعي">استخدم موقعي</button>
              <button type="button" class="pill" id="copyPickup" title="نسخ الإحداثيات">نسخ إحداثيات</button>
              <span class="muted" id="pickupHint"></span>
            </div>
          </div>
          </div>
          <div class="field">
            <label>نقطة التسليم</label>
            <div class="inline-actions">
              <input id="dropoff" placeholder="المدينة، الحي، الشارع" style="flex:1" />
              <button type="button" class="pill" id="pickDropoff">تحديد من الخريطة</button>
              <button type="button" class="pill primary" id="useGPSDrop" title="موقعي للتسليم">موقعي للتسليم</button>
              <button type="button" class="pill" id="copyDropoff" title="نسخ الإحداثيات">نسخ إحداثيات</button>
              <span class="muted" id="dropoffHint"></span>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>الخدمة</label>
              <select id="serviceType"></select>
            </div>
            <div class="field">
              <label>حجم/نوع المنقول</label>
              <select id="cargoSize">
                <option value="small">صغير (صناديق خفيفة)</option>
                <option value="medium">متوسط (أثاث خفيف)</option>
                <option value="big">كبير (أثاث ثقيل/معدات)</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>نوع الحمولة</label>
              <select id="cargoType">
                <option value="boxes">صناديق/أغراض عامة</option>
                <option value="furniture">أثاث</option>
                <option value="appliances">أجهزة كهربائية</option>
                <option value="building">مواد بناء</option>
                <option value="equipment">معدات</option>
              </select>
            </div>
            <div class="field">
              <label>وزن تقريبي (كجم)</label>
              <input type="number" id="weightKg" min="0" step="1" placeholder="اختياري"/>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>موعد التنفيذ</label>
              <input type="datetime-local" id="when" />
            </div>
            <div class="field">
              <label>ملاحظات إضافية</label>
              <input id="notes" placeholder="وصف مختصر" />
            </div>
          </div>
          <div class="actions">
            <button class="btn primary" onclick="estimate()">تقدير السعر</button>
            <button class="btn" onclick="submitOrder()">إرسال الطلب</button>
            <span class="muted" id="estimateOut"></span>
          </div>
        </div>
      </div>

      <div id="shipper-orders" hidden>
        <div class="card">
          <h3>طلباتي</h3>
          <div id="ordersList" class="muted">لا توجد طلبات بعد.</div>
        </div>
      </div>
    </section>

    <!-- Owners (pickup truck owners) registration -->
    <section id="owner" class="card" hidden>
      <h3>تسجيل أصحاب الونيتات <span class="badge" style="border-color:var(--ok);">مُفعل ✅</span></h3>
      <p class="muted">يرجى تعبئة بيانات المركبة والسائق بدقة. هذه نسخة تجريبية ولا يتم رفع ملفات فعلية.</p>
      <div class="row">
        <div class="card">
          <h4>بيانات المركبة</h4>
          <div class="field">
            <label>نوع المركبة</label>
            <select id="vehType">
              <option>وانيت حوض صغير</option>
              <option>وانيت حوض كبير</option>
              <option>دينا</option>
              <option>قفص/مغطى</option>
            </select>
          </div>
          <div class="row">
            <div class="field">
              <label>رقم اللوحة</label>
              <input id="plate" placeholder="مثال: س ع ل 1234"/>
            </div>
            <div class="field">
              <label>موديل (سنة الصنع)</label>
              <input id="modelYear" type="number" min="1990" max="2026" placeholder="2019"/>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>المنطقة</label>
              <select id="region">
                <option>منطقة حائل</option><option>منطقة الرياض</option><option>منطقة مكة المكرمة</option>
                <option>المنطقة الشرقية</option><option>المدينة المنورة</option><option>القصيم</option>
                <option>تبوك</option><option>عسير</option><option>جازان</option>
                <option>نجران</option><option>الباحة</option><option>الجوف</option><option>الحدود الشمالية</option>
              </select>
            </div>
            <div class="field">
              <label>الصورة (واجهة المركبة)</label>
              <input type="file" id="vehFront" accept="image/*" />
            </div>
          </div>
        </div>

        <div class="card">
          <h4>بيانات السائق</h4>
          <div class="row">
            <div class="field"><label>الاسم الثلاثي</label><input id="driverName" placeholder="الاسم الكامل"/></div>
            <div class="field"><label>رقم الهوية</label><input id="nid" placeholder="10 أرقام" maxlength="10"/></div>
          </div>
          <div class="row">
            <div class="field"><label>رقم رخصة القيادة</label><input id="licenseNo" placeholder="رقم الرخصة"/></div>
            <div class="field"><label>تاريخ انتهاء الرخصة</label><input id="licenseExp" type="date"/></div>
          </div>
          <div class="row">
            <div class="field"><label>نسخة الرخصة (صورة)</label><input type="file" id="licenseImg" accept="image/*"/></div>
            <div class="field"><label>IBAN للحوالات</label><input id="iban" placeholder="SA.."/></div>
          </div>
          <div class="actions">
            <button class="btn primary" onclick="saveOwner()">حفظ التسجيل</button>
            <span class="muted" id="ownerSaved"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- Owners list (enabled overview) -->
    <section id="ownersList" class="card" hidden>
      <h3>قائمة الملاك <span class="badge" style="border-color:var(--ok);">مُفعلة ✅</span></h3>
      <div id="ownersTable" class="muted">لا يوجد مُلاك بعد.</div>
    </section>

    <!-- Services (all enabled) -->
    <section id="services" class="card" hidden>
      <h3>الخدمات <span class="badge" style="border-color:var(--ok);">مُفعلة بالكامل ✅</span></h3>
      <div id="servicesGrid" class="accounts"></div>
    </section>

    <!-- Drivers account -->
    <section id="driver" class="card" hidden>
      <h3>حساب السائق <span class="badge" style="border-color:var(--ok);">مُفعل ✅</span></h3>
      <div class="row">
        <div class="card">
          <h4>الملف الشخصي</h4>
          <div class="field"><label>الاسم</label><input id="dName" placeholder="اسم السائق"/></div>
          <div class="row">
            <div class="field"><label>الهاتف</label><input id="dPhone" placeholder="05xxxxxxxx"/></div>
            <div class="field"><label>المدينة</label><input id="dCity" placeholder="مثال: حائل"/></div>
          </div>
          <div class="row">
            <div class="field"><label>الرخصة (صورة)</label><input type="file" id="dLicenseFile" accept="image/*"/></div>
            <div class="field"><label>إقامة/هوية (صورة)</label><input type="file" id="dIdFile" accept="image/*"/></div>
          </div>
          <div class="actions">
            <button class="btn primary" onclick="saveDriver()">حفظ</button>
            <label class="tab" style="display:inline-flex;align-items:center;gap:6px">
              <input type="checkbox" id="availableToggle" onchange="toggleAvail()"/>
              متاح لاستلام الطلبات
            </label>
          </div>
          <div class="muted" id="driverSaved"></div>
        </div>
        <div class="card">
          <h4>طلبات قريبة</h4>
          <div class="muted">تظهر هنا الطلبات ضمن نطاق 10 كم (تجريبي).</div>
          <ul id="nearbyList"></ul>
          <div class="actions"><span class="muted">اختر طلبًا ثم اضغط قبول</span></div>
        </div>
      </div>
    </section>

    <!-- Admin -->
    <section id="admin" class="card" hidden>
      <h3>لوحة إدارة التطبيق <span class="badge" style="border-color:var(--ok);">مُفعلة ✅</span></h3>
      <div class="stats">
        <div class="stat"><div class="muted">عدد العملاء</div><b id="stUsers">0</b></div>
        <div class="stat"><div class="muted">طلبات اليوم</div><b id="stOrders">0</b></div>
        <div class="stat"><div class="muted">سائقون متاحون</div><b id="stDrivers">0</b></div>
        <div class="stat"><div class="muted">مركبات مسجلة</div><b id="stVehicles">0</b></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>إدارة المناطق والتسعير</h4>
        <div class="row">
          <div class="field"><label>تعرفة الكيلومتر (ريال)</label><input id="kmRate" type="number" step="0.5" value="3"/></div>
          <div class="field"><label>رسوم فتح الطلب (ريال)</label><input id="baseFee" type="number" step="1" value="20"/></div>
        </div>
        <div class="row">
          <div class="field"><label>سعر الكيلو للوزن الإضافي (ريال/كجم)</label><input id="perKg" type="number" step="0.1" value="0.5"/></div>
          <div class="field"><label>وزن مجاني مشمول (كجم)</label><input id="freeKg" type="number" step="1" value="50"/></div>
        </div>
        <div class="row">
          <div class="field"><label>مضاعف الحجم (صغير/متوسط/كبير)</label>
            <div class="inline-actions" style="gap:6px">
              <input id="mSmall" type="number" step="0.05" value="1" style="width:33%"/>
              <input id="mMedium" type="number" step="0.05" value="1.3" style="width:33%"/>
              <input id="mBig" type="number" step="0.05" value="1.8" style="width:33%"/>
            </div>
          </div>
          <div class="field"><label>مضاعف نوع الحمولة (صناديق/أثاث/أجهزة/مواد بناء/معدات)</label>
            <div class="inline-actions" style="gap:6px;flex-wrap:wrap">
              <input id="tBoxes" type="number" step="0.05" value="1" style="width:18%"/>
              <input id="tFurniture" type="number" step="0.05" value="1.15" style="width:18%"/>
              <input id="tAppliances" type="number" step="0.05" value="1.2" style="width:18%"/>
              <input id="tBuilding" type="number" step="0.05" value="1.3" style="width:18%"/>
              <input id="tEquipment" type="number" step="0.05" value="1.35" style="width:18%"/>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="field"><label>فترة التتبّع الحي (ثوانٍ)</label><input id="pollSec" type="number" min="4" step="1" value="8"/></div>
        </div>
        <div class="actions">
          <button class="btn primary" onclick="savePricing()">حفظ التسعير</button>
          <span class="muted" id="pricingSaved"></span>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>الخدمات (تفعيل/تعطيل)</h4>
        <div class="toolbar" style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px">
          <input id="svcSearch" placeholder="ابحث باسم الخدمة..." style="flex:1;min-width:200px;padding:12px;border-radius:12px;border:1px solid #dbe4ea"/>
          <div class="chips" id="svcCats" style="display:flex;gap:6px;flex-wrap:wrap">
            <button class="pill" data-cat="الكل">الكل</button>
            <button class="pill" data-cat="منزلي">منزلي</button>
            <button class="pill" data-cat="معدات">معدات</button>
            <button class="pill" data-cat="تجاري">تجاري</button>
            <button class="pill" data-cat="لوجستي">لوجستي</button>
            <button class="pill" data-cat="سريع">سريع</button>
          </div>
        </div>
        <div id="adminServices" class="service-grid"></div>
        <div class="muted" style="margin-top:6px">💡 يمكنك إعادة الترتيب بالسحب والإفلات. يتم الحفظ تلقائيًا.</div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>سجل الطلبات (تجريبي)</h4>
        <div id="adminOrders" class="muted">لا توجد بيانات.</div>
        <template id="orderRowTmpl">
          <div class="card" data-id="">
            <div><b class="from"></b> → <b class="to"></b> <span class="badge status"></span></div>
            <div class="muted time"></div>
            <div class="actions">
              <button class="btn" data-action="complete">إكمال</button>
              <button class="btn ghost" data-action="cancel">إلغاء</button>
            </div>
          </div>
        </template>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>اختبارات تلقائية</h4>
        <p class="muted">للتحقق من وظائف الملاحة والتبويبات وتدفق حالة الطلب.</p>
        <div id="testResults"></div>
        <div class="actions"><button class="btn" id="runTestsBtn">تشغيل الاختبارات</button></div>
      </div>
    </section>

  </main>

  <div class="toast" id="toast"></div>

  <!-- شريط تنقّل سفلي (أسلوب تطبيق جوال) -->
  <nav class="appTabs" role="navigation" aria-label="تبويب التطبيق">
    <button onclick="openView('landing')" id="tabHome"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10.5 12 3l9 7.5"/><path d="M9 21V12h6v9"/></svg><span>الرئيسية</span></button>
    <button onclick="openView('shipper')" id="tabShip"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="7" width="13" height="13" rx="2"/><path d="M16 13h5l-3-5h-2z"/></svg><span>العميل</span></button>
    <button onclick="openView('driver')" id="tabDrv"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 13h18"/><path d="M5 16h14"/><circle cx="7" cy="19" r="2"/><circle cx="17" cy="19" r="2"/></svg><span>السائق</span></button>
    <button onclick="openView('owner')" id="tabOwn"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="10" rx="3"/><path d="M7 7V5h10v2"/></svg><span>المالك</span></button>
    <button onclick="openView('admin')" id="tabAdm"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .7.4 1.3 1 1.6.3.2.6.4 1 .4a2 2 0 1 1 0 4c-.4 0-.7.2-1 .4-.6.3-1 .9-1 1.6z"/></svg><span>الإدارة</span></button>
  </nav>

  <footer class="container">
    <div>© وسيلة — نموذج أولي للاستخدام الداخلي.</div>
  </footer>

  <script>
    // ---- Simple state (global) ----
    const S = {
      orders: JSON.parse(localStorage.getItem('orders')||'[]'),
      owners: JSON.parse(localStorage.getItem('owners')||'[]'),
      drivers: JSON.parse(localStorage.getItem('drivers')||'[]'),
      pricing: JSON.parse(localStorage.getItem('pricing')||'{"kmRate":3,"baseFee":20,"perKg":0.5,"freeKg":50,"pollSec":8,"multipliers":{"size":{"small":1,"medium":1.3,"big":1.8},"type":{"boxes":1,"furniture":1.15,"appliances":1.2,"building":1.3,"equipment":1.35}}}'),
      services: JSON.parse(localStorage.getItem('services')||JSON.stringify([
        {key:'house_move', name:'نقل أثاث منزلي', cat:'منزلي', enabled:true},
        {key:'appliance',  name:'أجهزة كهربائية', cat:'منزلي', enabled:true},
        {key:'office',     name:'نقل مكتبي', cat:'تجاري', enabled:true},
        {key:'flatbed',    name:'سطحة/معدات', cat:'معدات', enabled:true},
        {key:'building',   name:'مواد بناء وحفر', cat:'معدات', enabled:true},
        {key:'landscape',  name:'تنسيق حدائق ونخيل', cat:'منزلي', enabled:true},
        {key:'event',      name:'تجهيز فعاليات ومعارض', cat:'تجاري', enabled:true},
        {key:'waste',      name:'مخلفات خفيفة ونقل أنقاض', cat:'معدات', enabled:true},
        {key:'store',      name:'توصيل من متجر/مستودع', cat:'تجاري', enabled:true},
        {key:'warehouse',  name:'مناولة بين المستودعات', cat:'لوجستي', enabled:true},
        {key:'long',       name:'نقل بين المدن', cat:'لوجستي', enabled:true},
        {key:'express',    name:'سريع داخل المدينة', cat:'سريع', enabled:true}
      ]))
    };
    // حالة الطلب: new, assigned, in_progress, completed, cancelled

    // ---- Helpers ----
    function val(id){return document.getElementById(id)?.value?.trim()||''}
    function byId(id){return document.getElementById(id)}
    function esc(s){return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}
    function mapStatus(s){ return s==='new'?'جديد': s==='assigned'?'مُسند': s==='in_progress'?'قيد التنفيذ': s==='completed'?'مكتمل': s==='cancelled'?'ملغي':'غير معروف'; }
    function persist(){ localStorage.setItem('orders', JSON.stringify(S.orders)); localStorage.setItem('owners', JSON.stringify(S.owners)); localStorage.setItem('drivers', JSON.stringify(S.drivers)); localStorage.setItem('pricing', JSON.stringify(S.pricing)); localStorage.setItem('services', JSON.stringify(S.services)); }

    // ---- Define openView EARLY ----
    window.openView = function openView(id){
      document.querySelectorAll('main > section').forEach(sec=>sec.hidden = true);
      const el = document.getElementById(id) || document.getElementById('landing');
      el.hidden = false;
      document.querySelectorAll('.appTabs button').forEach(b=>b.classList.remove('active'));
      const mapIdToBtn = {landing:'tabHome', shipper:'tabShip', driver:'tabDrv', owner:'tabOwn', admin:'tabAdm'};
      const btnId = mapIdToBtn[id]; if(btnId) document.getElementById(btnId).classList.add('active');
      if(id==='shipper' && typeof L!=='undefined' && window.map){
        setTimeout(()=>{ try{ window.map.invalidateSize(); if(window.mapState?.pickup && window.mapState?.dropoff){ drawRouteIfReady(); } }catch(_){} },0);
      }
      updateUI();
    }

    // ---- DOM bootstrap ----
    document.addEventListener('DOMContentLoaded', ()=>{
      // tabs behavior
      document.querySelectorAll('.tabs .tab').forEach(tab=>{ tab.addEventListener('click', ()=>{ const wrap = tab.closest('section'); wrap.querySelectorAll('.tabs .tab').forEach(t=>t.classList.remove('active')); tab.classList.add('active'); const target = tab.dataset.target; if(target){ wrap.querySelectorAll('#shipperBench,#shipper-orders').forEach(v=>v.hidden=true); const tgt = wrap.querySelector('#'+target); if(tgt){ tgt.closest('div').hidden=false; } } }); });

      // map ctrl buttons
      const fitBtn = document.getElementById('fitRouteBtn'); const recBtn = document.getElementById('recenterBtn'); if(fitBtn) fitBtn.addEventListener('click', fitToMarkersOrRoute); if(recBtn) recBtn.addEventListener('click', recenterMap);

      // map toggle
      const tgl = document.getElementById('toggleMapBtn'); if(tgl){ tgl.addEventListener('click',()=>{ document.body.classList.toggle('mapCollapsed'); }); }

      // boot
      history.replaceState(null, '', location.pathname); openView('landing'); initLeaflet(); updateUI();

      // listeners
      const q = document.getElementById('svcSearch'); if(q){ q.addEventListener('input', e=>{ window.__svcQuery = e.target.value.trim(); renderAdminServices(); }); }
      const chips = document.getElementById('svcCats'); if(chips){ chips.addEventListener('click', (e)=>{ const b=e.target.closest('button[data-cat]'); if(!b) return; window.__svcCat=b.dataset.cat; [...chips.querySelectorAll('button')].forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderAdminServices(); }); }
      const testBtn = document.getElementById('runTestsBtn'); if(testBtn){ testBtn.addEventListener('click', runTests); }

      // GPS buttons
      const gps = document.getElementById('useGPS'); if(gps){ gps.addEventListener('click', useMyLocation); }
      const gpsD = document.getElementById('useGPSDrop'); if(gpsD){ gpsD.addEventListener('click', useMyLocationDrop); }

      // Copy coord buttons
      const cP = document.getElementById('copyPickup'); if(cP){ cP.addEventListener('click', ()=>copyCoords('pickup')); }
      const cD = document.getElementById('copyDropoff'); if(cD){ cD.addEventListener('click', ()=>copyCoords('dropoff')); }

      // Live polling using configured interval
      let lastOrdersJSON = JSON.stringify(S.orders);
      const pollMs = Math.max(4000, (S.pricing.pollSec||8)*1000);
      setInterval(()=>{
        try{
          const nowOrders = JSON.parse(localStorage.getItem('orders')||'[]');
          const js = JSON.stringify(nowOrders);
          if(js!==lastOrdersJSON){ S.orders = nowOrders; lastOrdersJSON = js; updateUI(); }
        }catch(_){/* ignore */}
      }, pollMs);
    });

      const q = document.getElementById('svcSearch'); if(q){ q.addEventListener('input', e=>{ window.__svcQuery = e.target.value.trim(); renderAdminServices(); }); }
      const chips = document.getElementById('svcCats'); if(chips){ chips.addEventListener('click', (e)=>{ const b=e.target.closest('button[data-cat]'); if(!b) return; window.__svcCat=b.dataset.cat; [...chips.querySelectorAll('button')].forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderAdminServices(); }); }

      const testBtn = document.getElementById('runTestsBtn'); if(testBtn){ testBtn.addEventListener('click', runTests); }
    });
          wrap.querySelectorAll('.tabs .tab').forEach(t=>t.classList.remove('active'));
          tab.classList.add('active');
          const target = tab.dataset.target;
          if(target){
            wrap.querySelectorAll('#shipperBench,#shipper-orders').forEach(v=>v.hidden=true);
            const tgt = wrap.querySelector('#'+target);
            if(tgt){ tgt.closest('div').hidden=false; }
          }
        });
      });

      // map ctrl buttons
      const fitBtn = document.getElementById('fitRouteBtn');
      const recBtn = document.getElementById('recenterBtn');
      if(fitBtn) fitBtn.addEventListener('click', fitToMarkersOrRoute);
      if(recBtn) recBtn.addEventListener('click', recenterMap);

      // map toggle
      const tgl = document.getElementById('toggleMapBtn');
      if(tgl){ tgl.addEventListener('click',()=>{ document.body.classList.toggle('mapCollapsed'); }); }

      // boot
      history.replaceState(null, '', location.pathname);
      openView('landing');
      initLeaflet();
      updateUI();

      // services toolbar listeners
      const q = document.getElementById('svcSearch');
      if(q){ q.addEventListener('input', e=>{ window.__svcQuery = e.target.value.trim(); renderAdminServices(); }); }
      const chips = document.getElementById('svcCats');
      if(chips){ chips.addEventListener('click', (e)=>{ const b=e.target.closest('button[data-cat]'); if(!b) return; window.__svcCat=b.dataset.cat; [...chips.querySelectorAll('button')].forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderAdminServices(); }); }

      const testBtn = document.getElementById('runTestsBtn');
      if(testBtn){ testBtn.addEventListener('click', runTests); }
    });

    // ---- Pricing & Orders ----
    function kmBetween(){
      if(window.mapState?.pickup && window.mapState?.dropoff){
        const {pickup, dropoff} = window.mapState;
        const R = 6371; const toRad = d => d*Math.PI/180;
        const dLat = toRad(dropoff.lat - pickup.lat);
        const dLon = toRad(dropoff.lng - pickup.lng);
        const a = Math.sin(dLat/2)**2 + Math.cos(toRad(pickup.lat))*Math.cos(toRad(dropoff.lat))*Math.sin(dLon/2)**2;
        const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return Math.max(1, Math.round(R*c));
      }
      return 2 + Math.round(Math.random()*12);
    }

    function estimate(){
      const km = (typeof lastRouteKm==='number' && lastRouteKm>0) ? Math.round(lastRouteKm) : kmBetween();
      const r = S.pricing.kmRate || 3; const base = S.pricing.baseFee || 20;
      const size = byId('cargoSize')?.value||'small';
      const type = byId('cargoType')?.value||'boxes';
      const weight = +byId('weightKg')?.value||0;
      const ms = S.pricing.multipliers?.size || {small:1,medium:1.3,big:1.8};
      const mt = S.pricing.multipliers?.type || {boxes:1,furniture:1.15,appliances:1.2,building:1.3,equipment:1.35};
      const multSize = ms[size] ?? 1;
      const multType = mt[type] ?? 1;
      const extraW = Math.max(0, weight - (S.pricing.freeKg||50));
      const weightFee = extraW * (S.pricing.perKg||0.5);
      const price = Math.round((base + km*r)*multSize*multType + weightFee);
      const eta = (typeof lastRouteETAmin==='number')? ` — زمن تقديري ~ ${Math.max(1,Math.round(lastRouteETAmin))} دقيقة` : '';
      byId('estimateOut').textContent = `تقدير: ~ ${price} ريال لمسافة ${km} كم${eta}`;
      return price;
    }

    function submitOrder(){
      const svcSel = document.getElementById('serviceType');
      const service = svcSel ? (svcSel.value || '') : '';
      const data = {
        pickup: val('pickup'), dropoff: val('dropoff'), when: val('when'), notes: val('notes'),
        size: val('cargoSize'), cargoType: val('cargoType'), weightKg: +(val('weightKg')||0), service,
        price: estimate(), id: Date.now(), status: 'new', driverId: null
      };
      if(!data.pickup||!data.dropoff){alert('يرجى إدخال الاستلام والتسليم');return}
      S.orders.unshift(data); persist();
      document.getElementById('estimateOut').textContent = 'تم إرسال الطلب.';
      updateUI();
      const tab = document.querySelector('#shipper .tabs .tab[data-target="shipper-orders"]'); if(tab) tab.click();
    }

    function saveOwner(){
      const rec = {
        vehType: val('vehType'), plate: val('plate'), modelYear: val('modelYear'), region: val('region'),
        driverName: val('driverName'), nid: val('nid'), licenseNo: val('licenseNo'), licenseExp: val('licenseExp'), iban: val('iban'),
        id: Date.now()
      };
      S.owners.unshift(rec); persist();
      byId('ownerSaved').textContent = 'تم الحفظ.'; updateUI();
    }

    function saveDriver(){
      const d = {name: val('dName'), phone: val('dPhone'), city: val('dCity'), available: byId('availableToggle').checked, id: Date.now()};
      S.drivers.unshift(d); persist();
      byId('driverSaved').textContent = 'تم الحفظ.'; updateUI();
    }

    function toggleAvail(){updateUI()}

    function savePricing(){
      S.pricing = {
        kmRate: +val('kmRate')||3,
        baseFee: +val('baseFee')||20,
        perKg: +val('perKg')||0.5,
        freeKg: +val('freeKg')||50,
        pollSec: +val('pollSec')||8,
        multipliers: {
          size: {
            small: +val('mSmall')||1,
            medium: +val('mMedium')||1.3,
            big: +val('mBig')||1.8
          },
          type: {
            boxes: +val('tBoxes')||1,
            furniture: +val('tFurniture')||1.15,
            appliances: +val('tAppliances')||1.2,
            building: +val('tBuilding')||1.3,
            equipment: +val('tEquipment')||1.35
          }
        }
      };
      persist(); byId('pricingSaved').textContent = 'تم تحديث التسعير.';
    }; persist(); byId('pricingSaved').textContent = 'تم تحديث التسعير.'; }

    function driverAccept(orderId){
      const d = S.drivers[0];
      const o = S.orders.find(x=>x.id===orderId);
      if(!o) return;
      o.driverId = d? d.id : null; o.status = 'in_progress'; persist(); updateUI();
      try{ localStorage.setItem('orders', JSON.stringify(S.orders)); }catch(_){}
      alert('تم قبول الطلب والبدء في تنفيذه');
    }

    function labelOf(key){ const f = S.services.find(s=>s.key===key); return f?f.name:key; }

    // ---- UI rendering ----
    function updateUI(){
      // services in shipper form
      const svcSel = byId('serviceType'); if(svcSel){ const enabled = S.services.filter(s=>s.enabled); svcSel.innerHTML = enabled.map(s=>`<option value="${s.key}">${s.name}</option>`).join(''); if(!enabled.length){ svcSel.innerHTML = '<option disabled>لا توجد خدمات مفعلة</option>'; } }

      // pricing inputs reflect state
      const kmRate=byId('kmRate'), baseFee=byId('baseFee'), perKg=byId('perKg'), freeKg=byId('freeKg');
      if(kmRate) kmRate.value = S.pricing.kmRate||3;
      if(baseFee) baseFee.value = S.pricing.baseFee||20;
      if(perKg) perKg.value = S.pricing.perKg||0.5;
      if(freeKg) freeKg.value = S.pricing.freeKg||50;

      // services grid
      const svcGrid = byId('servicesGrid'); if(svcGrid){ svcGrid.innerHTML = S.services.map(s=>`<div class=\"card\"><div style=\"display:flex;align-items:center;justify-content:space-between;gap:8px\"><b>${s.name}</b><span class=\"badge\" style=\"border-color:${s.enabled?'#a7f3d0':'#fecaca'}\">${s.enabled?'مُفعّل':'معطّل'}</span></div></div>`).join(''); }

      // Admin services
      const adminSvc = byId('adminServices'); if(adminSvc){ renderAdminServices(); }

      // Admin stats
      byId('stUsers').textContent = Math.max(1, Math.ceil(S.orders.length/2));
      byId('stOrders').textContent = S.orders.slice(0,10).length;
      byId('stDrivers').textContent = S.drivers.filter(d=>d.available).length;
      byId('stVehicles').textContent = S.owners.length;

      // Admin orders table
      const adminOrders = byId('adminOrders');
      if(adminOrders){
        if(!S.orders.length) adminOrders.textContent = 'لا توجد بيانات.'; else{
          adminOrders.innerHTML = '';
          S.orders.forEach(o=>{
            const row = document.getElementById('orderRowTmpl').content.cloneNode(true);
            const root = row.querySelector('.card');
            root.dataset.id = o.id;
            row.querySelector('.from').textContent = o.pickup;
            row.querySelector('.to').textContent = o.dropoff;
            row.querySelector('.time').textContent = new Date(o.id).toLocaleString('ar-SA');
            const stEl = row.querySelector('.status'); stEl.textContent = mapStatus(o.status);
            if(o.status==='completed'||o.status==='cancelled'){ row.querySelector('[data-action="complete"]').disabled = true; }
            row.querySelector('[data-action="complete"]').addEventListener('click',()=>{ o.status='completed'; persist(); updateUI();});
            row.querySelector('[data-action="cancel"]').addEventListener('click',()=>{ o.status='cancelled'; persist(); updateUI();});
            adminOrders.appendChild(row);
          });
        }
      }

      // Nearby for driver (last 5 new)
      const near = byId('nearbyList');
      if(near){
        const avail = S.orders.filter(o=>o.status==='new').slice(0,5);
        if(!avail.length) near.innerHTML = '<li class="muted">لا توجد طلبات قريبة الآن.</li>';
        else{
          near.innerHTML = avail.map(o=>`<li class=\"card\" style=\"margin:6px 0;padding:10px\"><b>${esc(o.pickup)}</b> → <b>${esc(o.dropoff)}</b>${o.service?` — <span class=\\\"badge\\\">${esc(labelOf(o.service))}</span>`:''}<br><span class=\"muted\">~${o.price} ر.س</span><div class=\"actions\"><button class=\"btn primary\" onclick=\"driverAccept(${o.id})\">قبول</button></div></li>`).join('');
        }
      }

      // Owners table
      const ownersHost = byId('ownersTable');
      if(ownersHost){
        if(!S.owners.length) ownersHost.textContent = 'لا يوجد مُلاك بعد.'; else{
          ownersHost.innerHTML = S.owners.map(o=>`<div class=\"card\" style=\"margin:6px 0\"><b>${esc(o.driverName)}</b> — ${esc(o.vehType)} | ${esc(o.region)} <span class=\"muted\">${esc(o.plate)}</span></div>`).join('');
        }
      }
    }

    // ===== Admin services rendering + filters + drag&drop =====
    window.__svcQuery = '';
    window.__svcCat = 'الكل';

    // ensure categories exist for older storage
    S.services = S.services.map(s=>({...s, cat: s.cat || mapCategory(s.key)}));

    function mapCategory(key){
      if(['house_move','appliance','landscape'].includes(key)) return 'منزلي';
      if(['office','event','store'].includes(key)) return 'تجاري';
      if(['flatbed','building','waste'].includes(key)) return 'معدات';
      if(['warehouse','long'].includes(key)) return 'لوجستي';
      if(['express'].includes(key)) return 'سريع';
      return 'أخرى';
    }

    function filteredServices(){
      const q = (window.__svcQuery||'').toLowerCase();
      const cat = window.__svcCat||'الكل';
      return S.services.filter(s=>{
        const matchesQ = !q || s.name.toLowerCase().includes(q) || s.key.toLowerCase().includes(q);
        const matchesC = cat==='الكل' || s.cat===cat;
        return matchesQ && matchesC;
      });
    }

    function renderAdminServices(){
      const host = document.getElementById('adminServices'); if(!host) return;
      const groups = {};
      filteredServices().forEach((s,idx)=>{ const g=s.cat||'أخرى'; (groups[g]=groups[g]||[]).push({s, idx}); });
      host.innerHTML = Object.keys(groups).sort((a,b)=>a.localeCompare(b,'ar')).map(g=>{
        const items = groups[g].map(({s,idx})=>serviceCardHTML(s, idx)).join('');
        return `<div class=\"svc-group\"><h5>${g}</h5>${items}</div>`;
      }).join('');
      bindServiceCardDnD(host);
    }

    function serviceCardHTML(s, idx){
      const letter = s.name.trim().charAt(0);
      const id = `svc_${idx}`;
      return `<div class=\"service-card\" draggable=\"true\" data-index=\"${idx}\" aria-grabbed=\"false\">\n        <div class=\"ico\" aria-hidden=\"true\">${letter}</div>\n        <div class=\"meta\"><b title=\"${s.name}\">${s.name}</b><div class=\"muted\">${s.key}</div></div>\n        <label class=\"switch\" for=\"${id}\">\n          <input id=\"${id}\" type=\"checkbox\" ${s.enabled?'checked':''} onchange=\"toggleService(${idx}, this.checked)\" aria-label=\"تفعيل ${s.name}\" />\n        </label>\n        <span class=\"badge ${s.enabled?'on':'off'}\">${s.enabled?'مُفعّل':'معطّل'}</span>\n      </div>`
    }

    function bindServiceCardDnD(root){
      const cards=[...root.querySelectorAll('.service-card')];
      let dragIndex=null;
      cards.forEach(card=>{
        card.addEventListener('dragstart', (e)=>{ dragIndex=+card.dataset.index; card.style.opacity=.6; e.dataTransfer.effectAllowed='move'; });
        card.addEventListener('dragend', ()=>{ card.style.opacity=''; });
        card.addEventListener('dragover', (e)=>{ e.preventDefault(); e.dataTransfer.dropEffect='move'; });
        card.addEventListener('drop', (e)=>{
          e.preventDefault();
          const toIndex = +card.dataset.index;
          if(Number.isFinite(dragIndex) && Number.isFinite(toIndex) && dragIndex!==toIndex){
            const [moved] = S.services.splice(dragIndex,1);
            S.services.splice(toIndex,0,moved);
            persist();
            renderAdminServices();
          }
        });
      });
    }

    function toggleService(i, val){ S.services[i].enabled = !!val; persist(); updateUI(); }

    // ---- Minimal front-end test cases (unchanged logic, cleaned) ----
    function runTests(){
      const results = [];
      const assert = (name, cond) => results.push({اختبار:name, النتيجة: cond? 'PASS':'FAIL'});
      try{
        assert('تعريف openView', typeof window.openView === 'function');
        const ids = ['landing','shipper','owner','driver','admin','ownersList'];
        ids.forEach(id=>{ window.openView(id); const sec = document.getElementById(id); assert(`إظهار القسم ${id}`, sec && sec.hidden===false); });
        location.hash = '#owner'; window.dispatchEvent(new HashChangeEvent('hashchange')); assert('المسار بالهاش يعمل', !document.getElementById('owner').hidden);
        window.openView('shipper');
        const newTab = document.querySelector('#shipper .tabs .tab[data-target="shipper-orders"]'); if(newTab){ newTab.click(); }
        assert('التبديل إلى تبويب "طلباتي"', document.getElementById('shipper-orders').hidden===false);
        const preCount = S.orders.length;
        S.orders.unshift({id: Date.now()+1, pickup:'اختبار أ', dropoff:'اختبار ب', size:'small', price:50, status:'new', driverId:null}); persist();
        assert('إضافة طلب اختباري', S.orders.length===preCount+1);
        const newId = S.orders[0].id; driverAccept(newId); assert('قبول السائق للطلب', S.orders[0].status==='in_progress');
        S.orders[0].status='completed'; persist(); assert('إكمال الطلب', S.orders[0].status==='completed');
        updateUI();
        // إدارة: فلترة وترتيب
        window.__svcQuery = 'نقل'; const before = filteredServices().length; assert('فلترة الخدمات بالكلمة تعمل', before>0);
        window.__svcCat = 'معدات'; const onlyEquip = filteredServices().every(s=>s.cat==='معدات'); assert('تصفية حسب الفئة تعمل', onlyEquip);
        // محاكاة إعادة ترتيب
        const len=S.services.length; const first=S.services[0]; S.services.splice(0,1); S.services.splice(2,0,first); persist(); assert('إعادة ترتيب الخدمات بالذاكرة', S.services.length===len && S.services[2]===first);
      }catch(e){ console.error('Test error:', e); }
      const host = document.getElementById('testResults');
      if(host){ host.innerHTML = '<div class="badge">نتائج</div>' + '<pre style="white-space:pre-wrap">'+results.map(r=>`${r.اختبار}: ${r.النتيجة}`).join('\n')+'</pre>'; }
      console.table(results);
      window.openView('landing');
    }

    // ===== Leaflet integration =====
    let map, pickupMarker, dropoffMarker, routeLine;
    let lastRouteKm = null, lastRouteETAmin = null; // مخرجات OSRM عند توفرها 
    window.mapState = {pickup:null, dropoff:null};

    function initLeaflet(){
      if(typeof L === 'undefined'){ console.warn('Leaflet not loaded'); return; }
      if(map){ return; }
      // load stored view if any
      const stored = JSON.parse(localStorage.getItem('mapView')||'null');
      const center = stored?.center || [24.7136,46.6753];
      const zoom = stored?.zoom || 11;
      map = L.map('leafletMap', { zoomControl: true, attributionControl: true }).setView(center, zoom);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' }).addTo(map);
      // persist view on move
      map.on('moveend', ()=>{ const c = map.getCenter(); localStorage.setItem('mapView', JSON.stringify({center:[c.lat,c.lng], zoom: map.getZoom()})); });

      // custom divIcon as truck badge
      const truckSVG = `<?xml version="1.0"?><svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 128 64'><defs><linearGradient id='t' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='#23c7c2'/><stop offset='1' stop-color='#7ce7e2'/></linearGradient></defs><rect x='0' y='40' width='128' height='8' rx='4' fill='#cffafe'/><path d='M6 40h82c3 0 5-2 5-5v-7c0-1.2-.9-2.8-1.9-3.7l-10.5-9.6A6 6 0 0 0 76 12H58a4 4 0 0 0-4 4v6H24a10 10 0 0 0-10 10v8z' fill='url(#t)'/><circle cx='32' cy='47' r='8' fill='#0ea5a4'/><circle cx='32' cy='47' r='3.8' fill='#ecfeff'/><circle cx='96' cy='47' r='8' fill='#0ea5a4'/><circle cx='96' cy='47' r='3.8' fill='#ecfeff'/></svg>`;
      window.__truckIcon = L.divIcon({ className:'', html:`<div class="glass" style="padding:6px;border-radius:12px">${truckSVG}</div>` , iconSize:[36,36], iconAnchor:[18,18] });
      window.__dropIcon  = L.divIcon({ className:'', html:`<div class="glass" style="padding:6px;border-radius:12px;transform:scale(.95)">${truckSVG}</div>` , iconSize:[36,36], iconAnchor:[18,18] });

      map.on('click', (e)=>{
        if(!window.mapPickMode) return;
        const {lat,lng} = e.latlng;
        if(window.mapPickMode==='pickup') setPickup(lat,lng, window.__truckIcon);
        else if(window.mapPickMode==='dropoff') setDropoff(lat,lng, window.__dropIcon);
        exitMapPickMode();
        drawRouteIfReady();
        if(!(window.mapState.pickup && window.mapState.dropoff)){
          const p = window.mapState.pickup || window.mapState.dropoff; if(p && map){ map.setView([p.lat,p.lng], Math.max(14, map.getZoom())); }
        }
      });

      // bind pick buttons now that DOM exists
      const pp = document.getElementById('pickPickup');
      const pd = document.getElementById('pickDropoff');
      if(pp) pp.addEventListener('click', ()=>enterMapPickMode('pickup'));
      if(pd) pd.addEventListener('click', ()=>enterMapPickMode('dropoff'));
    }

    function enterMapPickMode(which){ window.mapPickMode = which; document.getElementById(which==='pickup'?'pickPickup':'pickDropoff').classList.add('active'); }
    function exitMapPickMode(){ ['pickPickup','pickDropoff'].forEach(id=>document.getElementById(id)?.classList.remove('active')); window.mapPickMode = null; }

    function setPickup(lat,lng, icon){
      window.mapState.pickup = {lat,lng}; if(!map) return;
      if(pickupMarker){ pickupMarker.setLatLng([lat,lng]); }
      else{ pickupMarker = L.marker([lat,lng], {icon: icon||window.__truckIcon, draggable:true}).addTo(map);
            pickupMarker.on('dragend', (ev)=>{ const p=ev.target.getLatLng(); window.mapState.pickup={lat:p.lat,lng:p.lng}; reverseGeocode(p.lat,p.lng,'pickup','pickupHint'); drawRouteIfReady(); }); }
      document.getElementById('pickupHint').textContent = `تم التحديد (${lat.toFixed(5)}, ${lng.toFixed(5)})`;
      reverseGeocode(lat,lng,'pickup','pickupHint');
      if(!(window.mapState.dropoff)){ map.setView([lat,lng], Math.max(14, map.getZoom())); }
    }{
      window.mapState.pickup = {lat,lng}; if(!map) return;
      if(pickupMarker){ pickupMarker.setLatLng([lat,lng]); }
      else{ pickupMarker = L.marker([lat,lng], {icon: icon||window.__truckIcon, draggable:true}).addTo(map);
            pickupMarker.on('dragend', (ev)=>{ const p=ev.target.getLatLng(); window.mapState.pickup={lat:p.lat,lng:p.lng}; document.getElementById('pickupHint').textContent = `تم التعديل (${p.lat.toFixed(5)}, ${p.lng.toFixed(5)})`; drawRouteIfReady(); }); }
      document.getElementById('pickupHint').textContent = `تم التحديد (${lat.toFixed(5)}, ${lng.toFixed(5)})`;
      if(!(window.mapState.dropoff)){ map.setView([lat,lng], Math.max(14, map.getZoom())); }
    }

    function setDropoff(lat,lng, icon){
      window.mapState.dropoff = {lat,lng}; if(!map) return;
      if(dropoffMarker){ dropoffMarker.setLatLng([lat,lng]); }
      else{ dropoffMarker = L.marker([lat,lng], {icon: icon||window.__dropIcon, draggable:true}).addTo(map);
            dropoffMarker.on('dragend', (ev)=>{ const p=ev.target.getLatLng(); window.mapState.dropoff={lat:p.lat,lng:p.lng}; reverseGeocode(p.lat,p.lng,'dropoff','dropoffHint'); drawRouteIfReady(); }); }
      document.getElementById('dropoffHint').textContent = `تم التحديد (${lat.toFixed(5)}, ${lng.toFixed(5)})`;
      reverseGeocode(lat,lng,'dropoff','dropoffHint');
      if(!(window.mapState.pickup)){ map.setView([lat,lng], Math.max(14, map.getZoom())); }
    }{
      window.mapState.dropoff = {lat,lng}; if(!map) return;
      if(dropoffMarker){ dropoffMarker.setLatLng([lat,lng]); }
      else{ dropoffMarker = L.marker([lat,lng], {icon: icon||window.__dropIcon, draggable:true}).addTo(map);
            dropoffMarker.on('dragend', (ev)=>{ const p=ev.target.getLatLng(); window.mapState.dropoff={lat:p.lat,lng:p.lng}; document.getElementById('dropoffHint').textContent = `تم التعديل (${p.lat.toFixed(5)}, ${p.lng.toFixed(5)})`; drawRouteIfReady(); }); }
      document.getElementById('dropoffHint').textContent = `تم التحديد (${lat.toFixed(5)}, ${lng.toFixed(5)})`;
      if(!(window.mapState.pickup)){ map.setView([lat,lng], Math.max(14, map.getZoom())); }
    }

    async function drawRouteIfReady(){
      const a = window.mapState.pickup, b = window.mapState.dropoff; if(!a||!b||!map) return;
      try{
        const url = `https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
        const res = await fetch(url, {headers:{'Accept':'application/json'}});
        const j = await res.json();
        if(j && j.routes && j.routes[0]){
          const r = j.routes[0];
          lastRouteKm = r.distance/1000; lastRouteETAmin = r.duration/60;
          const geo = L.geoJSON(r.geometry, {style:{weight:6, opacity:.95, color:'#23c7c2'}});
          if(routeLine){ map.removeLayer(routeLine); }
          routeLine = geo.addTo(map);
          map.fitBounds(geo.getBounds(), { padding:[30,30] });
          document.getElementById('estimateOut').textContent = `المسافة التقريبية: ~ ${Math.round(lastRouteKm)} كم — زمن ~ ${Math.max(1,Math.round(lastRouteETAmin))} دقيقة`;
          return;
        }
      }catch(e){ console.warn('OSRM failed, fallback to straight line', e); }
      // fallback إلى خط مستقيم
      const latlngs = [ [a.lat,a.lng], [b.lat,b.lng] ];
      if(routeLine){ routeLine.setLatLngs(latlngs); } else { routeLine = L.polyline(latlngs, {weight:6, opacity:.95, color:'#23c7c2'}).addTo(map); }
      map.fitBounds(routeLine.getBounds(), { padding:[30,30] });
      lastRouteKm = kmBetween(); lastRouteETAmin = null;
      document.getElementById('estimateOut').textContent = `المسافة التقريبية: ~ ${lastRouteKm} كم`;
    }
      else { routeLine = L.polyline(latlngs, {weight:6, opacity:.95, color:'#23c7c2'}).addTo(map); }
      map.fitBounds(routeLine.getBounds(), { padding:[30,30] });
      document.getElementById('estimateOut').textContent = `المسافة التقريبية: ~ ${kmBetween()} كم`;
    }

    function fitToMarkersOrRoute(){
      const a = window.mapState?.pickup, b = window.mapState?.dropoff;
      if(a && b && routeLine){ map.fitBounds(routeLine.getBounds(), {padding:[30,30]}); return; }
      if(a){ map.setView([a.lat,a.lng], Math.max(14, map.getZoom())); return; }
      if(b){ map.setView([b.lat,b.lng], Math.max(14, map.getZoom())); return; }
      const stored = JSON.parse(localStorage.getItem('mapView')||'null'); if(stored?.center){ map.setView(stored.center, stored.zoom||11); }
    }
    function recenterMap(){ const stored = JSON.parse(localStorage.getItem('mapView')||'null'); if(stored?.center){ map.setView(stored.center, stored.zoom||11); } else { map.setView([24.7136,46.6753], 11); } }
      async function reverseGeocode(lat,lng, fieldId, hintId){
      try{
        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&accept-language=ar&zoom=18`;
        const res = await fetch(url, {headers:{'Accept':'application/json'}});
        const j = await res.json();
        const txt = j && (j.display_name || j.name);
        if(txt){ const fld = document.getElementById(fieldId); if(fld && (!fld.value||fld.value.length<5)) fld.value = txt; const hint = document.getElementById(hintId); if(hint){ hint.textContent = txt; } }
      }catch(e){ /* صامت */ }
    }

    function toast(msg){ const t=document.getElementById('toast'); if(!t) return; t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }
      function useMyLocation(){
      if(!navigator.geolocation){ alert('المتصفح لا يدعم تحديد الموقع'); return; }
      navigator.geolocation.getCurrentPosition((pos)=>{
        const {latitude:lat, longitude:lng} = pos.coords;
        if(map){ map.setView([lat,lng], 14); }
        setPickup(lat,lng);
        reverseGeocode(lat,lng,'pickup','pickupHint');
        drawRouteIfReady();
      }, (err)=>{ alert('تعذّر الحصول على الموقع: '+ err.message); }, {enableHighAccuracy:true, timeout:8000, maximumAge:0});
    }

    // === اختبارات إضافية بسيطة ===
    (function(){ try{
      console.assert(typeof estimate==='function','estimate موجودة');
      const p0=S.pricing.kmRate; S.pricing.kmRate=5; const t1=estimate(); S.pricing.kmRate=p0; console.assert(typeof t1==='number','estimate تُعيد رقم');
    }catch(_){} })();
      function useMyLocation(){
      if(!navigator.geolocation){ alert('المتصفح لا يدعم تحديد الموقع'); return; }
      navigator.geolocation.getCurrentPosition((pos)=>{
        const {latitude:lat, longitude:lng} = pos.coords;
        if(map){ map.setView([lat,lng], 14); }
        setPickup(lat,lng); reverseGeocode(lat,lng,'pickup','pickupHint'); drawRouteIfReady();
      }, (err)=>{ alert('تعذّر الحصول على الموقع: '+ err.message); }, {enableHighAccuracy:true, timeout:8000, maximumAge:0});
    }
    function useMyLocationDrop(){
      if(!navigator.geolocation){ alert('المتصفح لا يدعم تحديد الموقع'); return; }
      navigator.geolocation.getCurrentPosition((pos)=>{
        const {latitude:lat, longitude:lng} = pos.coords;
        if(map){ map.setView([lat,lng], 14); }
        setDropoff(lat,lng); reverseGeocode(lat,lng,'dropoff','dropoffHint'); drawRouteIfReady();
      }, (err)=>{ alert('تعذّر الحصول على الموقع: '+ err.message); }, {enableHighAccuracy:true, timeout:8000, maximumAge:0});
    }
    function copyCoords(which){
      const p = which==='pickup'? window.mapState.pickup : window.mapState.dropoff;
      if(!p){ alert('لم يتم تحديد النقطة بعد'); return; }
      const txt = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`;
      navigator.clipboard?.writeText(txt).then(()=>toast('تم نسخ الإحداثيات')).catch(()=>alert(txt));
    }
  </script>
</body>
</html>
