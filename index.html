<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ÙˆØ³ÙŠÙ„Ø© â€” Ù†Ù…ÙˆØ°Ø¬ Ø£ÙˆÙ„ÙŠ Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</title>
  <meta name="theme-color" content="#23c7c2" />
  <style>
    :root{
      --bg:#f6fbfc; --card:#ffffff; --muted:#667085; --text:#0f172a;
      --brand:#23c7c2; --brand-2:#7ce7e2; --danger:#ef4444; --ok:#16a34a; --warn:#f59e0b;
      --b:#e5e7eb; --ring:#22d3ee; --shadow: 0 6px 24px rgba(14,165,233,.12), 0 2px 8px rgba(2,132,199,.08);
      --radius:16px; --navH:64px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#fff 65%,#f5ffff);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Naskh Arabic",Tahoma,sans-serif}
    a{color:inherit}
    .container{max-width:980px;margin:auto;padding:16px;padding-bottom:calc(16px + var(--navH));}
    header{position:sticky;top:0;background:rgba(255,255,255,.92);backdrop-filter:blur(10px);z-index:50;border-bottom:1px solid var(--b)}
    .brand{display:flex;gap:12px;align-items:center}
    .logoBox{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(180deg,var(--brand-2),var(--brand));box-shadow:var(--shadow)}
    .title{font-weight:800;letter-spacing:.1px}

    .card{background:var(--card);border:1px solid var(--b);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
    .card h3{margin:0 0 10px 0}

    .accounts{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(min-width:860px){.accounts{grid-template-columns:repeat(4,1fr)}}

    .btn{width:100%;padding:16px;border-radius:14px;border:1px solid #cbd5e1;background:#ffffff;cursor:pointer;color:var(--text);font-weight:800}
    .btn:hover{border-color:var(--brand)}
    .primary{background:linear-gradient(180deg,var(--brand),var(--brand-2));border:none;color:#063a3a}
    .ghost{background:transparent;border:1px dashed #cbd5e1}

    .workbench{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:1000px){.workbench{grid-template-columns:1fr 420px}}

    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:680px){.row{grid-template-columns:1fr 1fr}}
    .field{display:grid;gap:6px;margin-bottom:10px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;padding:14px;border-radius:12px;background:#ffffff;border:1px solid #dbe4ea;color:var(--text)}
    input:focus,select:focus,textarea:focus{outline:none;border-color:#99f6e4;box-shadow:0 0 0 6px rgba(34,211,238,.18)}
    .muted{color:var(--muted);font-size:13px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 12px}
    .tab{padding:10px 14px;border-radius:999px;border:1px solid #cbd5e1;background:#ffffff;cursor:pointer;font-weight:800}
    .tab.active{border-color:#67e8f9;box-shadow:0 0 0 6px rgba(103,232,249,.2)}

    .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media(min-width:860px){.stats{grid-template-columns:repeat(4,1fr)}}
    .stat{padding:14px;border-radius:12px;border:1px solid var(--b);background:#ffffff;box-shadow:var(--shadow)}
    .stat b{font-size:22px}

    footer{margin:24px 0 12px;color:#6b7280;font-size:12px}

    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #d1e4ea;background:#f8ffff}

    /* Ø´Ø±ÙŠØ· ØªÙ†Ù‚Ù‘Ù„ Ø³ÙÙ„ÙŠ Ø¨Ø£Ø³Ù„ÙˆØ¨ ØªØ·Ø¨ÙŠÙ‚ Ø¬ÙˆØ§Ù„ */
    .appTabs{position:fixed;inset-inline:0;bottom:0;height:var(--navH);background:#fff;border-top:1px solid var(--b);display:flex;z-index:60}
    .appTabs button{flex:1;border:0;background:transparent;font-weight:800;color:#0f172a;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px}
    .appTabs button .ico{width:22px;height:22px}
    .appTabs button.active{color:#0b6b6b}

    /* Leaflet map sizing + glass look */
    .mapWrap{position:relative;min-height:380px;border-radius:var(--radius);overflow:hidden;border:1px solid var(--b);background:#eefbfd;box-shadow:var(--shadow)}
    .leaflet-map{position:absolute;inset:0}
    .glass{background:rgba(255,255,255,.75);backdrop-filter:blur(10px);border:1px solid var(--b);box-shadow:var(--shadow);border-radius:12px}
    .field .inline-actions{display:flex;gap:8px;flex-wrap:wrap}
    .pill{padding:8px 12px;border-radius:999px;border:1px solid #cbd5e1;background:#fff;cursor:pointer;font-weight:700}
    .pill.active{border-color:#67e8f9;box-shadow:0 0 0 6px rgba(103,232,249,.2)}
    .pill.primary{background:linear-gradient(180deg,var(--brand),var(--brand-2));border:0;color:#063a3a}

    /* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù„Ø¬ÙˆØ§Ù„ */
    .service-grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:480px){.service-grid{grid-template-columns:1fr 1fr}}
    @media(min-width:860px){.service-grid{grid-template-columns:1fr 1fr 1fr}}
    .service-card{display:flex;align-items:center;gap:12px;padding:14px;border:1px solid var(--b);border-radius:14px;background:#fff;box-shadow:var(--shadow)}
    .service-card .ico{width:36px;height:36px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(180deg,var(--brand-2),var(--brand));color:#063a3a;font-weight:900}
    .service-card .meta{flex:1;min-width:0}
    .service-card .meta b{display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .service-card .meta .muted{font-size:12px}
    .switch{position:relative;display:inline-flex;align-items:center;gap:8px;cursor:pointer;font-weight:800}
    .switch input{appearance:none;width:44px;height:26px;border-radius:999px;border:1px solid #cbd5e1;background:#e5f9fb;outline:none;position:relative;transition:.2s}
    .switch input::after{content:"";position:absolute;top:3px;right:3px;width:20px;height:20px;border-radius:50%;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.1);transition:.2s}
    .switch input:checked{background:linear-gradient(180deg,var(--brand),var(--brand-2));border-color:transparent}
    .switch input:checked::after{right:21px}
    .badge.on{border-color:#a7f3d0}
    .badge.off{border-color:#fecaca}
    .svc-group{display:grid;gap:8px}
    .svc-group h5{margin:8px 0 0;font-size:14px;color:#0b6b6b}

    /* map controls */
    .mapCtrls{position:absolute;inset-inline-end:10px;inset-block-start:10px;display:flex;flex-direction:column;gap:8px;z-index:5}
    .mapBtn{padding:10px 12px;border-radius:12px;border:1px solid #cbd5e1;background:rgba(255,255,255,.9);backdrop-filter:blur(8px);font-weight:800;cursor:pointer;box-shadow:var(--shadow)}
    .mapBtn:hover{border-color:#67e8f9}
    /* Toast */
    .toast{position:fixed;inset-inline:12px;inset-block-end:calc(var(--navH) + 12px);background:#003; color:#e6fffb; padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);display:none}
    .toast.show{display:block}
  </style>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body>
  <header>
    <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px;min-height:64px">
      <div class="brand">
        <div class="logoBox" aria-hidden="true" title="ÙˆØ³ÙŠÙ„Ø©">
          <!-- Ø´Ø¹Ø§Ø± ÙˆÙ†ÙŠØª Ø­ÙˆØ¶ Ø§Ø­ØªØ±Ø§ÙÙŠ (SVG Ù…Ø¶Ù…Ù‘Ù†ØŒ Ù„ÙŠØ³ ØªÙƒØ³ÙŠ) -->
          <svg width="30" height="30" viewBox="0 0 128 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <defs>
              <linearGradient id="trg" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="#23c7c2"/>
                <stop offset="1" stop-color="#7ce7e2"/>
              </linearGradient>
              <linearGradient id="glass" x1="0" y1="0" x2="1" y2="0">
                <stop offset="0" stop-color="#ecfeff"/>
                <stop offset="1" stop-color="#b9f3f1"/>
              </linearGradient>
            </defs>
            <path d="M6 40h82c3 0 5-2 5-5v-7c0-1.2-.9-2.8-1.9-3.7l-10.5-9.6A6 6 0 0 0 76 12H58a4 4 0 0 0-4 4v6H24a10 10 0 0 0-10 10v8z" fill="url(#trg)"/>
            <path d="M54 18h17c1.1 0 2.2.4 3 1.1l9.2 8.1H54V18z" fill="url(#glass)"/>
            <rect x="6" y="42" width="116" height="5" rx="2.5" fill="#d1faf5"/>
            <circle cx="32" cy="47" r="8" fill="#0ea5a4"/><circle cx="32" cy="47" r="3.8" fill="#ecfeff"/>
            <circle cx="96" cy="47" r="8" fill="#0ea5a4"/><circle cx="96" cy="47" r="3.8" fill="#ecfeff"/>
          </svg>
        </div>
        <div>
          <div class="title">ÙˆØ³ÙŠÙ„Ø© â€” Ù†Ù…ÙˆØ°Ø¬ Ø£ÙˆÙ„ÙŠ Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</div>
          <div class="muted" id="envNote">Ù†Ø³Ø®Ø© Ø¹Ø±Ø¶ Ø£ÙˆÙ„ÙŠØ© â€” Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="installBtn" style="display:none" title="ØªØ«Ø¨ÙŠØª ÙƒØªØ·Ø¨ÙŠÙ‚">ØªØ«Ø¨ÙŠØª ÙˆØ³ÙŠÙ„Ø©</button>
        <button class="btn ghost" id="toggleMapBtn" title="Ø¥Ø¸Ù‡Ø§Ø± / Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©">Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
        <button class="btn" onclick="openView('landing')">Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Landing / Accounts entry -->
    <section id="landing" class="card">
      <h3>ÙˆØ§Ø¬Ù‡Ø© ÙˆØ³ÙŠÙ„Ø© (Ù†Ø³Ø®Ø© Ø¹Ø±Ø¶) <span class="badge" style="border-color:var(--ok)">ÙƒØ§ÙØ© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ù…ÙÙØ¹Ù‘Ù„Ø© âœ…</span></h3>
      <p class="muted">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø§Ù„Ø®Ø¯Ù…Ø© Ù„Ù„ØªØ¬Ø±Ø¨Ø© (ØªØµÙ…ÙŠÙ… Ø¬ÙˆØ§Ù„):</p>
      <div class="accounts" style="margin-top:10px">
        <button class="btn" onclick="openView('shipper')">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø·Ø§Ù„ÙØ¨ Ø§Ù„Ø®Ø¯Ù…Ø©)</button>
        <button class="btn" onclick="openView('owner')">Ø­Ø³Ø§Ø¨ Ø£ØµØ­Ø§Ø¨ Ø§Ù„ÙˆÙ†ÙŠØªØ§Øª (ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©)</button>
        <button class="btn" onclick="openView('driver')">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</button>
        <button class="btn" onclick="openView('admin')">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
        <button class="btn" onclick="openView('ownersList')">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„Ø§Ùƒ</button>
        <button class="btn" onclick="openView('services')">Ø§Ù„Ø®Ø¯Ù…Ø§Øª</button>
      </div>
    </section>

    <!-- Shipper workspace -->
    <section id="shipper" class="card" hidden>
      <div class="tabs">
        <button class="tab active" data-target="shipperBench">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
        <button class="tab" data-target="shipper-orders">Ø·Ù„Ø¨Ø§ØªÙŠ</button>
      </div>

      <div class="workbench" id="shipperBench">
        <div class="mapWrap">
          <div id="leafletMap" class="leaflet-map" role="region" aria-label="Ø®Ø±ÙŠØ·Ø© ÙˆØ³ÙŠÙ„Ø©"></div>
          <div class="mapCtrls" aria-hidden="false">
            <button type="button" class="mapBtn" id="fitRouteBtn">Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„Ù…Ø³Ø§Ø±</button>
            <button type="button" class="mapBtn" id="recenterBtn">Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
          </div>
        </div>
        <div class="panel card">
          <h3>Ø·Ù„Ø¨ ØªÙˆØµÙŠÙ„ <span class="badge" style="border-color:var(--ok);">Ù…ÙÙØ¹Ù„ âœ…</span></h3>
          <div class="field">
            <label>Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</label>
            <div class="inline-actions">
              <input id="pickup" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©ØŒ Ø§Ù„Ø­ÙŠØŒ Ø§Ù„Ø´Ø§Ø±Ø¹" style="flex:1" />
              <button type="button" class="pill" id="pickPickup">ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
              <button type="button" class="pill primary" id="useGPS" title="Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚Ø¹ÙŠ">Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚Ø¹ÙŠ</button>
              <button type="button" class="pill" id="copyPickup" title="Ù†Ø³Ø® Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª">Ù†Ø³Ø® Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</button>
              <span class="muted" id="pickupHint"></span>
            </div>
          </div>
          </div>
          <div class="field">
            <label>Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…</label>
            <div class="inline-actions">
              <input id="dropoff" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©ØŒ Ø§Ù„Ø­ÙŠØŒ Ø§Ù„Ø´Ø§Ø±Ø¹" style="flex:1" />
              <button type="button" class="pill" id="pickDropoff">ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
              <button type="button" class="pill primary" id="useGPSDrop" title="Ù…ÙˆÙ‚Ø¹ÙŠ Ù„Ù„ØªØ³Ù„ÙŠÙ…">Ù…ÙˆÙ‚Ø¹ÙŠ Ù„Ù„ØªØ³Ù„ÙŠÙ…</button>
              <button type="button" class="pill" id="copyDropoff" title="Ù†Ø³Ø® Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª">Ù†Ø³Ø® Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</button>
              <span class="muted" id="dropoffHint"></span>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>Ø§Ù„Ø®Ø¯Ù…Ø©</label>
              <select id="serviceType"></select>
            </div>
            <div class="field">
              <label>Ø­Ø¬Ù…/Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†Ù‚ÙˆÙ„</label>
              <select id="cargoSize">
                <option value="small">ØµØºÙŠØ± (ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø®ÙÙŠÙØ©)</option>
                <option value="medium">Ù…ØªÙˆØ³Ø· (Ø£Ø«Ø§Ø« Ø®ÙÙŠÙ)</option>
                <option value="big">ÙƒØ¨ÙŠØ± (Ø£Ø«Ø§Ø« Ø«Ù‚ÙŠÙ„/Ù…Ø¹Ø¯Ø§Øª)</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>Ù†ÙˆØ¹ Ø§Ù„Ø­Ù…ÙˆÙ„Ø©</label>
              <select id="cargoType">
                <option value="boxes">ØµÙ†Ø§Ø¯ÙŠÙ‚/Ø£ØºØ±Ø§Ø¶ Ø¹Ø§Ù…Ø©</option>
                <option value="furniture">Ø£Ø«Ø§Ø«</option>
                <option value="appliances">Ø£Ø¬Ù‡Ø²Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</option>
                <option value="building">Ù…ÙˆØ§Ø¯ Ø¨Ù†Ø§Ø¡</option>
                <option value="equipment">Ù…Ø¹Ø¯Ø§Øª</option>
              </select>
            </div>
            <div class="field">
              <label>ÙˆØ²Ù† ØªÙ‚Ø±ÙŠØ¨ÙŠ (ÙƒØ¬Ù…)</label>
              <input type="number" id="weightKg" min="0" step="1" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"/>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ°</label>
              <input type="datetime-local" id="when" />
            </div>
            <div class="field">
              <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
              <input id="notes" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ±" />
            </div>
          </div>
          <div class="actions">
            <button class="btn primary" onclick="estimate()">ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø³Ø¹Ø±</button>
            <button class="btn" onclick="submitOrder()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
            <span class="muted" id="estimateOut"></span>
          </div>
        </div>
      </div>

      <div id="shipper-orders" hidden>
        <div class="card">
          <h3>Ø·Ù„Ø¨Ø§ØªÙŠ</h3>
          <div id="ordersList" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯.</div>
        </div>
      </div>
    </section>

    <!-- Owners (pickup truck owners) registration -->
    <section id="owner" class="card" hidden>
      <h3>ØªØ³Ø¬ÙŠÙ„ Ø£ØµØ­Ø§Ø¨ Ø§Ù„ÙˆÙ†ÙŠØªØ§Øª <span class="badge" style="border-color:var(--ok);">Ù…ÙÙØ¹Ù„ âœ…</span></h3>
      <p class="muted">ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø© ÙˆØ§Ù„Ø³Ø§Ø¦Ù‚ Ø¨Ø¯Ù‚Ø©. Ù‡Ø°Ù‡ Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© ÙˆÙ„Ø§ ÙŠØªÙ… Ø±ÙØ¹ Ù…Ù„ÙØ§Øª ÙØ¹Ù„ÙŠØ©.</p>
      <div class="row">
        <div class="card">
          <h4>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</h4>
          <div class="field">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
            <select id="vehType">
              <option>ÙˆØ§Ù†ÙŠØª Ø­ÙˆØ¶ ØµØºÙŠØ±</option>
              <option>ÙˆØ§Ù†ÙŠØª Ø­ÙˆØ¶ ÙƒØ¨ÙŠØ±</option>
              <option>Ø¯ÙŠÙ†Ø§</option>
              <option>Ù‚ÙØµ/Ù…ØºØ·Ù‰</option>
            </select>
          </div>
          <div class="row">
            <div class="field">
              <label>Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©</label>
              <input id="plate" placeholder="Ù…Ø«Ø§Ù„: Ø³ Ø¹ Ù„ 1234"/>
            </div>
            <div class="field">
              <label>Ù…ÙˆØ¯ÙŠÙ„ (Ø³Ù†Ø© Ø§Ù„ØµÙ†Ø¹)</label>
              <input id="modelYear" type="number" min="1990" max="2026" placeholder="2019"/>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
              <select id="region">
                <option>Ù…Ù†Ø·Ù‚Ø© Ø­Ø§Ø¦Ù„</option><option>Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±ÙŠØ§Ø¶</option><option>Ù…Ù†Ø·Ù‚Ø© Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©</option>
                <option>Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</option><option>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©</option><option>Ø§Ù„Ù‚ØµÙŠÙ…</option>
                <option>ØªØ¨ÙˆÙƒ</option><option>Ø¹Ø³ÙŠØ±</option><option>Ø¬Ø§Ø²Ø§Ù†</option>
                <option>Ù†Ø¬Ø±Ø§Ù†</option><option>Ø§Ù„Ø¨Ø§Ø­Ø©</option><option>Ø§Ù„Ø¬ÙˆÙ</option><option>Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ©</option>
              </select>
            </div>
            <div class="field">
              <label>Ø§Ù„ØµÙˆØ±Ø© (ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±ÙƒØ¨Ø©)</label>
              <input type="file" id="vehFront" accept="image/*" />
            </div>
          </div>
        </div>

        <div class="card">
          <h4>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚</h4>
          <div class="row">
            <div class="field"><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</label><input id="driverName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„"/></div>
            <div class="field"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</label><input id="nid" placeholder="10 Ø£Ø±Ù‚Ø§Ù…" maxlength="10"/></div>
          </div>
          <div class="row">
            <div class="field"><label>Ø±Ù‚Ù… Ø±Ø®ØµØ© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</label><input id="licenseNo" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©"/></div>
            <div class="field"><label>ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø±Ø®ØµØ©</label><input id="licenseExp" type="date"/></div>
          </div>
          <div class="row">
            <div class="field"><label>Ù†Ø³Ø®Ø© Ø§Ù„Ø±Ø®ØµØ© (ØµÙˆØ±Ø©)</label><input type="file" id="licenseImg" accept="image/*"/></div>
            <div class="field"><label>IBAN Ù„Ù„Ø­ÙˆØ§Ù„Ø§Øª</label><input id="iban" placeholder="SA.."/></div>
          </div>
          <div class="actions">
            <button class="btn primary" onclick="saveOwner()">Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
            <span class="muted" id="ownerSaved"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- Owners list (enabled overview) -->
    <section id="ownersList" class="card" hidden>
      <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„Ø§Ùƒ <span class="badge" style="border-color:var(--ok);">Ù…ÙÙØ¹Ù„Ø© âœ…</span></h3>
      <div id="ownersTable" class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙÙ„Ø§Ùƒ Ø¨Ø¹Ø¯.</div>
    </section>

    <!-- Services (all enabled) -->
    <section id="services" class="card" hidden>
      <h3>Ø§Ù„Ø®Ø¯Ù…Ø§Øª <span class="badge" style="border-color:var(--ok);">Ù…ÙÙØ¹Ù„Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ âœ…</span></h3>
      <div id="servicesGrid" class="accounts"></div>
    </section>

    <!-- Drivers account -->
    <section id="driver" class="card" hidden>
      <h3>Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø§Ø¦Ù‚ <span class="badge" style="border-color:var(--ok);">Ù…ÙÙØ¹Ù„ âœ…</span></h3>
      <div class="row">
        <div class="card">
          <h4>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h4>
          <div class="field"><label>Ø§Ù„Ø§Ø³Ù…</label><input id="dName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚"/></div>
          <div class="row">
            <div class="field"><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="dPhone" placeholder="05xxxxxxxx"/></div>
            <div class="field"><label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label><input id="dCity" placeholder="Ù…Ø«Ø§Ù„: Ø­Ø§Ø¦Ù„"/></div>
          </div>
          <div class="row">
            <div class="field"><label>Ø§Ù„Ø±Ø®ØµØ© (ØµÙˆØ±Ø©)</label><input type="file" id="dLicenseFile" accept="image/*"/></div>
            <div class="field"><label>Ø¥Ù‚Ø§Ù…Ø©/Ù‡ÙˆÙŠØ© (ØµÙˆØ±Ø©)</label><input type="file" id="dIdFile" accept="image/*"/></div>
          </div>
          <div class="actions">
            <button class="btn primary" onclick="saveDriver()">Ø­ÙØ¸</button>
            <label class="tab" style="display:inline-flex;align-items:center;gap:6px">
              <input type="checkbox" id="availableToggle" onchange="toggleAvail()"/>
              Ù…ØªØ§Ø­ Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª
            </label>
          </div>
          <div class="muted" id="driverSaved"></div>
        </div>
        <div class="card">
          <h4>Ø·Ù„Ø¨Ø§Øª Ù‚Ø±ÙŠØ¨Ø©</h4>
          <div class="muted">ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¶Ù…Ù† Ù†Ø·Ø§Ù‚ 10 ÙƒÙ… (ØªØ¬Ø±ÙŠØ¨ÙŠ).</div>
          <ul id="nearbyList"></ul>
          <div class="actions"><span class="muted">Ø§Ø®ØªØ± Ø·Ù„Ø¨Ù‹Ø§ Ø«Ù… Ø§Ø¶ØºØ· Ù‚Ø¨ÙˆÙ„</span></div>
        </div>
      </div>
    </section>

    <!-- Admin -->
    <section id="admin" class="card" hidden>
      <h3>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ <span class="badge" style="border-color:var(--ok);">Ù…ÙÙØ¹Ù„Ø© âœ…</span></h3>
      <div class="stats">
        <div class="stat"><div class="muted">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div><b id="stUsers">0</b></div>
        <div class="stat"><div class="muted">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div><b id="stOrders">0</b></div>
        <div class="stat"><div class="muted">Ø³Ø§Ø¦Ù‚ÙˆÙ† Ù…ØªØ§Ø­ÙˆÙ†</div><b id="stDrivers">0</b></div>
        <div class="stat"><div class="muted">Ù…Ø±ÙƒØ¨Ø§Øª Ù…Ø³Ø¬Ù„Ø©</div><b id="stVehicles">0</b></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ ÙˆØ§Ù„ØªØ³Ø¹ÙŠØ±</h4>
        <div class="row">
          <div class="field"><label>ØªØ¹Ø±ÙØ© Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ± (Ø±ÙŠØ§Ù„)</label><input id="kmRate" type="number" step="0.5" value="3"/></div>
          <div class="field"><label>Ø±Ø³ÙˆÙ… ÙØªØ­ Ø§Ù„Ø·Ù„Ø¨ (Ø±ÙŠØ§Ù„)</label><input id="baseFee" type="number" step="1" value="20"/></div>
        </div>
        <div class="row">
          <div class="field"><label>Ø³Ø¹Ø± Ø§Ù„ÙƒÙŠÙ„Ùˆ Ù„Ù„ÙˆØ²Ù† Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ (Ø±ÙŠØ§Ù„/ÙƒØ¬Ù…)</label><input id="perKg" type="number" step="0.1" value="0.5"/></div>
          <div class="field"><label>ÙˆØ²Ù† Ù…Ø¬Ø§Ù†ÙŠ Ù…Ø´Ù…ÙˆÙ„ (ÙƒØ¬Ù…)</label><input id="freeKg" type="number" step="1" value="50"/></div>
        </div>
        <div class="row">
          <div class="field"><label>Ù…Ø¶Ø§Ø¹Ù Ø§Ù„Ø­Ø¬Ù… (ØµØºÙŠØ±/Ù…ØªÙˆØ³Ø·/ÙƒØ¨ÙŠØ±)</label>
            <div class="inline-actions" style="gap:6px">
              <input id="mSmall" type="number" step="0.05" value="1" style="width:33%"/>
              <input id="mMedium" type="number" step="0.05" value="1.3" style="width:33%"/>
              <input id="mBig" type="number" step="0.05" value="1.8" style="width:33%"/>
            </div>
          </div>
          <div class="field"><label>Ù…Ø¶Ø§Ø¹Ù Ù†ÙˆØ¹ Ø§Ù„Ø­Ù…ÙˆÙ„Ø© (ØµÙ†Ø§Ø¯ÙŠÙ‚/Ø£Ø«Ø§Ø«/Ø£Ø¬Ù‡Ø²Ø©/Ù…ÙˆØ§Ø¯ Ø¨Ù†Ø§Ø¡/Ù…Ø¹Ø¯Ø§Øª)</label>
            <div class="inline-actions" style="gap:6px;flex-wrap:wrap">
              <input id="tBoxes" type="number" step="0.05" value="1" style="width:18%"/>
              <input id="tFurniture" type="number" step="0.05" value="1.15" style="width:18%"/>
              <input id="tAppliances" type="number" step="0.05" value="1.2" style="width:18%"/>
              <input id="tBuilding" type="number" step="0.05" value="1.3" style="width:18%"/>
              <input id="tEquipment" type="number" step="0.05" value="1.35" style="width:18%"/>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="field"><label>ÙØªØ±Ø© Ø§Ù„ØªØªØ¨Ù‘Ø¹ Ø§Ù„Ø­ÙŠ (Ø«ÙˆØ§Ù†Ù)</label><input id="pollSec" type="number" min="4" step="1" value="8"/></div>
        </div>
        <div class="actions">
          <button class="btn primary" onclick="savePricing()">Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¹ÙŠØ±</button>
          <span class="muted" id="pricingSaved"></span>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>Ø§Ù„Ø®Ø¯Ù…Ø§Øª (ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„)</h4>
        <div class="toolbar" style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px">
          <input id="svcSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø©..." style="flex:1;min-width:200px;padding:12px;border-radius:12px;border:1px solid #dbe4ea"/>
          <div class="chips" id="svcCats" style="display:flex;gap:6px;flex-wrap:wrap">
            <button class="pill" data-cat="Ø§Ù„ÙƒÙ„">Ø§Ù„ÙƒÙ„</button>
            <button class="pill" data-cat="Ù…Ù†Ø²Ù„ÙŠ">Ù…Ù†Ø²Ù„ÙŠ</button>
            <button class="pill" data-cat="Ù…Ø¹Ø¯Ø§Øª">Ù…Ø¹Ø¯Ø§Øª</button>
            <button class="pill" data-cat="ØªØ¬Ø§Ø±ÙŠ">ØªØ¬Ø§Ø±ÙŠ</button>
            <button class="pill" data-cat="Ù„ÙˆØ¬Ø³ØªÙŠ">Ù„ÙˆØ¬Ø³ØªÙŠ</button>
            <button class="pill" data-cat="Ø³Ø±ÙŠØ¹">Ø³Ø±ÙŠØ¹</button>
          </div>
        </div>
        <div id="adminServices" class="service-grid"></div>
        <div class="muted" style="margin-top:6px">ğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ Ø¨Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª. ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (ØªØ¬Ø±ÙŠØ¨ÙŠ)</h4>
        <div id="adminOrders" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</div>
        <template id="orderRowTmpl">
          <div class="card" data-id="">
            <div><b class="from"></b> â†’ <b class="to"></b> <span class="badge status"></span></div>
            <div class="muted time"></div>
            <div class="actions">
              <button class="btn" data-action="complete">Ø¥ÙƒÙ…Ø§Ù„</button>
              <button class="btn ghost" data-action="cancel">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
          </div>
        </template>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</h4>
        <p class="muted">Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø© ÙˆØ§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙˆØªØ¯ÙÙ‚ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨.</p>
        <div id="testResults"></div>
        <div class="actions"><button class="btn" id="runTestsBtn">ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</button></div>
      </div>
    </section>

  </main>

  <div class="toast" id="toast"></div>

  <!-- Ø´Ø±ÙŠØ· ØªÙ†Ù‚Ù‘Ù„ Ø³ÙÙ„ÙŠ (Ø£Ø³Ù„ÙˆØ¨ ØªØ·Ø¨ÙŠÙ‚ Ø¬ÙˆØ§Ù„) -->
  <nav class="appTabs" role="navigation" aria-label="ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚">
    <button onclick="openView('landing')" id="tabHome"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10.5 12 3l9 7.5"/><path d="M9 21V12h6v9"/></svg><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></button>
    <button onclick="openView('shipper')" id="tabShip"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="7" width="13" height="13" rx="2"/><path d="M16 13h5l-3-5h-2z"/></svg><span>Ø§Ù„Ø¹Ù…ÙŠÙ„</span></button>
    <button onclick="openView('driver')" id="tabDrv"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 13h18"/><path d="M5 16h14"/><circle cx="7" cy="19" r="2"/><circle cx="17" cy="19" r="2"/></svg><span>Ø§Ù„Ø³Ø§Ø¦Ù‚</span></button>
    <button onclick="openView('owner')" id="tabOwn"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="10" rx="3"/><path d="M7 7V5h10v2"/></svg><span>Ø§Ù„Ù…Ø§Ù„Ùƒ</span></button>
    <button onclick="openView('admin')" id="tabAdm"><svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9c0 .7.4 1.3 1 1.6.3.2.6.4 1 .4a2 2 0 1 1 0 4c-.4 0-.7.2-1 .4-.6.3-1 .9-1 1.6z"/></svg><span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span></button>
  </nav>

  <footer class="container">
    <div>Â© ÙˆØ³ÙŠÙ„Ø© â€” Ù†Ù…ÙˆØ°Ø¬ Ø£ÙˆÙ„ÙŠ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ.</div>
  </footer>

  <script>
    // ---- Simple state (global) ----
    const S = {
      orders: JSON.parse(localStorage.getItem('orders')||'[]'),
      owners: JSON.parse(localStorage.getItem('owners')||'[]'),
      drivers: JSON.parse(localStorage.getItem('drivers')||'[]'),
      pricing: JSON.parse(localStorage.getItem('pricing')||'{"kmRate":3,"baseFee":20,"perKg":0.5,"freeKg":50,"pollSec":8,"multipliers":{"size":{"small":1,"medium":1.3,"big":1.8},"type":{"boxes":1,"furniture":1.15,"appliances":1.2,"building":1.3,"equipment":1.35}}}'),
      services: JSON.parse(localStorage.getItem('services')||JSON.stringify([
        {key:'house_move', name:'Ù†Ù‚Ù„ Ø£Ø«Ø§Ø« Ù…Ù†Ø²Ù„ÙŠ', cat:'Ù…Ù†Ø²Ù„ÙŠ', enabled:true},
        {key:'appliance',  name:'Ø£Ø¬Ù‡Ø²Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©', cat:'Ù…Ù†Ø²Ù„ÙŠ', enabled:true},
        {key:'office',     name:'Ù†Ù‚Ù„ Ù…ÙƒØªØ¨ÙŠ', cat:'ØªØ¬Ø§Ø±ÙŠ', enabled:true},
        {key:'flatbed',    name:'Ø³Ø·Ø­Ø©/Ù…Ø¹Ø¯Ø§Øª', cat:'Ù…Ø¹Ø¯Ø§Øª', enabled:true},
        {key:'building',   name:'Ù…ÙˆØ§Ø¯ Ø¨Ù†Ø§Ø¡ ÙˆØ­ÙØ±', cat:'Ù…Ø¹Ø¯Ø§Øª', enabled:true},
        {key:'landscape',  name:'ØªÙ†Ø³ÙŠÙ‚ Ø­Ø¯Ø§Ø¦Ù‚ ÙˆÙ†Ø®ÙŠÙ„', cat:'Ù…Ù†Ø²Ù„ÙŠ', enabled:true},
        {key:'event',      name:'ØªØ¬Ù‡ÙŠØ² ÙØ¹Ø§Ù„ÙŠØ§Øª ÙˆÙ…Ø¹Ø§Ø±Ø¶', cat:'ØªØ¬Ø§Ø±ÙŠ', enabled:true},
        {key:'waste',      name:'Ù…Ø®Ù„ÙØ§Øª Ø®ÙÙŠÙØ© ÙˆÙ†Ù‚Ù„ Ø£Ù†Ù‚Ø§Ø¶', cat:'Ù…Ø¹Ø¯Ø§Øª', enabled:true},
        {key:'store',      name:'ØªÙˆØµÙŠÙ„ Ù…Ù† Ù…ØªØ¬Ø±/Ù…Ø³ØªÙˆØ¯Ø¹', cat:'ØªØ¬Ø§Ø±ÙŠ', enabled:true},
        {key:'warehouse',  name:'Ù…Ù†Ø§ÙˆÙ„Ø© Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª', cat:'Ù„ÙˆØ¬Ø³ØªÙŠ', enabled:true},
        {key:'long',       name:'Ù†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø¯Ù†', cat:'Ù„ÙˆØ¬Ø³ØªÙŠ', enabled:true},
        {key:'express',    name:'Ø³Ø±ÙŠØ¹ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©', cat:'Ø³Ø±ÙŠØ¹', enabled:true}
      ]))
    };
    // Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨: new, assigned, in_progress, completed, cancelled

    // ---- Helpers ----
    function val(id){return document.getElementById(id)?.value?.trim()||''}
    function byId(id){return document.getElementById(id)}
    function esc(s){return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}
    function mapStatus(s){ return s==='new'?'Ø¬Ø¯ÙŠØ¯': s==='assigned'?'Ù…ÙØ³Ù†Ø¯': s==='in_progress'?'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°': s==='completed'?'Ù…ÙƒØªÙ…Ù„': s==='cancelled'?'Ù…Ù„ØºÙŠ':'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'; }
    function persist(){ localStorage.setItem('orders', JSON.stringify(S.orders)); localStorage.setItem('owners', JSON.stringify(S.owners)); localStorage.setItem('drivers', JSON.stringify(S.drivers)); localStorage.setItem('pricing', JSON.stringify(S.pricing)); localStorage.setItem('services', JSON.stringify(S.services)); }

    // ---- Define openView EARLY ----
    window.openView = function openView(id){
      document.querySelectorAll('main > section').forEach(sec=>sec.hidden = true);
      const el = document.getElementById(id) || document.getElementById('landing');
      el.hidden = false;
      document.querySelectorAll('.appTabs button').forEach(b=>b.classList.remove('active'));
      const mapIdToBtn = {landing:'tabHome', shipper:'tabShip', driver:'tabDrv', owner:'tabOwn', admin:'tabAdm'};
      const btnId = mapIdToBtn[id]; if(btnId) document.getElementById(btnId).classList.add('active');
      if(id==='shipper' && typeof L!=='undefined' && window.map){
        setTimeout(()=>{ try{ window.map.invalidateSize(); if(window.mapState?.pickup && window.mapState?.dropoff){ drawRouteIfReady(); } }catch(_){} },0);
      }
      updateUI();
    }

    // ---- DOM bootstrap ----
    document.addEventListener('DOMContentLoaded', ()=>{
      // tabs behavior
      document.querySelectorAll('.tabs .tab').forEach(tab=>{ tab.addEventListener('click', ()=>{ const wrap = tab.closest('section'); wrap.querySelectorAll('.tabs .tab').forEach(t=>t.classList.remove('active')); tab.classList.add('active'); const target = tab.dataset.target; if(target){ wrap.querySelectorAll('#shipperBench,#shipper-orders').forEach(v=>v.hidden=true); const tgt = wrap.querySelector('#'+target); if(tgt){ tgt.closest('div').hidden=false; } } }); });

      // map ctrl buttons
      const fitBtn = document.getElementById('fitRouteBtn'); const recBtn = document.getElementById('recenterBtn'); if(fitBtn) fitBtn.addEventListener('click', fitToMarkersOrRoute); if(recBtn) recBtn.addEventListener('click', recenterMap);

      // map toggle
      const tgl = document.getElementById('toggleMapBtn'); if(tgl){ tgl.addEventListener('click',()=>{ document.body.classList.toggle('mapCollapsed'); }); }

      // boot
      history.replaceState(null, '', location.pathname); openView('landing'); initLeaflet(); updateUI();

      // listeners
      const q = document.getElementById('svcSearch'); if(q){ q.addEventListener('input', e=>{ window.__svcQuery = e.target.value.trim(); renderAdminServices(); }); }
      const chips = document.getElementById('svcCats'); if(chips){ chips.addEventListener('click', (e)=>{ const b=e.target.closest('button[data-cat]'); if(!b) return; window.__svcCat=b.dataset.cat; [...chips.querySelectorAll('button')].forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderAdminServices(); }); }
      const testBtn = document.getElementById('runTestsBtn'); if(testBtn){ testBtn.addEventListener('click', runTests); }

      // GPS buttons
      const gps = document.getElementById('useGPS'); if(gps){ gps.addEventListener('click', useMyLocation); }
      const gpsD = document.getElementById('useGPSDrop'); if(gpsD){ gpsD.addEventListener('click', useMyLocationDrop); }

      // Copy coord buttons
      const cP = document.getElementById('copyPickup'); if(cP){ cP.addEventListener('click', ()=>copyCoords('pickup')); }
      const cD = document.getElementById('copyDropoff'); if(cD){ cD.addEventListener('click', ()=>copyCoords('dropoff')); }

      // Live polling using configured interval
      let lastOrdersJSON = JSON.stringify(S.orders);
      const pollMs = Math.max(4000, (S.pricing.pollSec||8)*1000);
      setInterval(()=>{
        try{
          const nowOrders = JSON.parse(localStorage.getItem('orders')||'[]');
          const js = JSON.stringify(nowOrders);
          if(js!==lastOrdersJSON){ S.orders = nowOrders; lastOrdersJSON = js; updateUI(); }
        }catch(_){/* ignore */}
      }, pollMs);
    });

      const q = document.getElementById('svcSearch'); if(q){ q.addEventListener('input', e=>{ window.__svcQuery = e.target.value.trim(); renderAdminServices(); }); }
      const chips = document.getElementById('svcCats'); if(chips){ chips.addEventListener('click', (e)=>{ const b=e.target.closest('button[data-cat]'); if(!b) return; window.__svcCat=b.dataset.cat; [...chips.querySelectorAll('button')].forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderAdminServices(); }); }

      const testBtn = document.getElementById('runTestsBtn'); if(testBtn){ testBtn.addEventListener('click', runTests); }
    });
          wrap.querySelectorAll('.tabs .tab').forEach(t=>t.classList.remove('active'));
          tab.classList.add('active');
          const target = tab.dataset.target;
          if(target){
            wrap.querySelectorAll('#shipperBench,#shipper-orders').forEach(v=>v.hidden=true);
            const tgt = wrap.querySelector('#'+target);
            if(tgt){ tgt.closest('div').hidden=false; }
          }
        });
      });

      // map ctrl buttons
      const fitBtn = document.getElementById('fitRouteBtn');
      const recBtn = document.getElementById('recenterBtn');
      if(fitBtn) fitBtn.addEventListener('click', fitToMarkersOrRoute);
      if(recBtn) recBtn.addEventListener('click', recenterMap);

      // map toggle
      const tgl = document.getElementById('toggleMapBtn');
      if(tgl){ tgl.addEventListener('click',()=>{ document.body.classList.toggle('mapCollapsed'); }); }

      // boot
      history.replaceState(null, '', location.pathname);
      openView('landing');
      initLeaflet();
      updateUI();

      // services toolbar listeners
      const q = document.getElementById('svcSearch');
      if(q){ q.addEventListener('input', e=>{ window.__svcQuery = e.target.value.trim(); renderAdminServices(); }); }
      const chips = document.getElementById('svcCats');
      if(chips){ chips.addEventListener('click', (e)=>{ const b=e.target.closest('button[data-cat]'); if(!b) return; window.__svcCat=b.dataset.cat; [...chips.querySelectorAll('button')].forEach(x=>x.classList.remove('active')); b.classList.add('active'); renderAdminServices(); }); }

      const testBtn = document.getElementById('runTestsBtn');
      if(testBtn){ testBtn.addEventListener('click', runTests); }
    });

    // ---- Pricing & Orders ----
    function kmBetween(){
      if(window.mapState?.pickup && window.mapState?.dropoff){
        const {pickup, dropoff} = window.mapState;
        const R = 6371; const toRad = d => d*Math.PI/180;
        const dLat = toRad(dropoff.lat - pickup.lat);
        const dLon = toRad(dropoff.lng - pickup.lng);
        const a = Math.sin(dLat/2)**2 + Math.cos(toRad(pickup.lat))*Math.cos(toRad(dropoff.lat))*Math.sin(dLon/2)**2;
        const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return Math.max(1, Math.round(R*c));
      }
      return 2 + Math.round(Math.random()*12);
    }

    function estimate(){
      const km = (typeof lastRouteKm==='number' && lastRouteKm>0) ? Math.round(lastRouteKm) : kmBetween();
      const r = S.pricing.kmRate || 3; const base = S.pricing.baseFee || 20;
      const size = byId('cargoSize')?.value||'small';
      const type = byId('cargoType')?.value||'boxes';
      const weight = +byId('weightKg')?.value||0;
      const ms = S.pricing.multipliers?.size || {small:1,medium:1.3,big:1.8};
      const mt = S.pricing.multipliers?.type || {boxes:1,furniture:1.15,appliances:1.2,building:1.3,equipment:1.35};
      const multSize = ms[size] ?? 1;
      const multType = mt[type] ?? 1;
      const extraW = Math.max(0, weight - (S.pricing.freeKg||50));
      const weightFee = extraW * (S.pricing.perKg||0.5);
      const price = Math.round((base + km*r)*multSize*multType + weightFee);
      const eta = (typeof lastRouteETAmin==='number')? ` â€” Ø²Ù…Ù† ØªÙ‚Ø¯ÙŠØ±ÙŠ ~ ${Math.max(1,Math.round(lastRouteETAmin))} Ø¯Ù‚ÙŠÙ‚Ø©` : '';
      byId('estimateOut').textContent = `ØªÙ‚Ø¯ÙŠØ±: ~ ${price} Ø±ÙŠØ§Ù„ Ù„Ù…Ø³Ø§ÙØ© ${km} ÙƒÙ…${eta}`;
      return price;
    }

    function submitOrder(){
      const svcSel = document.getElementById('serviceType');
      const service = svcSel ? (svcSel.value || '') : '';
      const data = {
        pickup: val('pickup'), dropoff: val('dropoff'), when: val('when'), notes: val('notes'),
        size: val('cargoSize'), cargoType: val('cargoType'), weightKg: +(val('weightKg')||0), service,
        price: estimate(), id: Date.now(), status: 'new', driverId: null
      };
      if(!data.pickup||!data.dropoff){alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙˆØ§Ù„ØªØ³Ù„ÙŠÙ…');return}
      S.orders.unshift(data); persist();
      document.getElementById('estimateOut').textContent = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.';
      updateUI();
      const tab = document.querySelector('#shipper .tabs .tab[data-target="shipper-orders"]'); if(tab) tab.click();
    }

    function saveOwner(){
      const rec = {
        vehType: val('vehType'), plate: val('plate'), modelYear: val('modelYear'), region: val('region'),
        driverName: val('driverName'), nid: val('nid'), licenseNo: val('licenseNo'), licenseExp: val('licenseExp'), iban: val('iban'),
        id: Date.now()
      };
      S.owners.unshift(rec); persist();
      byId('ownerSaved').textContent = 'ØªÙ… Ø§Ù„Ø­ÙØ¸.'; updateUI();
    }

    function saveDriver(){
      const d = {name: val('dName'), phone: val('dPhone'), city: val('dCity'), available: byId('availableToggle').checked, id: Date.now()};
      S.drivers.unshift(d); persist();
      byId('driverSaved').textContent = 'ØªÙ… Ø§Ù„Ø­ÙØ¸.'; updateUI();
    }

    function toggleAvail(){updateUI()}

    function savePricing(){
      S.pricing = {
        kmRate: +val('kmRate')||3,
        baseFee: +val('baseFee')||20,
        perKg: +val('perKg')||0.5,
        freeKg: +val('freeKg')||50,
        pollSec: +val('pollSec')||8,
        multipliers: {
          size: {
            small: +val('mSmall')||1,
            medium: +val('mMedium')||1.3,
            big: +val('mBig')||1.8
          },
          type: {
            boxes: +val('tBoxes')||1,
            furniture: +val('tFurniture')||1.15,
            appliances: +val('tAppliances')||1.2,
            building: +val('tBuilding')||1.3,
            equipment: +val('tEquipment')||1.35
          }
        }
      };
      persist(); byId('pricingSaved').textContent = 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ³Ø¹ÙŠØ±.';
    }; persist(); byId('pricingSaved').textContent = 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ³Ø¹ÙŠØ±.'; }

    function driverAccept(orderId){
      const d = S.drivers[0];
      const o = S.orders.find(x=>x.id===orderId);
      if(!o) return;
      o.driverId = d? d.id : null; o.status = 'in_progress'; persist(); updateUI();
      try{ localStorage.setItem('orders', JSON.stringify(S.orders)); }catch(_){}
      alert('ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ù„Ø¨Ø¯Ø¡ ÙÙŠ ØªÙ†ÙÙŠØ°Ù‡');
    }

    function labelOf(key){ const f = S.services.find(s=>s.key===key); return f?f.name:key; }

    // ---- UI rendering ----
    function updateUI(){
      // services in shipper form
      const svcSel = byId('serviceType'); if(svcSel){ const enabled = S.services.filter(s=>s.enabled); svcSel.innerHTML = enabled.map(s=>`<option value="${s.key}">${s.name}</option>`).join(''); if(!enabled.length){ svcSel.innerHTML = '<option disabled>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø¯Ù…Ø§Øª Ù…ÙØ¹Ù„Ø©</option>'; } }

      // pricing inputs reflect state
      const kmRate=byId('kmRate'), baseFee=byId('baseFee'), perKg=byId('perKg'), freeKg=byId('freeKg');
      if(kmRate) kmRate.value = S.pricing.kmRate||3;
      if(baseFee) baseFee.value = S.pricing.baseFee||20;
      if(perKg) perKg.value = S.pricing.perKg||0.5;
      if(freeKg) freeKg.value = S.pricing.freeKg||50;

      // services grid
      const svcGrid = byId('servicesGrid'); if(svcGrid){ svcGrid.innerHTML = S.services.map(s=>`<div class=\"card\"><div style=\"display:flex;align-items:center;justify-content:space-between;gap:8px\"><b>${s.name}</b><span class=\"badge\" style=\"border-color:${s.enabled?'#a7f3d0':'#fecaca'}\">${s.enabled?'Ù…ÙÙØ¹Ù‘Ù„':'Ù…Ø¹Ø·Ù‘Ù„'}</span></div></div>`).join(''); }

      // Admin services
      const adminSvc = byId('adminServices'); if(adminSvc){ renderAdminServices(); }

      // Admin stats
      byId('stUsers').textContent = Math.max(1, Math.ceil(S.orders.length/2));
      byId('stOrders').textContent = S.orders.slice(0,10).length;
      byId('stDrivers').textContent = S.drivers.filter(d=>d.available).length;
      byId('stVehicles').textContent = S.owners.length;

      // Admin orders table
      const adminOrders = byId('adminOrders');
      if(adminOrders){
        if(!S.orders.length) adminOrders.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.'; else{
          adminOrders.innerHTML = '';
          S.orders.forEach(o=>{
            const row = document.getElementById('orderRowTmpl').content.cloneNode(true);
            const root = row.querySelector('.card');
            root.dataset.id = o.id;
            row.querySelector('.from').textContent = o.pickup;
            row.querySelector('.to').textContent = o.dropoff;
            row.querySelector('.time').textContent = new Date(o.id).toLocaleString('ar-SA');
            const stEl = row.querySelector('.status'); stEl.textContent = mapStatus(o.status);
            if(o.status==='completed'||o.status==='cancelled'){ row.querySelector('[data-action="complete"]').disabled = true; }
            row.querySelector('[data-action="complete"]').addEventListener('click',()=>{ o.status='completed'; persist(); updateUI();});
            row.querySelector('[data-action="cancel"]').addEventListener('click',()=>{ o.status='cancelled'; persist(); updateUI();});
            adminOrders.appendChild(row);
          });
        }
      }

      // Nearby for driver (last 5 new)
      const near = byId('nearbyList');
      if(near){
        const avail = S.orders.filter(o=>o.status==='new').slice(0,5);
        if(!avail.length) near.innerHTML = '<li class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù‚Ø±ÙŠØ¨Ø© Ø§Ù„Ø¢Ù†.</li>';
        else{
          near.innerHTML = avail.map(o=>`<li class=\"card\" style=\"margin:6px 0;padding:10px\"><b>${esc(o.pickup)}</b> â†’ <b>${esc(o.dropoff)}</b>${o.service?` â€” <span class=\\\"badge\\\">${esc(labelOf(o.service))}</span>`:''}<br><span class=\"muted\">~${o.price} Ø±.Ø³</span><div class=\"actions\"><button class=\"btn primary\" onclick=\"driverAccept(${o.id})\">Ù‚Ø¨ÙˆÙ„</button></div></li>`).join('');
        }
      }

      // Owners table
      const ownersHost = byId('ownersTable');
      if(ownersHost){
        if(!S.owners.length) ownersHost.textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙÙ„Ø§Ùƒ Ø¨Ø¹Ø¯.'; else{
          ownersHost.innerHTML = S.owners.map(o=>`<div class=\"card\" style=\"margin:6px 0\"><b>${esc(o.driverName)}</b> â€” ${esc(o.vehType)} | ${esc(o.region)} <span class=\"muted\">${esc(o.plate)}</span></div>`).join('');
        }
      }
    }

    // ===== Admin services rendering + filters + drag&drop =====
    window.__svcQuery = '';
    window.__svcCat = 'Ø§Ù„ÙƒÙ„';

    // ensure categories exist for older storage
    S.services = S.services.map(s=>({...s, cat: s.cat || mapCategory(s.key)}));

    function mapCategory(key){
      if(['house_move','appliance','landscape'].includes(key)) return 'Ù…Ù†Ø²Ù„ÙŠ';
      if(['office','event','store'].includes(key)) return 'ØªØ¬Ø§Ø±ÙŠ';
      if(['flatbed','building','waste'].includes(key)) return 'Ù…Ø¹Ø¯Ø§Øª';
      if(['warehouse','long'].includes(key)) return 'Ù„ÙˆØ¬Ø³ØªÙŠ';
      if(['express'].includes(key)) return 'Ø³Ø±ÙŠØ¹';
      return 'Ø£Ø®Ø±Ù‰';
    }

    function filteredServices(){
      const q = (window.__svcQuery||'').toLowerCase();
      const cat = window.__svcCat||'Ø§Ù„ÙƒÙ„';
      return S.services.filter(s=>{
        const matchesQ = !q || s.name.toLowerCase().includes(q) || s.key.toLowerCase().includes(q);
        const matchesC = cat==='Ø§Ù„ÙƒÙ„' || s.cat===cat;
        return matchesQ && matchesC;
      });
    }

    function renderAdminServices(){
      const host = document.getElementById('adminServices'); if(!host) return;
      const groups = {};
      filteredServices().forEach((s,idx)=>{ const g=s.cat||'Ø£Ø®Ø±Ù‰'; (groups[g]=groups[g]||[]).push({s, idx}); });
      host.innerHTML = Object.keys(groups).sort((a,b)=>a.localeCompare(b,'ar')).map(g=>{
        const items = groups[g].map(({s,idx})=>serviceCardHTML(s, idx)).join('');
        return `<div class=\"svc-group\"><h5>${g}</h5>${items}</div>`;
      }).join('');
      bindServiceCardDnD(host);
    }

    function serviceCardHTML(s, idx){
      const letter = s.name.trim().charAt(0);
      const id = `svc_${idx}`;
      return `<div class=\"service-card\" draggable=\"true\" data-index=\"${idx}\" aria-grabbed=\"false\">\n        <div class=\"ico\" aria-hidden=\"true\">${letter}</div>\n        <div class=\"meta\"><b title=\"${s.name}\">${s.name}</b><div class=\"muted\">${s.key}</div></div>\n        <label class=\"switch\" for=\"${id}\">\n          <input id=\"${id}\" type=\"checkbox\" ${s.enabled?'checked':''} onchange=\"toggleService(${idx}, this.checked)\" aria-label=\"ØªÙØ¹ÙŠÙ„ ${s.name}\" />\n        </label>\n        <span class=\"badge ${s.enabled?'on':'off'}\">${s.enabled?'Ù…ÙÙØ¹Ù‘Ù„':'Ù…Ø¹Ø·Ù‘Ù„'}</span>\n      </div>`
    }

    function bindServiceCardDnD(root){
      const cards=[...root.querySelectorAll('.service-card')];
      let dragIndex=null;
      cards.forEach(card=>{
        card.addEventListener('dragstart', (e)=>{ dragIndex=+card.dataset.index; card.style.opacity=.6; e.dataTransfer.effectAllowed='move'; });
        card.addEventListener('dragend', ()=>{ card.style.opacity=''; });
        card.addEventListener('dragover', (e)=>{ e.preventDefault(); e.dataTransfer.dropEffect='move'; });
        card.addEventListener('drop', (e)=>{
          e.preventDefault();
          const toIndex = +card.dataset.index;
          if(Number.isFinite(dragIndex) && Number.isFinite(toIndex) && dragIndex!==toIndex){
            const [moved] = S.services.splice(dragIndex,1);
            S.services.splice(toIndex,0,moved);
            persist();
            renderAdminServices();
          }
        });
      });
    }

    function toggleService(i, val){ S.services[i].enabled = !!val; persist(); updateUI(); }

    // ---- Minimal front-end test cases (unchanged logic, cleaned) ----
    function runTests(){
      const results = [];
      const assert = (name, cond) => results.push({Ø§Ø®ØªØ¨Ø§Ø±:name, Ø§Ù„Ù†ØªÙŠØ¬Ø©: cond? 'PASS':'FAIL'});
      try{
        assert('ØªØ¹Ø±ÙŠÙ openView', typeof window.openView === 'function');
        const ids = ['landing','shipper','owner','driver','admin','ownersList'];
        ids.forEach(id=>{ window.openView(id); const sec = document.getElementById(id); assert(`Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø³Ù… ${id}`, sec && sec.hidden===false); });
        location.hash = '#owner'; window.dispatchEvent(new HashChangeEvent('hashchange')); assert('Ø§Ù„Ù…Ø³Ø§Ø± Ø¨Ø§Ù„Ù‡Ø§Ø´ ÙŠØ¹Ù…Ù„', !document.getElementById('owner').hidden);
        window.openView('shipper');
        const newTab = document.querySelector('#shipper .tabs .tab[data-target="shipper-orders"]'); if(newTab){ newTab.click(); }
        assert('Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ "Ø·Ù„Ø¨Ø§ØªÙŠ"', document.getElementById('shipper-orders').hidden===false);
        const preCount = S.orders.length;
        S.orders.unshift({id: Date.now()+1, pickup:'Ø§Ø®ØªØ¨Ø§Ø± Ø£', dropoff:'Ø§Ø®ØªØ¨Ø§Ø± Ø¨', size:'small', price:50, status:'new', driverId:null}); persist();
        assert('Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø§Ø®ØªØ¨Ø§Ø±ÙŠ', S.orders.length===preCount+1);
        const newId = S.orders[0].id; driverAccept(newId); assert('Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù„Ù„Ø·Ù„Ø¨', S.orders[0].status==='in_progress');
        S.orders[0].status='completed'; persist(); assert('Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨', S.orders[0].status==='completed');
        updateUI();
        // Ø¥Ø¯Ø§Ø±Ø©: ÙÙ„ØªØ±Ø© ÙˆØªØ±ØªÙŠØ¨
        window.__svcQuery = 'Ù†Ù‚Ù„'; const before = filteredServices().length; assert('ÙÙ„ØªØ±Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø¨Ø§Ù„ÙƒÙ„Ù…Ø© ØªØ¹Ù…Ù„', before>0);
        window.__svcCat = 'Ù…Ø¹Ø¯Ø§Øª'; const onlyEquip = filteredServices().every(s=>s.cat==='Ù…Ø¹Ø¯Ø§Øª'); assert('ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø© ØªØ¹Ù…Ù„', onlyEquip);
        // Ù…Ø­Ø§ÙƒØ§Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨
        const len=S.services.length; const first=S.services[0]; S.services.splice(0,1); S.services.splice(2,0,first); persist(); assert('Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø¨Ø§Ù„Ø°Ø§ÙƒØ±Ø©', S.services.length===len && S.services[2]===first);
      }catch(e){ console.error('Test error:', e); }
      const host = document.getElementById('testResults');
      if(host){ host.innerHTML = '<div class="badge">Ù†ØªØ§Ø¦Ø¬</div>' + '<pre style="white-space:pre-wrap">'+results.map(r=>`${r.Ø§Ø®ØªØ¨Ø§Ø±}: ${r.Ø§Ù„Ù†ØªÙŠØ¬Ø©}`).join('\n')+'</pre>'; }
      console.table(results);
      window.openView('landing');
    }

    // ===== Leaflet integration =====
    let map, pickupMarker, dropoffMarker, routeLine;
    let lastRouteKm = null, lastRouteETAmin = null; // Ù…Ø®Ø±Ø¬Ø§Øª OSRM Ø¹Ù†Ø¯ ØªÙˆÙØ±Ù‡Ø§ 
    window.mapState = {pickup:null, dropoff:null};

    function initLeaflet(){
      if(typeof L === 'undefined'){ console.warn('Leaflet not loaded'); return; }
      if(map){ return; }
      // load stored view if any
      const stored = JSON.parse(localStorage.getItem('mapView')||'null');
      const center = stored?.center || [24.7136,46.6753];
      const zoom = stored?.zoom || 11;
      map = L.map('leafletMap', { zoomControl: true, attributionControl: true }).setView(center, zoom);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: 'Â© OpenStreetMap' }).addTo(map);
      // persist view on move
      map.on('moveend', ()=>{ const c = map.getCenter(); localStorage.setItem('mapView', JSON.stringify({center:[c.lat,c.lng], zoom: map.getZoom()})); });

      // custom divIcon as truck badge
      const truckSVG = `<?xml version="1.0"?><svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 128 64'><defs><linearGradient id='t' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='#23c7c2'/><stop offset='1' stop-color='#7ce7e2'/></linearGradient></defs><rect x='0' y='40' width='128' height='8' rx='4' fill='#cffafe'/><path d='M6 40h82c3 0 5-2 5-5v-7c0-1.2-.9-2.8-1.9-3.7l-10.5-9.6A6 6 0 0 0 76 12H58a4 4 0 0 0-4 4v6H24a10 10 0 0 0-10 10v8z' fill='url(#t)'/><circle cx='32' cy='47' r='8' fill='#0ea5a4'/><circle cx='32' cy='47' r='3.8' fill='#ecfeff'/><circle cx='96' cy='47' r='8' fill='#0ea5a4'/><circle cx='96' cy='47' r='3.8' fill='#ecfeff'/></svg>`;
      window.__truckIcon = L.divIcon({ className:'', html:`<div class="glass" style="padding:6px;border-radius:12px">${truckSVG}</div>` , iconSize:[36,36], iconAnchor:[18,18] });
      window.__dropIcon  = L.divIcon({ className:'', html:`<div class="glass" style="padding:6px;border-radius:12px;transform:scale(.95)">${truckSVG}</div>` , iconSize:[36,36], iconAnchor:[18,18] });

      map.on('click', (e)=>{
        if(!window.mapPickMode) return;
        const {lat,lng} = e.latlng;
        if(window.mapPickMode==='pickup') setPickup(lat,lng, window.__truckIcon);
        else if(window.mapPickMode==='dropoff') setDropoff(lat,lng, window.__dropIcon);
        exitMapPickMode();
        drawRouteIfReady();
        if(!(window.mapState.pickup && window.mapState.dropoff)){
          const p = window.mapState.pickup || window.mapState.dropoff; if(p && map){ map.setView([p.lat,p.lng], Math.max(14, map.getZoom())); }
        }
      });

      // bind pick buttons now that DOM exists
      const pp = document.getElementById('pickPickup');
      const pd = document.getElementById('pickDropoff');
      if(pp) pp.addEventListener('click', ()=>enterMapPickMode('pickup'));
      if(pd) pd.addEventListener('click', ()=>enterMapPickMode('dropoff'));
    }

    function enterMapPickMode(which){ window.mapPickMode = which; document.getElementById(which==='pickup'?'pickPickup':'pickDropoff').classList.add('active'); }
    function exitMapPickMode(){ ['pickPickup','pickDropoff'].forEach(id=>document.getElementById(id)?.classList.remove('active')); window.mapPickMode = null; }

    function setPickup(lat,lng, icon){
      window.mapState.pickup = {lat,lng}; if(!map) return;
      if(pickupMarker){ pickupMarker.setLatLng([lat,lng]); }
      else{ pickupMarker = L.marker([lat,lng], {icon: icon||window.__truckIcon, draggable:true}).addTo(map);
            pickupMarker.on('dragend', (ev)=>{ const p=ev.target.getLatLng(); window.mapState.pickup={lat:p.lat,lng:p.lng}; reverseGeocode(p.lat,p.lng,'pickup','pickupHint'); drawRouteIfReady(); }); }
      document.getElementById('pickupHint').textContent = `ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯ (${lat.toFixed(5)}, ${lng.toFixed(5)})`;
      reverseGeocode(lat,lng,'pickup','pickupHint');
      if(!(window.mapState.dropoff)){ map.setView([lat,lng], Math.max(14, map.getZoom())); }
    }{
      window.mapState.pickup = {lat,lng}; if(!map) return;
      if(pickupMarker){ pickupMarker.setLatLng([lat,lng]); }
      else{ pickupMarker = L.marker([lat,lng], {icon: icon||window.__truckIcon, draggable:true}).addTo(map);
            pickupMarker.on('dragend', (ev)=>{ const p=ev.target.getLatLng(); window.mapState.pickup={lat:p.lat,lng:p.lng}; document.getElementById('pickupHint').textContent = `ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (${p.lat.toFixed(5)}, ${p.lng.toFixed(5)})`; drawRouteIfReady(); }); }
      document.getElementById('pickupHint').textContent = `ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯ (${lat.toFixed(5)}, ${lng.toFixed(5)})`;
      if(!(window.mapState.dropoff)){ map.setView([lat,lng], Math.max(14, map.getZoom())); }
    }

    function setDropoff(lat,lng, icon){
      window.mapState.dropoff = {lat,lng}; if(!map) return;
      if(dropoffMarker){ dropoffMarker.setLatLng([lat,lng]); }
      else{ dropoffMarker = L.marker([lat,lng], {icon: icon||window.__dropIcon, draggable:true}).addTo(map);
            dropoffMarker.on('dragend', (ev)=>{ const p=ev.target.getLatLng(); window.mapState.dropoff={lat:p.lat,lng:p.lng}; reverseGeocode(p.lat,p.lng,'dropoff','dropoffHint'); drawRouteIfReady(); }); }
      document.getElementById('dropoffHint').textContent = `ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯ (${lat.toFixed(5)}, ${lng.toFixed(5)})`;
      reverseGeocode(lat,lng,'dropoff','dropoffHint');
      if(!(window.mapState.pickup)){ map.setView([lat,lng], Math.max(14, map.getZoom())); }
    }{
      window.mapState.dropoff = {lat,lng}; if(!map) return;
      if(dropoffMarker){ dropoffMarker.setLatLng([lat,lng]); }
      else{ dropoffMarker = L.marker([lat,lng], {icon: icon||window.__dropIcon, draggable:true}).addTo(map);
            dropoffMarker.on('dragend', (ev)=>{ const p=ev.target.getLatLng(); window.mapState.dropoff={lat:p.lat,lng:p.lng}; document.getElementById('dropoffHint').textContent = `ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (${p.lat.toFixed(5)}, ${p.lng.toFixed(5)})`; drawRouteIfReady(); }); }
      document.getElementById('dropoffHint').textContent = `ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯ (${lat.toFixed(5)}, ${lng.toFixed(5)})`;
      if(!(window.mapState.pickup)){ map.setView([lat,lng], Math.max(14, map.getZoom())); }
    }

    async function drawRouteIfReady(){
      const a = window.mapState.pickup, b = window.mapState.dropoff; if(!a||!b||!map) return;
      try{
        const url = `https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
        const res = await fetch(url, {headers:{'Accept':'application/json'}});
        const j = await res.json();
        if(j && j.routes && j.routes[0]){
          const r = j.routes[0];
          lastRouteKm = r.distance/1000; lastRouteETAmin = r.duration/60;
          const geo = L.geoJSON(r.geometry, {style:{weight:6, opacity:.95, color:'#23c7c2'}});
          if(routeLine){ map.removeLayer(routeLine); }
          routeLine = geo.addTo(map);
          map.fitBounds(geo.getBounds(), { padding:[30,30] });
          document.getElementById('estimateOut').textContent = `Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©: ~ ${Math.round(lastRouteKm)} ÙƒÙ… â€” Ø²Ù…Ù† ~ ${Math.max(1,Math.round(lastRouteETAmin))} Ø¯Ù‚ÙŠÙ‚Ø©`;
          return;
        }
      }catch(e){ console.warn('OSRM failed, fallback to straight line', e); }
      // fallback Ø¥Ù„Ù‰ Ø®Ø· Ù…Ø³ØªÙ‚ÙŠÙ…
      const latlngs = [ [a.lat,a.lng], [b.lat,b.lng] ];
      if(routeLine){ routeLine.setLatLngs(latlngs); } else { routeLine = L.polyline(latlngs, {weight:6, opacity:.95, color:'#23c7c2'}).addTo(map); }
      map.fitBounds(routeLine.getBounds(), { padding:[30,30] });
      lastRouteKm = kmBetween(); lastRouteETAmin = null;
      document.getElementById('estimateOut').textContent = `Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©: ~ ${lastRouteKm} ÙƒÙ…`;
    }
      else { routeLine = L.polyline(latlngs, {weight:6, opacity:.95, color:'#23c7c2'}).addTo(map); }
      map.fitBounds(routeLine.getBounds(), { padding:[30,30] });
      document.getElementById('estimateOut').textContent = `Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©: ~ ${kmBetween()} ÙƒÙ…`;
    }

    function fitToMarkersOrRoute(){
      const a = window.mapState?.pickup, b = window.mapState?.dropoff;
      if(a && b && routeLine){ map.fitBounds(routeLine.getBounds(), {padding:[30,30]}); return; }
      if(a){ map.setView([a.lat,a.lng], Math.max(14, map.getZoom())); return; }
      if(b){ map.setView([b.lat,b.lng], Math.max(14, map.getZoom())); return; }
      const stored = JSON.parse(localStorage.getItem('mapView')||'null'); if(stored?.center){ map.setView(stored.center, stored.zoom||11); }
    }
    function recenterMap(){ const stored = JSON.parse(localStorage.getItem('mapView')||'null'); if(stored?.center){ map.setView(stored.center, stored.zoom||11); } else { map.setView([24.7136,46.6753], 11); } }
      async function reverseGeocode(lat,lng, fieldId, hintId){
      try{
        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&accept-language=ar&zoom=18`;
        const res = await fetch(url, {headers:{'Accept':'application/json'}});
        const j = await res.json();
        const txt = j && (j.display_name || j.name);
        if(txt){ const fld = document.getElementById(fieldId); if(fld && (!fld.value||fld.value.length<5)) fld.value = txt; const hint = document.getElementById(hintId); if(hint){ hint.textContent = txt; } }
      }catch(e){ /* ØµØ§Ù…Øª */ }
    }

    function toast(msg){ const t=document.getElementById('toast'); if(!t) return; t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }
      function useMyLocation(){
      if(!navigator.geolocation){ alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹'); return; }
      navigator.geolocation.getCurrentPosition((pos)=>{
        const {latitude:lat, longitude:lng} = pos.coords;
        if(map){ map.setView([lat,lng], 14); }
        setPickup(lat,lng);
        reverseGeocode(lat,lng,'pickup','pickupHint');
        drawRouteIfReady();
      }, (err)=>{ alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹: '+ err.message); }, {enableHighAccuracy:true, timeout:8000, maximumAge:0});
    }

    // === Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø¨Ø³ÙŠØ·Ø© ===
    (function(){ try{
      console.assert(typeof estimate==='function','estimate Ù…ÙˆØ¬ÙˆØ¯Ø©');
      const p0=S.pricing.kmRate; S.pricing.kmRate=5; const t1=estimate(); S.pricing.kmRate=p0; console.assert(typeof t1==='number','estimate ØªÙØ¹ÙŠØ¯ Ø±Ù‚Ù…');
    }catch(_){} })();
      function useMyLocation(){
      if(!navigator.geolocation){ alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹'); return; }
      navigator.geolocation.getCurrentPosition((pos)=>{
        const {latitude:lat, longitude:lng} = pos.coords;
        if(map){ map.setView([lat,lng], 14); }
        setPickup(lat,lng); reverseGeocode(lat,lng,'pickup','pickupHint'); drawRouteIfReady();
      }, (err)=>{ alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹: '+ err.message); }, {enableHighAccuracy:true, timeout:8000, maximumAge:0});
    }
    function useMyLocationDrop(){
      if(!navigator.geolocation){ alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹'); return; }
      navigator.geolocation.getCurrentPosition((pos)=>{
        const {latitude:lat, longitude:lng} = pos.coords;
        if(map){ map.setView([lat,lng], 14); }
        setDropoff(lat,lng); reverseGeocode(lat,lng,'dropoff','dropoffHint'); drawRouteIfReady();
      }, (err)=>{ alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹: '+ err.message); }, {enableHighAccuracy:true, timeout:8000, maximumAge:0});
    }
    function copyCoords(which){
      const p = which==='pickup'? window.mapState.pickup : window.mapState.dropoff;
      if(!p){ alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ù‚Ø·Ø© Ø¨Ø¹Ø¯'); return; }
      const txt = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`;
      navigator.clipboard?.writeText(txt).then(()=>toast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª')).catch(()=>alert(txt));
    }
  </script>
</body>
</html>
