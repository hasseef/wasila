<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#1B6AA5" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>وسيلة — تطبيق سيارات الحوض</title>

  <!-- خط عربي -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Tajawal','ui-sans-serif','system-ui'] },
          colors: { waseela: { primary:'#1B6AA5', secondary:'#10B981', ink:'#0f172a' } },
          boxShadow:{ soft:'0 12px 30px rgba(27,106,165,.12)' },
          borderRadius:{ '2xl':'1rem' }
        }
      }
    }
  </script>

  <!-- Leaflet (خريطة) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html,body { height:100%; background:#f7fafc }
    body { font-family:"Tajawal",sans-serif }
    #app { min-height:100%; padding-bottom: 64px } /* مساحة للتاب بار */
    #map { height: calc(100dvh - 56px - 16px - 180px); border-radius: 16px; }
    .grad-primary{ background: linear-gradient(135deg,#1B6AA5 0%, #0ea5e9 50%, #10B981 100%) }
    .safe-top{ padding-top: env(safe-area-inset-top) }
    .safe-bottom{ padding-bottom: env(safe-area-inset-bottom) }
    .sheet{ position: fixed; inset-inline: 0; bottom: 56px; z-index: 30; display:none }
    .sheet-card{ border-top-left-radius: 18px; border-top-right-radius: 18px }
    .drag-handle{ width: 40px; height: 4px; background:#cbd5e1; border-radius: 999px; margin: 8px auto }
    .tabbar{ height:56px }
    .pill { padding:2px 8px; border-radius:999px; font-size:11px; }
  </style>
</head>
<body class="text-waseela-ink">
  <div id="app" class="safe-top">

    <!-- Header -->
    <header class="px-4 py-2 bg-white shadow-sm sticky top-0 z-40">
      <div class="max-w-screen-md mx-auto flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="inline-flex items-center justify-center w-9 h-9 rounded-xl grad-primary shadow-soft">
            <svg viewBox="0 0 24 24" class="w-5 h-5 text-white" fill="currentColor" aria-hidden="true">
              <path d="M3 13.5a2.5 2.5 0 1 0 2.45 2H18a2.5 2.5 0 1 0 2.45-2H21v-2.25a2.25 2.25 0 0 0-2.25-2.25H15V6.75A1.75 1.75 0 0 0 13.25 5h-2.5A1.75 1.75 0 0 0 9 6.75V9H5.25A2.25 2.25 0 0 0 3 11.25V13.5Zm6-4.5V6.75c0-.138.112-.25.25-.25h2.5c.138 0 .25.112.25.25V9H9Z"/>
            </svg>
          </span>
          <div>
            <div class="text-lg font-extrabold tracking-tight text-waseela-primary">وسيلة</div>
            <div class="text-[11px] -mt-0.5 text-gray-500">تشغيل سيارات الحوض</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button id="modePickup" class="pill bg-blue-50 text-blue-700 border border-blue-200">تحديد التحميل</button>
          <button id="modeDrop"   class="pill bg-emerald-50 text-emerald-700 border border-emerald-200">تحديد التفريغ</button>
          <button id="ctaTop" class="px-3 py-2 rounded-lg text-white grad-primary text-sm shadow-soft">طلب حوض</button>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="px-4 pt-3 pb-4 max-w-screen-md mx-auto">
      <!-- حالة بسيطة -->
      <section class="bg-white rounded-2xl shadow-soft p-3 mb-3 text-sm flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="pill bg-gray-100 text-gray-600">المسافة: <b id="distanceKm">—</b> كم</span>
          <span class="pill bg-gray-100 text-gray-600">السعر: <b id="price">—</b> ر.س</span>
        </div>
        <button id="locateBtn" class="text-blue-600 underline">موقعي</button>
      </section>

      <!-- خريطة -->
      <section class="bg-white rounded-2xl shadow-soft p-2">
        <div id="map" class="w-full"></div>
        <div class="px-2 py-2 text-[12px] text-gray-500">
          اختر الوضع بالأزرار العلوية ثم انقر على الخريطة لتحديد <b>التحميل</b> أو <b>التفريغ</b>.
        </div>
      </section>
    </main>

    <!-- Bottom Sheet: نموذج الحجز -->
    <div class="sheet px-3 safe-bottom" id="sheet">
      <div class="sheet-card bg-white shadow-2xl border border-gray-100 max-w-screen-md mx-auto">
        <div class="drag-handle"></div>
        <div class="p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-base font-extrabold">طلب حوض</h2>
            <button id="closeSheet" class="text-gray-500 text-sm">إخفاء</button>
          </div>

          <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="col-span-2">
              <label class="block text-gray-700">التحميل</label>
              <input id="pickupText" type="text" placeholder="مثال: مستودع شمال"
                     class="mt-1 w-full border rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-waseela-primary/40"/>
              <div id="pickupMeta" class="text-[11px] text-gray-500 mt-1"></div>
            </div>
            <div class="col-span-2">
              <label class="block text-gray-700">التفريغ</label>
              <input id="dropText" type="text" placeholder="مثال: صناعية السلي"
                     class="mt-1 w-full border rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-waseela-primary/40"/>
              <div id="dropMeta" class="text-[11px] text-gray-500 mt-1"></div>
            </div>
            <div>
              <label class="block text-gray-700">الوزن (كجم)</label>
              <input id="weight" type="number" placeholder="800"
                     class="mt-1 w-full border rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-waseela-primary/40"/>
            </div>
            <div>
              <label class="block text-gray-700">التاريخ</label>
              <input id="date" type="datetime-local"
                     class="mt-1 w-full border rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-waseela-primary/40"/>
            </div>
            <div class="col-span-2">
              <label class="block text-gray-700">ملاحظات</label>
              <textarea id="notes" rows="2" placeholder="تفاصيل إضافية…"
                        class="mt-1 w-full border rounded-xl p-3 focus:outline-none focus:ring-2 focus:ring-waseela-primary/40"></textarea>
            </div>
          </div>

          <button id="nextConfirm"
                  class="mt-3 w-full px-6 py-3 rounded-xl text-white grad-primary shadow-soft">
            متابعة للتأكيد
          </button>

          <div class="mt-3 text-[12px] text-gray-500">
            تقدير السعر الحالي: <b id="priceInline">—</b> ر.س (يتحدّث حسب المسافة/الوزن)
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Sheet: تأكيد نهائي -->
    <div class="sheet px-3 safe-bottom" id="confirmSheet">
      <div class="sheet-card bg-white shadow-2xl border border-gray-100 max-w-screen-md mx-auto">
        <div class="drag-handle"></div>
        <div class="p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-base font-extrabold">تأكيد الطلب</h2>
            <button id="closeConfirm" class="text-gray-500 text-sm">إغلاق</button>
          </div>

          <div id="summary" class="bg-gray-50 rounded-xl p-3 text-sm"></div>

          <div class="flex gap-3 mt-3">
            <button id="confirmBtn" class="flex-1 px-6 py-3 rounded-xl text-white grad-primary shadow-soft">
              تأكيد الحجز
            </button>
            <button id="backBtn" class="flex-1 px-6 py-3 rounded-xl border">رجوع</button>
          </div>

          <div id="afterConfirm" class="hidden mt-3 p-3 rounded-xl bg-emerald-50 text-emerald-900 border border-emerald-200 text-sm">
            تم إنشاء الحجز: <b id="rideId"></b>.
            <div class="mt-2 flex items-center gap-2">
              <a id="callDriver" href="tel:0550000000"
                 class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">اتصال بالسائق</a>
              <a id="smsDriver" href="sms:0550000000" class="text-emerald-700 underline">رسالة نصية</a>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Bottom Tab Bar -->
    <nav class="tabbar fixed bottom-0 inset-x-0 bg-white border-t shadow-sm z-40 safe-bottom">
      <div class="max-w-screen-md mx-auto grid grid-cols-4">
        <button class="py-2 flex flex-col items-center gap-0.5 text-blue-600" id="tabHome">
          <svg viewBox="0 0 24 24" class="w-6 h-6" fill="currentColor"><path d="M12 3l9 8h-3v9H6v-9H3l9-8z"/></svg>
          <span class="text-[11px]">الرئيسية</span>
        </button>
        <button class="py-2 flex flex-col items-center gap-0.5 text-gray-600" id="tabOrders">
          <svg viewBox="0 0 24 24" class="w-6 h-6" fill="currentColor"><path d="M7 4h10a2 2 0 0 1 2 2v14l-7-3-7 3V6a2 2 0 0 1 2-2z"/></svg>
          <span class="text-[11px]">طلباتي</span>
        </button>
        <button class="py-2 flex flex-col items-center gap-0.5 text-gray-600" id="tabWallet">
          <svg viewBox="0 0 24 24" class="w-6 h-6" fill="currentColor"><path d="M2 7a3 3 0 0 1 3-3h13a2 2 0 0 1 2 2v2h-2V6H5a1 1 0 0 0-1 1v1h15a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V7z"/></svg>
          <span class="text-[11px]">المحفظة</span>
        </button>
        <button class="py-2 flex flex-col items-center gap-0.5 text-gray-600" id="tabProfile">
          <svg viewBox="0 0 24 24" class="w-6 h-6" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5.33 0-8 2.667-8 6v2h16v-2c0-3.333-2.67-6-8-6z"/></svg>
          <span class="text-[11px]">حسابي</span>
        </button>
      </div>
    </nav>

  </div>

  <!-- Scripts -->
  <script>
    /* إعدادات التسعير */
    const BASE = 15, PER_KM = 1.2, PER_KG = 0.05

    /* خريطة */
    const map = L.map('map', { zoomControl:false }).setView([24.7136,46.6753], 11)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution: '© OpenStreetMap'
    }).addTo(map)

    /* وضع التحديد */
    let mode = 'pickup' // pickup | drop
    let pickup = null, drop = null
    let pickupMarker, dropMarker

    const modePickupBtn = document.getElementById('modePickup')
    const modeDropBtn   = document.getElementById('modeDrop')
    const distanceEl = document.getElementById('distanceKm')
    const priceEl = document.getElementById('price')
    const priceInline = document.getElementById('priceInline')

    modePickupBtn.addEventListener('click', ()=>{ mode='pickup'; flash(modePickupBtn) })
    modeDropBtn.addEventListener('click',   ()=>{ mode='drop';   flash(modeDropBtn)   })

    function flash(btn){ btn.classList.add('ring-2','ring-blue-300'); setTimeout(()=>btn.classList.remove('ring-2','ring-blue-300'),400) }

    map.on('click', (e)=>{
      if(mode==='pickup'){
        pickup = e.latlng
        if(pickupMarker) pickupMarker.remove()
        pickupMarker = L.marker(pickup, {title:'التحميل'}).addTo(map)
        document.getElementById('pickupMeta').textContent = `إحداثيات التحميل: ${pickup.lat.toFixed(5)}, ${pickup.lng.toFixed(5)}`
      }else{
        drop = e.latlng
        if(dropMarker) dropMarker.remove()
        dropMarker = L.marker(drop, {title:'التفريغ'}).addTo(map)
        document.getElementById('dropMeta').textContent = `إحداثيات التفريغ: ${drop.lat.toFixed(5)}, ${drop.lng.toFixed(5)}`
      }
      updateEstimates()
    })

    /* تحديد موقعي */
    document.getElementById('locateBtn').addEventListener('click', ()=>{
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          const {latitude,longitude}=pos.coords
          map.setView([latitude,longitude], 13)
          // اجعل الموقع الحالي كنقطة تحميل إذا لم تُحدد
          if(!pickup){
            pickup = {lat:latitude, lng:longitude}
            if(pickupMarker) pickupMarker.remove()
            pickupMarker = L.marker(pickup).addTo(map)
            document.getElementById('pickupMeta').textContent = `إحداثيات التحميل: ${pickup.lat.toFixed(5)}, ${pickup.lng.toFixed(5)}`
            updateEstimates()
          }
        })
      } else { alert('المتصفح لا يدعم تحديد الموقع') }
    })

    /* تقديرات */
    function haversine(a,b){
      const toRad = d=>d*Math.PI/180
      const R=6371 // كم
      const dLat = toRad(b.lat - a.lat)
      const dLon = toRad(b.lng - a.lng)
      const lat1 = toRad(a.lat)
      const lat2 = toRad(b.lat)
      const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2
      return 2*R*Math.asin(Math.sqrt(h))
    }

    function updateEstimates(){
      const weight = Number(document.getElementById('weight')?.value || 0)
      let km = (pickup && drop) ? haversine(pickup, drop) : 0
      km = Math.round(km * 10) / 10
      const price = Math.max(0, BASE + km*PER_KM + weight*PER_KG).toFixed(2)
      distanceEl.textContent = isNaN(km)? '—' : km
      priceEl.textContent = price
      priceInline.textContent = price
    }

    /* Sheets */
    const sheet = document.getElementById('sheet')
    const confirmSheet = document.getElementById('confirmSheet')
    const openSheet = () => { sheet.style.display='block' }
    const closeSheet = () => { sheet.style.display='none' }
    const openConfirm = () => { confirmSheet.style.display='block' }
    const closeConfirm = () => { confirmSheet.style.display='none' }

    document.getElementById('ctaTop').addEventListener('click', ()=>{ openSheet(); scrollTo({top:0,behavior:'smooth'}) })
    document.getElementById('closeSheet').addEventListener('click', closeSheet)

    // الحقول داخل الشيت
    const pickupText = document.getElementById('pickupText')
    const dropText   = document.getElementById('dropText')
    const weightEl   = document.getElementById('weight')
    const dateEl     = document.getElementById('date')
    const notesEl    = document.getElementById('notes')

    // انتقال للتأكيد
    document.getElementById('nextConfirm').addEventListener('click', ()=>{
      // تحقق بسيط
      if(!pickup || !drop){ alert('يرجى تحديد موقعي التحميل والتفريغ من الخريطة.'); return }
      // ملخص
      const km = (pickup && drop) ? (Math.round(haversine(pickup, drop)*10)/10) : 0
      const price = Math.max(0, BASE + km*PER_KM + Number(weightEl.value||0)*PER_KG).toFixed(2)
      const summary = `
        <div><b>التحميل:</b> ${pickupText.value || '—'} <span class="text-gray-500">(${pickup.lat.toFixed(5)}, ${pickup.lng.toFixed(5)})</span></div>
        <div><b>التفريغ:</b> ${dropText.value || '—'} <span class="text-gray-500">(${drop.lat.toFixed(5)}, ${drop.lng.toFixed(5)})</span></div>
        <div><b>المسافة:</b> ${km} كم</div>
        <div><b>الوزن:</b> ${Number(weightEl.value||0)} كجم</div>
        <div><b>التاريخ:</b> ${dateEl.value || '—'}</div>
        <div><b>ملاحظات:</b> ${notesEl.value || '—'}</div>
        <div class="mt-2 text-emerald-700"><b>السعر التقديري:</b> ${price} ر.س</div>
      `
      document.getElementById('summary').innerHTML = summary
      closeSheet(); openConfirm()
    })

    document.getElementById('backBtn').addEventListener('click', ()=>{ closeConfirm(); openSheet() })
    document.getElementById('closeConfirm').addEventListener('click', closeConfirm)

    // تأكيد نهائي
    document.getElementById('confirmBtn').addEventListener('click', ()=>{
      const id = 'R-' + Math.floor(Math.random()*9000+1000)
      document.getElementById('rideId').textContent = id
      document.getElementById('afterConfirm').classList.remove('hidden')
    })

    // تبويب سفلي
    ['tabHome','tabOrders','tabWallet','tabProfile'].forEach(id=>{
      document.getElementById(id).addEventListener('click', ()=>{
        if(id==='tabHome'){ window.scrollTo({top:0,behavior:'smooth'}) }
        else alert('هذه الواجهة تجريبية — سيتم تفعيلها لاحقًا.')
      })
    })

    // افتح نموذج الحجز مباشرة على الشاشات الصغيرة
    if (window.matchMedia('(max-width: 640px)').matches) openSheet()

    // تحدّث السعر عند تغيير الوزن
    weightEl.addEventListener('input', updateEstimates)
  </script>
</body>
</html>
