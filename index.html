<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>وسيلة — نموذج أولي لحسابات التطبيق</title>
  <style>
    :root{
      /* ألوان وسيلة المعتمدة */
      --bg:#0e0f12; --card:#14161a; --muted:#9aa3af; --text:#e7eaf0; --brand:#36cfc9; --brand-2:#7c7cf5; --danger:#ef4444;
      --ok:#22c55e; --warn:#f59e0b; --b:#1f2937; --ring:#3b82f6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0c0d10,#0b1218 60%,#0c0f16);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Naskh Arabic",Tahoma,sans-serif;}
    a{color:inherit}
    .container{max-width:1200px;margin:auto;padding:16px}
    header{position:sticky;top:0;background:rgba(12,14,18,.7);backdrop-filter:blur(8px);z-index:50;border-bottom:1px solid #1f2937}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:36px;height:36px;border-radius:10px;background:conic-gradient(from 20deg,var(--brand),var(--brand-2));box-shadow:0 0 0 2px #0b0e14 inset}
    .logoImg{width:36px;height:36px;border-radius:10px;object-fit:cover;display:none;box-shadow:0 0 0 2px #0b0e14 inset}
    .logoImg.hidden{display:none}
    .title{font-weight:700;letter-spacing:.2px}

    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid #1f2937;border-radius:16px;padding:18px}
    .card h3{margin:0 0 10px 0}

    .accounts{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .btn{width:100%;padding:14px;border-radius:12px;border:1px solid #2b3240;background:#12161e;cursor:pointer;color:var(--text);font-weight:600}
    .btn:hover{border-color:var(--brand-2)}

    .workbench{display:grid;grid-template-columns:1fr 420px;gap:16px}
    .mapWrap{position:relative;min-height:420px;border-radius:16px;overflow:hidden;border:1px solid #1f2937;background:#0b1118}
    .mapFake{position:absolute;inset:0;z-index:1;background-image:radial-gradient(#1a2634 1px, transparent 1px);background-size:18px 18px;display:flex;align-items:center;justify-content:center;color:#9fb3c8;font-weight:700;letter-spacing:1px}
    .panel{position:relative;z-index:2}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field{display:grid;gap:6px;margin-bottom:10px}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;background:#0f1420;border:1px solid #243044;color:var(--text)}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--ring);box-shadow:0 0 0 4px rgba(124,124,245,.15)}
    .muted{color:var(--muted);font-size:13px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .primary{background:linear-gradient(180deg,var(--brand),var(--brand-2));border:none}
    .ghost{background:transparent;border:1px dashed #374151}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 12px}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid #2b3240;background:#12161e;cursor:pointer}
    .tab.active{border-color:var(--brand-2);box-shadow:0 0 0 4px rgba(124,124,245,.15)}

    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .stat{padding:14px;border-radius:12px;border:1px solid #273043;background:#0f1420}
    .stat b{font-size:22px}

    footer{margin:24px 0 12px;color:#8a93a3;font-size:12px}

    @media (max-width: 1100px){.workbench{grid-template-columns:1fr}}
    @media (max-width: 860px){.accounts{grid-template-columns:repeat(2,1fr)}}
    @media (max-width: 460px){.accounts{grid-template-columns:1fr}}

    .mapCollapsed .mapWrap{display:none}

    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #2b3240}
  </style>
</head>
<body>
  <header>
    <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px;min-height:64px">
      <div class="brand">
        <img id="appLogo" class="logoImg" alt="وسيلة" />
        <div class="logo" aria-hidden="true" title="Fallback"></div>
        <div>
          <div class="title">وسيلة — نموذج أولي لحسابات التطبيق</div>
          <div class="muted" id="envNote">نسخة عرض أولية — بدون أي بيانات حقيقية</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn ghost" id="toggleMapBtn" title="إظهار / إخفاء الخريطة">إظهار/إخفاء الخريطة</button>
        <button class="btn" onclick="location.hash='#landing'">الواجهة الرئيسية</button>
      </div>
    </div>
  </header>

  <main class="container">

    <!-- Landing / Accounts entry -->
    <section id="landing" class="card">
      <h3>عنوان: نموذج أولي لحسابات تطبيق وسيلة <span class="badge" style="border-color:var(--ok)">كل الحسابات مُفعلة ✅</span></h3>
      <p class="muted">اختر الحساب الذي تريد الدخول إليه للتجربة:</p>
      <div class="accounts" style="margin-top:10px">
        <button class="btn" onclick="openView('shipper')">حساب العملاء (طالِب الخدمة)</button>
        <button class="btn" onclick="openView('owner')">حساب أصحاب الونيتات (تسجيل المركبة)</button>
        <button class="btn" onclick="openView('driver')">حساب السائقين</button>
        <button class="btn" onclick="openView('admin')">حساب إدارة التطبيق</button>
        <button class="btn" onclick="openView('ownersList')">قائمة الملاك</button>
      </div>
    </section>

    <!-- Shipper workspace -->
    <section id="shipper" class="card" hidden>
      <div class="tabs">
        <button class="tab active" data-target="shipperBench">طلب جديد</button>
        <button class="tab" data-target="shipper-orders">طلباتي</button>
      </div>

      <div class="workbench" id="shipperBench">
        <div class="mapWrap">
          <div class="mapFake">خريطة تجريبية (مكان الخريطة الفعلية مستقبلاً)</div>
        </div>
        <div class="panel card">
          <h3>طلب توصيل <span class="badge" style="border-color:var(--ok);">مُفعل ✅</span></h3>
          <div class="field">
            <label>نقطة الاستلام</label>
            <input id="pickup" placeholder="المدينة، الحي، الشارع" />
          </div>
          <div class="field">
            <label>نقطة التسليم</label>
            <input id="dropoff" placeholder="المدينة، الحي، الشارع" />
          </div>
          <div class="row">
            <div class="field">
              <label>حجم/نوع المنقول</label>
              <select id="cargoSize">
                <option value="small">صغير (صناديق خفيفة)</option>
                <option value="medium">متوسط (أثاث خفيف)</option>
                <option value="big">كبير (أثاث ثقيل/معدات)</option>
              </select>
            </div>
            <div class="field">
              <label>موعد التنفيذ</label>
              <input type="datetime-local" id="when" />
            </div>
          </div>
          <div class="field">
            <label>ملاحظات إضافية</label>
            <textarea id="notes" rows="3" placeholder="وصف مختصر"></textarea>
          </div>
          <div class="actions">
            <button class="btn primary" onclick="estimate()">تقدير السعر</button>
            <button class="btn" onclick="submitOrder()">إرسال الطلب</button>
            <span class="muted" id="estimateOut"></span>
          </div>
        </div>
      </div>

      <div id="shipper-orders" hidden>
        <div class="card">
          <h3>طلباتي</h3>
          <div id="ordersList" class="muted">لا توجد طلبات بعد.</div>
        </div>
      </div>
    </section>

    <!-- Owners (pickup truck owners) registration -->
    <section id="owner" class="card" hidden>
      <h3>تسجيل أصحاب الونيتات <span class="badge" style="border-color:var(--ok);">مُفعل ✅</span></h3>
      <p class="muted">يرجى تعبئة بيانات المركبة والسائق بدقة. هذه نسخة تجريبية ولا يتم رفع ملفات فعلية.</p>
      <div class="row">
        <div class="card">
          <h4>بيانات المركبة</h4>
          <div class="field">
            <label>نوع المركبة</label>
            <select id="vehType">
              <option>وانيت حوض صغير</option>
              <option>وانيت حوض كبير</option>
              <option>دينا</option>
              <option>قفص/مغطى</option>
            </select>
          </div>
          <div class="row">
            <div class="field">
              <label>رقم اللوحة</label>
              <input id="plate" placeholder="مثال: س ع ل 1234"/>
            </div>
            <div class="field">
              <label>موديل (سنة الصنع)</label>
              <input id="modelYear" type="number" min="1990" max="2026" placeholder="2019"/>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>المنطقة</label>
              <select id="region">
                <option>منطقة حائل</option>
                <option>منطقة الرياض</option>
                <option>منطقة مكة المكرمة</option>
                <option>المنطقة الشرقية</option>
                <option>المدينة المنورة</option>
                <option>القصيم</option>
                <option>تبوك</option>
                <option>عسير</option>
                <option>جازان</option>
                <option>نجران</option>
                <option>الباحة</option>
                <option>الجوف</option>
                <option>الحدود الشمالية</option>
              </select>
            </div>
            <div class="field">
              <label>الصورة (واجهة المركبة)</label>
              <input type="file" id="vehFront" accept="image/*" />
            </div>
          </div>
        </div>

        <div class="card">
          <h4>بيانات السائق</h4>
          <div class="row">
            <div class="field">
              <label>الاسم الثلاثي</label>
              <input id="driverName" placeholder="الاسم الكامل"/>
            </div>
            <div class="field">
              <label>رقم الهوية</label>
              <input id="nid" placeholder="10 أرقام" maxlength="10"/>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>رقم رخصة القيادة</label>
              <input id="licenseNo" placeholder="رقم الرخصة"/>
            </div>
            <div class="field">
              <label>تاريخ انتهاء الرخصة</label>
              <input id="licenseExp" type="date"/>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>نسخة الرخصة (صورة)</label>
              <input type="file" id="licenseImg" accept="image/*"/>
            </div>
            <div class="field">
              <label>IBAN للحوالات</label>
              <input id="iban" placeholder="SA.."/>
            </div>
          </div>
          <div class="actions">
            <button class="btn primary" onclick="saveOwner()">حفظ التسجيل</button>
            <span class="muted" id="ownerSaved"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- Owners list (enabled overview) -->
    <section id="ownersList" class="card" hidden>
      <h3>قائمة الملاك <span class="badge" style="border-color:var(--ok);">مُفعلة ✅</span></h3>
      <div id="ownersTable" class="muted">لا يوجد مُلاك بعد.</div>
    </section>

    <!-- Drivers account -->
    <section id="driver" class="card" hidden>
      <h3>حساب السائق <span class="badge" style="border-color:var(--ok);">مُفعل ✅</span></h3>
      <div class="row">
        <div class="card">
          <h4>الملف الشخصي</h4>
          <div class="field"><label>الاسم</label><input id="dName" placeholder="اسم السائق"/></div>
          <div class="row">
            <div class="field"><label>الهاتف</label><input id="dPhone" placeholder="05xxxxxxxx"/></div>
            <div class="field"><label>المدينة</label><input id="dCity" placeholder="مثال: حائل"/></div>
          </div>
          <div class="row">
            <div class="field"><label>الرخصة (صورة)</label><input type="file" id="dLicenseFile" accept="image/*"/></div>
            <div class="field"><label>إقامة/هوية (صورة)</label><input type="file" id="dIdFile" accept="image/*"/></div>
          </div>
          <div class="actions">
            <button class="btn primary" onclick="saveDriver()">حفظ</button>
            <label class="tab" style="display:inline-flex;align-items:center;gap:6px">
              <input type="checkbox" id="availableToggle" onchange="toggleAvail()"/>
              متاح لاستلام الطلبات
            </label>
          </div>
          <div class="muted" id="driverSaved"></div>
        </div>
        <div class="card">
          <h4>طلبات قريبة</h4>
          <div class="muted">تظهر هنا الطلبات ضمن نطاق 10 كم (تجريبي).</div>
          <ul id="nearbyList"></ul>
          <div class="actions"><span class="muted">اختر طلبًا ثم اضغط قبول</span></div>
        </div>
      </div>
    </section>

    <!-- Admin -->
    <section id="admin" class="card" hidden>
      <h3>لوحة إدارة التطبيق <span class="badge" style="border-color:var(--ok);">مُفعلة ✅</span></h3>
      <div class="stats">
        <div class="stat"><div class="muted">عدد العملاء</div><b id="stUsers">0</b></div>
        <div class="stat"><div class="muted">طلبات اليوم</div><b id="stOrders">0</b></div>
        <div class="stat"><div class="muted">سائقون متاحون</div><b id="stDrivers">0</b></div>
        <div class="stat"><div class="muted">مركبات مسجلة</div><b id="stVehicles">0</b></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>إدارة المناطق والتسعير</h4>
        <div class="row">
          <div class="field"><label>تعرفة الكيلومتر (ريال)</label><input id="kmRate" type="number" step="0.5" value="3"/></div>
          <div class="field"><label>رسوم فتح الطلب (ريال)</label><input id="baseFee" type="number" step="1" value="20"/></div>
        </div>
        <div class="actions">
          <button class="btn primary" onclick="savePricing()">حفظ التسعير</button>
          <span class="muted" id="pricingSaved"></span>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>سجل الطلبات (تجريبي)</h4>
        <div id="adminOrders" class="muted">لا توجد بيانات.</div>
        <template id="orderRowTmpl">
          <div class="card" data-id="">
            <div><b class="from"></b> → <b class="to"></b> <span class="badge status"></span></div>
            <div class="muted time"></div>
            <div class="actions">
              <button class="btn" data-action="complete">إكمال</button>
              <button class="btn ghost" data-action="cancel">إلغاء</button>
            </div>
          </div>
        </template>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>اختبارات تلقائية</h4>
        <p class="muted">للتحقق من وظائف الملاحة والتبويبات وتدفق حالة الطلب.</p>
        <div id="testResults"></div>
        <div class="actions"><button class="btn" id="runTestsBtn">تشغيل الاختبارات</button></div>
      </div>
    </section>

  </main>

  <footer class="container">
    <div>© وسيلة — نموذج أولي للاستخدام الداخلي.</div>
  </footer>

  <script>
    // ---- Simple state (global) ----
    const S = {
      orders: JSON.parse(localStorage.getItem('orders')||'[]'),
      owners: JSON.parse(localStorage.getItem('owners')||'[]'),
      drivers: JSON.parse(localStorage.getItem('drivers')||'[]'),
      pricing: JSON.parse(localStorage.getItem('pricing')||'{"kmRate":3,"baseFee":20}')
    };
    // حالة الطلب: new, assigned, in_progress, completed, cancelled

    // ---- Define openView EARLY so inline onclick & router can use it ----
    window.openView = function openView(id){
      document.querySelectorAll('main > section').forEach(sec=>sec.hidden = true);
      const el = document.getElementById(id) || document.getElementById('landing');
      el.hidden = false;
      location.hash = '#'+(id||'landing');
      document.body.classList.remove('mapCollapsed');
      updateUI();
    }

    // ---- DOM bootstrap ----
    document.addEventListener('DOMContentLoaded', ()=>{
      // tabs behavior
      document.querySelectorAll('.tabs .tab').forEach(tab=>{
        tab.addEventListener('click', ()=>{
          const wrap = tab.closest('section');
          wrap.querySelectorAll('.tabs .tab').forEach(t=>t.classList.remove('active'));
          tab.classList.add('active');
          const target = tab.dataset.target;
          if(target){
            wrap.querySelectorAll('#shipperBench,#shipper-orders').forEach(v=>v.hidden=true);
            const tgt = wrap.querySelector('#'+target);
            if(tgt){ tgt.closest('div').hidden=false; }
          }
        });
      });

      // map toggle
      const tgl = document.getElementById('toggleMapBtn');
      if(tgl){ tgl.addEventListener('click',()=>{ document.body.classList.toggle('mapCollapsed'); }); }

      // router
      function route(){
        const h = location.hash.replace('#','');
        if(['shipper','owner','driver','admin','landing','ownersList'].includes(h)) window.openView(h); else window.openView('landing');
      }
      window.addEventListener('hashchange', route);

      // logo autodetect
      autoDetectLogo();

      // boot: Always return to landing on load (ignores any pre-existing hash)
      history.replaceState(null, '', location.pathname);
      openView('landing');
      updateUI();

      // tests
      const testBtn = document.getElementById('runTestsBtn');
      if(testBtn){ testBtn.addEventListener('click', runTests); }
    });

    function kmBetween(){ return 2 + Math.round(Math.random()*12); }

    function estimate(){
      const km = kmBetween();
      const r = S.pricing.kmRate || 3; const base = S.pricing.baseFee || 20;
      const size = document.getElementById('cargoSize').value;
      const multiplier = size==='big'?1.8:size==='medium'?1.3:1;
      const price = Math.round((base + km*r)*multiplier);
      document.getElementById('estimateOut').textContent = `تقدير: ~ ${price} ريال لمسافة ${km} كم`;
      return price;
    }

    function submitOrder(){
      const data = {
        pickup: val('pickup'), dropoff: val('dropoff'), when: val('when'), notes: val('notes'), size: val('cargoSize'),
        price: estimate(), id: Date.now(), status: 'new', driverId: null
      };
      if(!data.pickup||!data.dropoff){alert('يرجى إدخال الاستلام والتسليم');return}
      S.orders.unshift(data);
      persist();
      document.getElementById('estimateOut').textContent = 'تم إرسال الطلب.';
      updateUI();
      const tab = document.querySelector('#shipper .tabs .tab[data-target="shipper-orders"]');
      if(tab) tab.click();
    }

    function saveOwner(){
      const rec = {
        vehType: val('vehType'), plate: val('plate'), modelYear: val('modelYear'), region: val('region'),
        driverName: val('driverName'), nid: val('nid'), licenseNo: val('licenseNo'), licenseExp: val('licenseExp'), iban: val('iban'),
        id: Date.now()
      };
      S.owners.unshift(rec); persist();
      byId('ownerSaved').textContent = 'تم الحفظ.'; updateUI();
    }

    function saveDriver(){
      const d = {name: val('dName'), phone: val('dPhone'), city: val('dCity'), available: byId('availableToggle').checked, id: Date.now()};
      S.drivers.unshift(d); persist();
      byId('driverSaved').textContent = 'تم الحفظ.'; updateUI();
    }

    function toggleAvail(){updateUI()}

    function savePricing(){
      S.pricing = {kmRate: +val('kmRate')||3, baseFee: +val('baseFee')||20};
      persist();
      byId('pricingSaved').textContent = 'تم تحديث التسعير.';
    }

    // السائق يقبل طلب
    function driverAccept(orderId){
      const d = S.drivers[0]; // لأغراض التجربة: أول سائق مُسجل
      const o = S.orders.find(x=>x.id===orderId);
      if(!o) return;
      o.driverId = d? d.id : null;
      o.status = 'in_progress';
      persist();
      updateUI();
      alert('تم قبول الطلب والبدء في تنفيذه');
    }

    function updateUI(){
      // Shipper orders list
      const list = byId('ordersList');
      if(list){
        if(!S.orders.length){list.textContent = 'لا توجد طلبات بعد.'}
        else{
          list.innerHTML = S.orders.map(o=>`<div class=\"card\" style=\"margin:8px 0\"><b>من:</b> ${esc(o.pickup)} — <b>إلى:</b> ${esc(o.dropoff)}<br><span class=\"muted\">${new Date(o.id).toLocaleString('ar-SA')}</span><br><b>التقدير:</b> ${o.price} ريال <span class=\"badge\" style=\"border-color:#2b3240\">${mapStatus(o.status)}</span></div>`).join('');
        }
      }
      // Admin stats
      byId('stUsers').textContent = Math.max(1, Math.ceil(S.orders.length/2));
      byId('stOrders').textContent = S.orders.slice(0,10).length;
      byId('stDrivers').textContent = S.drivers.filter(d=>d.available).length;
      byId('stVehicles').textContent = S.owners.length;
      // Admin orders table
      const adminOrders = byId('adminOrders');
      if(adminOrders){
        if(!S.orders.length) adminOrders.textContent = 'لا توجد بيانات.'; else{
          adminOrders.innerHTML = '';
          S.orders.forEach(o=>{
            const row = document.getElementById('orderRowTmpl').content.cloneNode(true);
            const root = row.querySelector('.card');
            root.dataset.id = o.id;
            row.querySelector('.from').textContent = o.pickup;
            row.querySelector('.to').textContent = o.dropoff;
            row.querySelector('.time').textContent = new Date(o.id).toLocaleString('ar-SA');
            const stEl = row.querySelector('.status');
            stEl.textContent = mapStatus(o.status);
            if(o.status==='completed'||o.status==='cancelled'){ row.querySelector('[data-action=\"complete\"]').disabled = true; }
            row.querySelector('[data-action=\"complete\"]').addEventListener('click',()=>{ o.status='completed'; persist(); updateUI();});
            row.querySelector('[data-action=\"cancel\"]').addEventListener('click',()=>{ o.status='cancelled'; persist(); updateUI();});
            adminOrders.appendChild(row);
          });
        }
      }
      // Nearby for driver (show last 5 orders that are new)
      const near = byId('nearbyList');
      if(near){
        const avail = S.orders.filter(o=>o.status==='new').slice(0,5);
        if(!avail.length) near.innerHTML = '<li class="muted">لا توجد طلبات قريبة الآن.</li>'; else{
          near.innerHTML = avail.map(o=>`<li class=\"card\" style=\"margin:6px 0;padding:10px\"><b>${esc(o.pickup)}</b> → <b>${esc(o.dropoff)}</b><br><span class=\"muted\">~${o.price} ر.س</span><div class=\"actions\"><button class=\"btn\" onclick=\"driverAccept(${o.id})\">قبول</button></div></li>`).join('');
        }
      }
      // Owners table
      const ownersHost = byId('ownersTable');
      if(ownersHost){
        if(!S.owners.length) ownersHost.textContent = 'لا يوجد مُلاك بعد.'; else{
          ownersHost.innerHTML = S.owners.map(o=>`<div class=\"card\" style=\"margin:6px 0\"><b>${esc(o.driverName)}</b> — ${esc(o.vehType)} | ${esc(o.region)} <span class=\"muted\">${esc(o.plate)}</span></div>`).join('');
        }
      }
    }

    function val(id){return document.getElementById(id)?.value?.trim()||''}
    function byId(id){return document.getElementById(id)}
    function esc(s){return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}
    function mapStatus(s){ return s==='new'?'جديد': s==='assigned'?'مُسند': s==='in_progress'?'قيد التنفيذ': s==='completed'?'مكتمل': s==='cancelled'?'ملغي':'غير معروف'; }
    function persist(){ localStorage.setItem('orders', JSON.stringify(S.orders)); localStorage.setItem('owners', JSON.stringify(S.owners)); localStorage.setItem('drivers', JSON.stringify(S.drivers)); localStorage.setItem('pricing', JSON.stringify(S.pricing)); }

    // ---- Minimal front-end test cases ----
    function runTests(){
      const results = [];
      const assert = (name, cond) => results.push({اختبار:name, النتيجة: cond? 'PASS':'FAIL'});
      try{
        assert('تعريف openView', typeof window.openView === 'function');
        const ids = ['landing','shipper','owner','driver','admin','ownersList'];
        ids.forEach(id=>{ window.openView(id); const sec = document.getElementById(id); assert(`إظهار القسم ${id}`, sec && sec.hidden===false); });
        // Hash routing
        location.hash = '#owner'; window.dispatchEvent(new HashChangeEvent('hashchange')); assert('المسار بالهاش يعمل', !document.getElementById('owner').hidden);
        // تبويب الشاحن
        window.openView('shipper');
        const newTab = document.querySelector('#shipper .tabs .tab[data-target="shipper-orders"]');
        if(newTab){ newTab.click(); }
        assert('التبديل إلى تبويب "طلباتي"', document.getElementById('shipper-orders').hidden===false);
        // سيناريو: إنشاء طلب وقبوله ثم إكماله
        const preCount = S.orders.length;
        S.orders.unshift({id: Date.now()+1, pickup:'اختبار أ', dropoff:'اختبار ب', size:'small', price:50, status:'new', driverId:null});
        persist();
        assert('إضافة طلب اختباري', S.orders.length===preCount+1);
        const newId = S.orders[0].id; driverAccept(newId); assert('قبول السائق للطلب', S.orders[0].status==='in_progress');
        S.orders[0].status='completed'; persist(); assert('إكمال الطلب', S.orders[0].status==='completed');
        updateUI();
      }catch(e){ console.error('Test error:', e); }
      const host = document.getElementById('testResults');
      if(host){ host.innerHTML = '<div class="badge">نتائج</div>' + '<pre style="white-space:pre-wrap">'+results.map(r=>`${r.اختبار}: ${r.النتيجة}`).join('\n')+'</pre>'; }
      console.table(results);
      window.openView('landing');
    }

    // --- Auto-detect logo from hasseef.github.io/wasila common paths ---
    function autoDetectLogo(){
      const candidates = [
        'https://hasseef.github.io/wasila/logo.svg',
        'https://hasseef.github.io/wasila/assets/logo.svg',
        'https://hasseef.github.io/wasila/logo.png',
        'https://hasseef.github.io/wasila/assets/logo.png',
        'https://hasseef.github.io/wasila/img/logo.svg',
        'https://hasseef.github.io/wasila/img/logo.png'
      ];
      const imgEl = document.getElementById('appLogo');
      (function tryNext(i){
        if(i>=candidates.length){ imgEl.classList.add('hidden'); return; }
        const url = candidates[i];
        const probe = new Image();
        probe.onload = ()=>{ imgEl.src = url; imgEl.classList.remove('hidden'); };
        probe.onerror = ()=> tryNext(i+1);
        probe.src = url;
      })(0);
    }
  </script>
</body>
</html>
